{"remainingRequest":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/node_modules/ts-loader/index.js??ref--6-1!/Users/andrewsamboy/Desktop/Git/polymail/webapp/src/epics/threads.ts","dependencies":[{"path":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/src/epics/threads.ts","mtime":1675280254059},{"path":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/node_modules/cache-loader/dist/cjs.js","mtime":1675365393858},{"path":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/node_modules/ts-loader/index.js","mtime":1675365391714}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:dmFyIF9fYXNzaWduID0gKHRoaXMgJiYgdGhpcy5fX2Fzc2lnbikgfHwgZnVuY3Rpb24gKCkgewogICAgX19hc3NpZ24gPSBPYmplY3QuYXNzaWduIHx8IGZ1bmN0aW9uKHQpIHsKICAgICAgICBmb3IgKHZhciBzLCBpID0gMSwgbiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgICAgICAgcyA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgICAgZm9yICh2YXIgcCBpbiBzKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHMsIHApKQogICAgICAgICAgICAgICAgdFtwXSA9IHNbcF07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0OwogICAgfTsKICAgIHJldHVybiBfX2Fzc2lnbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwppbXBvcnQgeyBvcmRlckJ5LCBsYXN0LCB1bmlxQnksIGZsYXR0ZW4gfSBmcm9tICdsb2Rhc2gnOwppbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7CmltcG9ydCB7IHN1Ym1pdENvbW1pdCwgY3JlYXRlVGhyZWFkQ29tbWl0IH0gZnJvbSAnQHNyYy9saWIvY29tbWl0JzsKaW1wb3J0IENhY2hlLCB7IFN0b3JlcyB9IGZyb20gJ0BzcmMvbGliL2RiJzsKaW1wb3J0IHsgZ2V0UXVlcnlWYXJpYWJsZSB9IGZyb20gJ0BzcmMvbGliL3F1ZXJ5JzsKaW1wb3J0IHsgYWN0aXZpdHlTZWxlY3QgfSBmcm9tICdAc3JjL2R1Y2tzL2FjdGl2aXR5RmVlZCc7CmltcG9ydCB7IHBhdGNoZWQsIG1hdGNoZXNUaHJlYWQsIGNvbXB1dGVUaHJlYWQsIG1haWxib3hUaHJlYWRzUHJlZGljYXRlLCBsaXN0VGhyZWFkc0J5Qm94LCBsaXN0VGhyZWFkc0J5QWNjb3VudEJveCwgbGlzdFRocmVhZHNCeUxpc3QsIGxpc3RUaHJlYWRzQnlBY2NvdW50TGlzdCwgbGlzdFRocmVhZHNTZW50LCBsaXN0VGhyZWFkc0FjY291bnRTZW50LCBsaXN0VGhyZWFkc0J5RW1haWwsIGxpc3RUaHJlYWRzU3RhcnJlZCwgbGlzdFRocmVhZHNGb2xsb3dVcCwgVEhSRUFEX0xJU1RfU0laRSwgbGlzdFRocmVhZHNBY2NvdW50U3RhcnJlZCwgfSBmcm9tICdAc3JjL2xpYi90aHJlYWQnOwppbXBvcnQgeyBwYXJzZVF1ZXJ5UGFyYW1zLCBsb2NhbFRocmVhZFNlYXJjaCwgcHJvdmlkZXJUaHJlYWRTZWFyY2gsIH0gZnJvbSAnQHNyYy9saWIvc2VhcmNoJzsKaW1wb3J0IHsgQWN0aW9uU3RhdHVzLCBUaHJlYWRCb3gsIE1haWxib3hUeXBlLCBBY2NvdW50VHlwZSwgfSBmcm9tICdAc3JjL3R5cGVzL2luZGV4JzsKaW1wb3J0IHsgUmlnaHRTaWRlYmFyVGFiLCBSaWdodFNpZGViYXJTdWJUYWIsIH0gZnJvbSAnQHNyYy90eXBlcy9yaWdodFNpZGViYXInOwppbXBvcnQgeyBMT0NBVElPTl9DSEFOR0UgfSBmcm9tICdyZWFjdC1yb3V0ZXItcmVkdXgnOwppbXBvcnQgeyB0aHJlYWRTZWxlY3QsIFRIUkVBRF9TRUxFQ1QsIFRIUkVBRF9MSVNULCB0aHJlYWRMaXN0LCBUSFJFQURfVVBEQVRFLCB0aHJlYWRVcGRhdGUsIFRIUkVBRFNfU0VMRUNURURfQ09OVEFDVCwgdGhyZWFkc1NlbGVjdGVkQ29udGFjdCwgVEhSRUFEU19TRUFSQ0gsIHRocmVhZHNTZWFyY2gsIFRIUkVBRF9GRVRDSCwgdGhyZWFkRmV0Y2gsIFRIUkVBRF9DT01NSVRTX1NVQk1JVCwgdGhyZWFkQ29tbWl0c1N1Ym1pdCwgY29udGFjdFRocmVhZFNlbGVjdCwgQ09OVEFDVF9USFJFQURfU0VMRUNULCBUSFJFQURfU0lOR0xFLCB0aHJlYWREZWxldGUsIHRocmVhZFN3aXBlSWRTZXQsIGF0dGFjaG1lbnREb3dubG9hZFByb2dyZXNzQ2xlYXIsIHNlbGVjdFRocmVhZCBhcyBzZWxlY3RUaHJlYWRTZWxlY3RvciwgdGhyZWFkU2luZ2xlLCBzZWxlY3RBY3Rpdml0eVRocmVhZCwgVEhSRUFEX0RJU0FCTEVfVFJBQ0ssIHRocmVhZERpc2FibGVUcmFjaywgfSBmcm9tICdAc3JjL2R1Y2tzL3RocmVhZHMnOwppbXBvcnQgeyBtZXNzYWdlQm9kaWVzRmV0Y2gsIHNoYXJlZFRocmVhZE1lc3NhZ2VCb2RpZXNGZXRjaCB9IGZyb20gJ0BzcmMvZHVja3MvbWVzc2FnZUJvZGllcyc7CmltcG9ydCB7IERSQUZUX1NFTkQsIHNlbGVjdE9wdGltaXN0aWNNZXNzYWdlc0ZvclRocmVhZCwgZHJhZnRTZWxlY3QsIHNlbGVjdFNlbmRpbmdEcmFmdHMsIH0gZnJvbSAnQHNyYy9kdWNrcy9kcmFmdHMnOwppbXBvcnQgeyBjb250YWN0U2VsZWN0IH0gZnJvbSAnQHNyYy9kdWNrcy9jb250YWN0cyc7CmltcG9ydCB7IG1haWxib3hTZWxlY3QsIE1BSUxCT1hfU0VMRUNUIH0gZnJvbSAnQHNyYy9kdWNrcy9tYWlsYm94JzsKaW1wb3J0IHsgcmVjb3JkRXZlbnQsIFVzZXJFdmVudHMgfSBmcm9tICdAc3JjL2xpYi9hbmFseXRpY3MnOwppbXBvcnQgeyB0b1RocmVhZCB9IGZyb20gJ0BzcmMvbGliL2RyYWZ0JzsKaW1wb3J0IHsgY2FsZW5kYXJFdmVudEdldCB9IGZyb20gJ0BzcmMvZHVja3MvY2FsZW5kYXJzJzsKaW1wb3J0IHsgc2hhcmVkVGhyZWFkU2VsZWN0QnlUaHJlYWQsIHNlbGVjdFNoYXJlZFRocmVhZCwgc2hhcmVkVGhyZWFkQWN0aXZpdHlDbGVhciwgfSBmcm9tICdAc3JjL2R1Y2tzL3NoYXJlZFRocmVhZHMnOwppbXBvcnQgeyBkcmFmdFNlbmRBbmRBcmNoaXZlRXBpYyB9IGZyb20gJ0BzcmMvZXBpY3MvZHJhZnRzJzsKaW1wb3J0IHsgbmV3TG9jYWxUaHJlYWRTZWFyY2ggfSBmcm9tICdAc3JjL2xpYi9zZWFyY2hEYic7CmltcG9ydCB7IGdldFNlYXJjaERiQ29uZmlnIH0gZnJvbSAnQHNyYy9saWIvZGV2aWNlJzsKaW1wb3J0IHsgaXNEcmFmdEJveCB9IGZyb20gJ0BzcmMvbGliL21haWxib3gnOwppbXBvcnQgeyBjYXB0dXJlRXhjZXB0aW9uIH0gZnJvbSAnQHNlbnRyeS9icm93c2VyJzsKaW1wb3J0IHsgQ29uZmlybWF0aW9uRXJyb3IsIENvbmZpcm1hdGlvblBvc2l0b24sIHRvYXN0U2V0IH0gZnJvbSAnQHNyYy9kdWNrcy90b2FzdHMnOwpleHBvcnQgdmFyIGlzTWFpbGJveFVwZGF0ZUFjdGlvbiA9IGZ1bmN0aW9uIChhY3Rpb24pIHsKICAgIHZhciB0eXBlcyA9IFtUSFJFQURfTElTVCwgTE9DQVRJT05fQ0hBTkdFLCBUSFJFQURTX1NFQVJDSF07CiAgICByZXR1cm4gISF0eXBlcy5maWx0ZXIoZnVuY3Rpb24gKHR5cGUpIHsgcmV0dXJuIGFjdGlvbi50eXBlID09PSB0eXBlOyB9KS5sZW5ndGg7Cn07Ci8vIE9ic2VydmFibGUgdGhhdCByZXR1cm5zIHRocmVhZExpc3QgYWN0aW9uIGZvciBhIGdpdmVuIE1haWxib3gKZnVuY3Rpb24gbWFpbGJveExpc3QobWFpbGJveCwgc3RvcmUpIHsKICAgIC8vIERvbid0IG5lZWQgdG8gZmV0Y2ggdGhyZWFkcyBmcm9tIGluZGV4ZWQgZGIgaWYgdmlld2luZyBkcmFmdHMKICAgIGlmIChpc0RyYWZ0Qm94KG1haWxib3gudHlwZSkpIHsKICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jb25jYXQoT2JzZXJ2YWJsZS5vZihtYWlsYm94U2VsZWN0KG1haWxib3gsIG1haWxib3gpKSwgT2JzZXJ2YWJsZS5vZih0aHJlYWRMaXN0KGZhbHNlLCBbXSkpKTsKICAgIH0KICAgIC8vIERvIG5vdCB1cGRhdGUgbWFpbGJveCB0aHJlYWRzIHdoZW4gaW4gcXVlcnkgbW9kZQogICAgdmFyIG1haWxib3hUaHJlYWRzID0gc3RvcmUuZ2V0U3RhdGUoKS5tYWlsYm94VGhyZWFkcy5kYXRhOwogICAgaWYgKG1haWxib3gucXVlcnkgJiYgbWFpbGJveC5xdWVyeSAhPT0gJycgJiYgbWFpbGJveFRocmVhZHMpIHsKICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jb25jYXQoT2JzZXJ2YWJsZS5vZihtYWlsYm94U2VsZWN0KG1haWxib3gsIG1haWxib3gpKSwgT2JzZXJ2YWJsZS5vZih0aHJlYWRMaXN0KGZhbHNlLCBtYWlsYm94VGhyZWFkcykpKTsKICAgIH0KICAgIC8vIFByZWRpY2F0ZSBGaWx0ZXJzLCBuZWVkIHRvIHJ1biB1bnJlYWQgZmlsdGVyaW5nIGF0IGRiIGxldmVsCiAgICB2YXIgcHJlZGljYXRlRmlsdGVyID0gZnVuY3Rpb24gKHRocmVhZCkgeyByZXR1cm4gbWFpbGJveFRocmVhZHNQcmVkaWNhdGUobWFpbGJveCwgdGhyZWFkKTsgfTsKICAgIC8vIEhhbmRsZSBNYWlsYm94Qm94IGFuZCBMaXN0IGZpbHRlcnMKICAgIHZhciBsaXN0VGhyZWFkczsKICAgIGlmIChtYWlsYm94LnR5cGUgPT09IE1haWxib3hUeXBlLkluYm94KSB7CiAgICAgICAgbGlzdFRocmVhZHMgPSBtYWlsYm94LmFjY291bnQgPwogICAgICAgICAgICBsaXN0VGhyZWFkc0J5QWNjb3VudEJveChtYWlsYm94LmFjY291bnQsIFRocmVhZEJveC5JbmJveCwgdW5kZWZpbmVkLCBwcmVkaWNhdGVGaWx0ZXIpIDoKICAgICAgICAgICAgbGlzdFRocmVhZHNCeUJveChUaHJlYWRCb3guSW5ib3gsIHVuZGVmaW5lZCwgcHJlZGljYXRlRmlsdGVyKTsKICAgIH0KICAgIGVsc2UgaWYgKG1haWxib3gudHlwZSA9PT0gTWFpbGJveFR5cGUuQXJjaGl2ZSkgewogICAgICAgIGxpc3RUaHJlYWRzID0gbWFpbGJveC5hY2NvdW50ID8KICAgICAgICAgICAgbGlzdFRocmVhZHNCeUFjY291bnRCb3gobWFpbGJveC5hY2NvdW50LCBUaHJlYWRCb3guQXJjaGl2ZSwgdW5kZWZpbmVkLCBwcmVkaWNhdGVGaWx0ZXIpIDoKICAgICAgICAgICAgbGlzdFRocmVhZHNCeUJveChUaHJlYWRCb3guQXJjaGl2ZSwgdW5kZWZpbmVkLCBwcmVkaWNhdGVGaWx0ZXIpOwogICAgfQogICAgZWxzZSBpZiAobWFpbGJveC50eXBlID09PSBNYWlsYm94VHlwZS5MYXRlcikgewogICAgICAgIGxpc3RUaHJlYWRzID0gbWFpbGJveC5hY2NvdW50ID8KICAgICAgICAgICAgbGlzdFRocmVhZHNCeUFjY291bnRCb3gobWFpbGJveC5hY2NvdW50LCBUaHJlYWRCb3guTGF0ZXIsIHVuZGVmaW5lZCwgcHJlZGljYXRlRmlsdGVyKSA6CiAgICAgICAgICAgIGxpc3RUaHJlYWRzQnlCb3goVGhyZWFkQm94LkxhdGVyLCB1bmRlZmluZWQsIHByZWRpY2F0ZUZpbHRlcik7CiAgICB9CiAgICBlbHNlIGlmIChtYWlsYm94LnR5cGUgPT09IE1haWxib3hUeXBlLlNwYW0pIHsKICAgICAgICBsaXN0VGhyZWFkcyA9IG1haWxib3guYWNjb3VudCA/CiAgICAgICAgICAgIGxpc3RUaHJlYWRzQnlBY2NvdW50Qm94KG1haWxib3guYWNjb3VudCwgVGhyZWFkQm94LlNwYW0sIHVuZGVmaW5lZCwgcHJlZGljYXRlRmlsdGVyKSA6CiAgICAgICAgICAgIGxpc3RUaHJlYWRzQnlCb3goVGhyZWFkQm94LlNwYW0sIHVuZGVmaW5lZCwgcHJlZGljYXRlRmlsdGVyKTsKICAgIH0KICAgIGVsc2UgaWYgKG1haWxib3gudHlwZSA9PT0gTWFpbGJveFR5cGUuVHJhc2gpIHsKICAgICAgICBsaXN0VGhyZWFkcyA9IG1haWxib3guYWNjb3VudCA/CiAgICAgICAgICAgIGxpc3RUaHJlYWRzQnlBY2NvdW50Qm94KG1haWxib3guYWNjb3VudCwgVGhyZWFkQm94LlRyYXNoLCB1bmRlZmluZWQsIHByZWRpY2F0ZUZpbHRlcikgOgogICAgICAgICAgICBsaXN0VGhyZWFkc0J5Qm94KFRocmVhZEJveC5UcmFzaCwgdW5kZWZpbmVkLCBwcmVkaWNhdGVGaWx0ZXIpOwogICAgfQogICAgZWxzZSBpZiAobWFpbGJveC5saXN0KSB7CiAgICAgICAgbGlzdFRocmVhZHMgPSBtYWlsYm94LmFjY291bnQgPwogICAgICAgICAgICBsaXN0VGhyZWFkc0J5QWNjb3VudExpc3QobWFpbGJveC5hY2NvdW50LCBtYWlsYm94Lmxpc3QsIHVuZGVmaW5lZCwgcHJlZGljYXRlRmlsdGVyKSA6CiAgICAgICAgICAgIGxpc3RUaHJlYWRzQnlMaXN0KG1haWxib3gubGlzdCwgdW5kZWZpbmVkLCBwcmVkaWNhdGVGaWx0ZXIpOwogICAgfQogICAgZWxzZSBpZiAobWFpbGJveC5zZW50KSB7CiAgICAgICAgbGlzdFRocmVhZHMgPSBtYWlsYm94LmFjY291bnQgPwogICAgICAgICAgICBsaXN0VGhyZWFkc0FjY291bnRTZW50KG1haWxib3guYWNjb3VudCwgdW5kZWZpbmVkLCBwcmVkaWNhdGVGaWx0ZXIpIDoKICAgICAgICAgICAgbGlzdFRocmVhZHNTZW50KHVuZGVmaW5lZCwgcHJlZGljYXRlRmlsdGVyKTsKICAgIH0KICAgIGVsc2UgaWYgKG1haWxib3guc3RhcnJlZCkgewogICAgICAgIGxpc3RUaHJlYWRzID0gbWFpbGJveC5hY2NvdW50ID8KICAgICAgICAgICAgbGlzdFRocmVhZHNBY2NvdW50U3RhcnJlZChtYWlsYm94LmFjY291bnQsIHByZWRpY2F0ZUZpbHRlcikgOgogICAgICAgICAgICBsaXN0VGhyZWFkc1N0YXJyZWQocHJlZGljYXRlRmlsdGVyKTsKICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmUKICAgIH0KICAgIGVsc2UgaWYgKG1haWxib3guZm9sbG93VXApIHsKICAgICAgICBsaXN0VGhyZWFkcyA9IGxpc3RUaHJlYWRzRm9sbG93VXAocHJlZGljYXRlRmlsdGVyKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIC8vIFNsb3cgZnVsbCBpbmRleCBzY2FuLiBBdm9pZCBpZiBwb3NzaWJsZS4KICAgICAgICBsaXN0VGhyZWFkcyA9IENhY2hlLmxpc3QoU3RvcmVzLlRocmVhZHMsIHByZWRpY2F0ZUZpbHRlcik7CiAgICB9CiAgICAvLyBQZXJmb3JtIGxpc3Qgb3BlcmF0aW9uIG9uIGRiCiAgICByZXR1cm4gbGlzdFRocmVhZHMKICAgICAgICAubWFwKGZ1bmN0aW9uICh0aHJlYWRzKSB7CiAgICAgICAgLy8gRmlsdGVyCiAgICAgICAgLy8gQWRkIG9wdGltaXN0aWNzCiAgICAgICAgdmFyIHNlbmRpbmdEcmFmdHMgPSBzZWxlY3RTZW5kaW5nRHJhZnRzKHN0b3JlLmdldFN0YXRlKCkpCiAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGRyYWZ0KSB7IHJldHVybiAhZHJhZnQudGhyZWFkVjI7IH0pOwogICAgICAgIHNlbmRpbmdEcmFmdHMKICAgICAgICAgICAgLmZvckVhY2goZnVuY3Rpb24gKGRyYWZ0KSB7CiAgICAgICAgICAgIHZhciB0aHJlYWQgPSB0b1RocmVhZChkcmFmdCwgc3RvcmUuZ2V0U3RhdGUoKS5hY2NvdW50cyk7CiAgICAgICAgICAgIGlmIChtYWlsYm94VGhyZWFkc1ByZWRpY2F0ZShtYWlsYm94LCB0aHJlYWQpKSB7CiAgICAgICAgICAgICAgICB0aHJlYWRzLnB1c2godGhyZWFkKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIC8vIFBhdGNoIGluIG9wdGltaXN0aWMgbWVzc2FnZXMKICAgICAgICB2YXIgb3B0aW1pc3RpY1RocmVhZHMgPSB0aHJlYWRzLm1hcChmdW5jdGlvbiAodGhyZWFkKSB7CiAgICAgICAgICAgIHZhciBtZXNzYWdlcyA9IHVuaXFCeSh0aHJlYWQubWVzc2FnZXMuY29uY2F0KHNlbGVjdE9wdGltaXN0aWNNZXNzYWdlc0ZvclRocmVhZChzdG9yZS5nZXRTdGF0ZSgpLCB0aHJlYWQuaWQpKSwgJ3JmY0lkJyk7CiAgICAgICAgICAgIHJldHVybiBfX2Fzc2lnbihfX2Fzc2lnbih7fSwgdGhyZWFkKSwgeyBtZXNzYWdlczogbWVzc2FnZXMgfSk7CiAgICAgICAgfSk7CiAgICAgICAgLy8gSGFuZGxlIFNlbnQgZm9sZGVyIHNvcnQKICAgICAgICBpZiAobWFpbGJveC5zZW50KSB7CiAgICAgICAgICAgIHJldHVybiBvcmRlckJ5KG9wdGltaXN0aWNUaHJlYWRzLm1hcChmdW5jdGlvbiAodGhyZWFkKSB7IHJldHVybiBjb21wdXRlVGhyZWFkKHRocmVhZCk7IH0pLCBmdW5jdGlvbiAodCkgeyByZXR1cm4gdC5sYXN0U2VudDsgfSwgJ2Rlc2MnKTsKICAgICAgICB9CiAgICAgICAgLy8gU29ydAogICAgICAgIHN3aXRjaCAobWFpbGJveC50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgTWFpbGJveFR5cGUuSW5ib3g6CiAgICAgICAgICAgICAgICByZXR1cm4gb3JkZXJCeShvcHRpbWlzdGljVGhyZWFkcy5tYXAoZnVuY3Rpb24gKHRocmVhZCkgeyByZXR1cm4gY29tcHV0ZVRocmVhZCh0aHJlYWQpOyB9KSwgZnVuY3Rpb24gKHQpIHsgcmV0dXJuIHQuc29ydDsgfSwgJ2Rlc2MnKTsKICAgICAgICAgICAgY2FzZSBNYWlsYm94VHlwZS5MYXRlcjoKICAgICAgICAgICAgICAgIHJldHVybiBvcmRlckJ5KG9wdGltaXN0aWNUaHJlYWRzLm1hcChmdW5jdGlvbiAodGhyZWFkKSB7IHJldHVybiBjb21wdXRlVGhyZWFkKHRocmVhZCk7IH0pLCBmdW5jdGlvbiAodCkgeyByZXR1cm4gdC5zb3J0OyB9LCAnYXNjJyk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gb3JkZXJCeShvcHRpbWlzdGljVGhyZWFkcy5tYXAoZnVuY3Rpb24gKHRocmVhZCkgeyByZXR1cm4gY29tcHV0ZVRocmVhZCh0aHJlYWQpOyB9KSwgZnVuY3Rpb24gKHQpIHsgcmV0dXJuIHQuaW50ZXJuYWw7IH0sICdkZXNjJyk7CiAgICAgICAgfQogICAgfSkKICAgICAgICAuZmxhdE1hcChmdW5jdGlvbiAodGhyZWFkcykgeyByZXR1cm4gT2JzZXJ2YWJsZS5jb25jYXQoT2JzZXJ2YWJsZS5vZihtYWlsYm94U2VsZWN0KG1haWxib3gsIG1haWxib3gpKSwgT2JzZXJ2YWJsZS5vZih0aHJlYWRMaXN0KGZhbHNlLCB0aHJlYWRzKSkpOyB9KQogICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZSkgeyByZXR1cm4gT2JzZXJ2YWJsZS5vZih0aHJlYWRMaXN0KGZhbHNlLCBlKSk7IH0pOwp9CnZhciBtYWlsYm94U2VsZWN0RXBpYyA9IGZ1bmN0aW9uIChhY3Rpb24kKSB7CiAgICByZXR1cm4gYWN0aW9uJAogICAgICAgIC5vZlR5cGUoTUFJTEJPWF9TRUxFQ1QpCiAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoYWN0aW9uKSB7IHJldHVybiBhY3Rpb24uc3RhdHVzID09PSBBY3Rpb25TdGF0dXMuU3RhcnQ7IH0pCiAgICAgICAgLm1hcChmdW5jdGlvbiAoYWN0aW9uKSB7IHJldHVybiB0aHJlYWRMaXN0KGZhbHNlKTsgfSk7Cn07Ci8vIGhhbmRsZSBsb2NhdGlvbiBjaGFuZ2UgYmFzZWQgdXBkYXRlcyB0byBzZWxlY3RlZCBtYWlsYm94CnZhciBsb2NhdGlvbkNoYW5nZVVwZGF0ZU1haWxib3ggPSBmdW5jdGlvbiAoYWN0aW9uJCwgc3RvcmUsIGRlcHMpIHsKICAgIHJldHVybiBhY3Rpb24kLm9mVHlwZShMT0NBVElPTl9DSEFOR0UpCiAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoYWN0aW9uKSB7CiAgICAgICAgdmFyIHBhdGggPSBhY3Rpb24ucGF5bG9hZC5wYXRobmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHZhciBzcGxpdCA9IHBhdGguc3BsaXQoJy8nKTsKICAgICAgICBpZiAoc3BsaXRbM10gJiYgc3BsaXRbM10gPT09ICdjb21wb3NlJykgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwYXRoLnN0YXJ0c1dpdGgoJy9tYWlsJykgfHwgcGF0aCA9PT0gJy8nOwogICAgfSkKICAgICAgICAuZGVib3VuY2VUaW1lKDIwMCwgZGVwcy5zY2hlZHVsZXIpCiAgICAgICAgLm1hcChmdW5jdGlvbiAoYWN0aW9uKSB7CiAgICAgICAgLy8gQ29udmVydCB0aGUgcm91dGUgaW50byBhIE1haWxib3ggbW9kZWwKICAgICAgICB2YXIgbWFpbGJveCA9IHsKICAgICAgICAgICAgdHlwZTogTWFpbGJveFR5cGUuQW55LAogICAgICAgIH07CiAgICAgICAgdmFyIHJvdXRlQWN0aW9uID0gYWN0aW9uOwogICAgICAgIGlmIChyb3V0ZUFjdGlvbi5wYXlsb2FkLnBhdGhuYW1lID09PSAnLycpIHsKICAgICAgICAgICAgbWFpbGJveC50eXBlID0gTWFpbGJveFR5cGUuSW5ib3g7CiAgICAgICAgfQogICAgICAgIHZhciBwYXRoID0gcm91dGVBY3Rpb24ucGF5bG9hZC5wYXRobmFtZS5zcGxpdCgnLycpOwogICAgICAgIHZhciBzZWxlY3RlZEFjY291bnQgPSAocGF0aFsyXSB8fCAnYWxsJykudG9Mb3dlckNhc2UoKTsKICAgICAgICB2YXIgYWNjb3VudCA9IChwYXRoWzRdIHx8ICcnKS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHZhciBib3ggPSAocGF0aFszXSB8fCAnaW5ib3gnKS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmIChzZWxlY3RlZEFjY291bnQgIT09ICdhbGwnIHx8IGFjY291bnQuc3RhcnRzV2l0aCgnYWNjb3VudC0nKSkgewogICAgICAgICAgICBtYWlsYm94LmFjY291bnQgPSBzZWxlY3RlZEFjY291bnQgIT09ICdhbGwnID8gc2VsZWN0ZWRBY2NvdW50CiAgICAgICAgICAgICAgICA6IGFjY291bnQuc2xpY2UoYWNjb3VudC5pbmRleE9mKCctJykgKyAxKTsKICAgICAgICB9CiAgICAgICAgLy8gU2V0IHF1ZXJ5IHBhcmFtZXRlciBhY2NvcmRpbmcgdG8gZmlsdGVyCiAgICAgICAgdmFyIHVucmVhZFF1ZXJ5ID0gZ2V0UXVlcnlWYXJpYWJsZSgndW5yZWFkJywgcm91dGVBY3Rpb24ucGF5bG9hZC5zZWFyY2gpOwogICAgICAgIGlmICh1bnJlYWRRdWVyeSkgewogICAgICAgICAgICBtYWlsYm94LnJlYWQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgc3dpdGNoIChib3gpIHsKICAgICAgICAgICAgY2FzZSAnaW5ib3gnOgogICAgICAgICAgICAgICAgbWFpbGJveC50eXBlID0gTWFpbGJveFR5cGUuSW5ib3g7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnYXJjaGl2ZSc6CiAgICAgICAgICAgICAgICBtYWlsYm94LnR5cGUgPSBNYWlsYm94VHlwZS5BcmNoaXZlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2xhdGVyJzoKICAgICAgICAgICAgICAgIG1haWxib3gudHlwZSA9IE1haWxib3hUeXBlLkxhdGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3NwYW0nOgogICAgICAgICAgICAgICAgbWFpbGJveC50eXBlID0gTWFpbGJveFR5cGUuU3BhbTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICd0cmFzaCc6CiAgICAgICAgICAgICAgICBtYWlsYm94LnR5cGUgPSBNYWlsYm94VHlwZS5UcmFzaDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdzdGFycmVkJzoKICAgICAgICAgICAgICAgIG1haWxib3guc3RhcnJlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnbGlzdHMnOgogICAgICAgICAgICAgICAgbWFpbGJveC5saXN0ID0gcGF0aFs0XSB8fCAnJzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdzZW5kbGF0ZXInOgogICAgICAgICAgICAgICAgbWFpbGJveC50eXBlID0gTWFpbGJveFR5cGUuU2VuZExhdGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3NlbnQnOgogICAgICAgICAgICAgICAgbWFpbGJveC5zZW50ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdmb2xsb3d1cCc6CiAgICAgICAgICAgICAgICBtYWlsYm94LmZvbGxvd1VwID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdvdXRib3gnOgogICAgICAgICAgICAgICAgbWFpbGJveC50eXBlID0gTWFpbGJveFR5cGUuT3V0Ym94OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2RyYWZ0cyc6CiAgICAgICAgICAgICAgICBtYWlsYm94LnR5cGUgPSBNYWlsYm94VHlwZS5EcmFmdHM7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICB2YXIgbWFpbGJveFByb3BzVG9DaGVjayA9IFsKICAgICAgICAgICAgJ3R5cGUnLAogICAgICAgICAgICAnbGlzdCcsCiAgICAgICAgICAgICdhY2NvdW50JywKICAgICAgICAgICAgJ3N0YXJyZWQnLAogICAgICAgIF07CiAgICAgICAgdmFyIGlzRXF1YWwgPSB0cnVlOwogICAgICAgIG1haWxib3hQcm9wc1RvQ2hlY2suZm9yRWFjaChmdW5jdGlvbiAocCkgewogICAgICAgICAgICBpZiAobWFpbGJveFtwXSAhPT0gc3RvcmUuZ2V0U3RhdGUoKS5tYWlsYm94W3BdKSB7CiAgICAgICAgICAgICAgICBpc0VxdWFsID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgcXVlcnkgPSAKICAgICAgICAvLyBleHBsaWNpdCBxdWVyeSBwYXJhbQogICAgICAgIChyb3V0ZUFjdGlvbi5wYXlsb2FkLnNlYXJjaCAmJiBnZXRRdWVyeVZhcmlhYmxlKCdxdWVyeScsIHJvdXRlQWN0aW9uLnBheWxvYWQuc2VhcmNoKSkgfHwKICAgICAgICAgICAgLy8gcHJlc2VydmUgcXVlcnkgaWYgc2FtZSBtYWlsYm94CiAgICAgICAgICAgIChpc0VxdWFsICYmIHN0b3JlLmdldFN0YXRlKCkubWFpbGJveC5xdWVyeSk7CiAgICAgICAgaWYgKHF1ZXJ5KSB7CiAgICAgICAgICAgIG1haWxib3gucXVlcnkgPSBxdWVyeTsKICAgICAgICAgICAgLy8gcHJlc2VydmUgcXVlcnkgcGFyYW1zIGlmIGl0J3MgdGhlIHNhbWUgcXVlcnkKICAgICAgICAgICAgbWFpbGJveC5xdWVyeVBhcmFtcyA9IHN0b3JlLmdldFN0YXRlKCkubWFpbGJveC5xdWVyeSA9PT0gcXVlcnkgPwogICAgICAgICAgICAgICAgbWFpbGJveC5xdWVyeVBhcmFtcyA9IHN0b3JlLmdldFN0YXRlKCkubWFpbGJveC5xdWVyeVBhcmFtcyA6CiAgICAgICAgICAgICAgICBtYWlsYm94LnF1ZXJ5UGFyYW1zID0gcGFyc2VRdWVyeVBhcmFtcyhxdWVyeSwgc3RvcmUuZ2V0U3RhdGUoKS5saXN0cyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtYWlsYm94OwogICAgfSkKICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChtYWlsYm94KSB7CiAgICAgICAgdmFyIG1haWxib3hQcm9wc1RvQ2hlY2sgPSBbCiAgICAgICAgICAgICd0eXBlJywKICAgICAgICAgICAgJ3F1ZXJ5JywKICAgICAgICAgICAgJ3F1ZXJ5UGFyYW1zJywKICAgICAgICAgICAgJ2xpc3QnLAogICAgICAgICAgICAnYWNjb3VudCcsCiAgICAgICAgICAgICdzdGFycmVkJywKICAgICAgICAgICAgJ3NlbnQnLAogICAgICAgICAgICAnZm9sbG93VXAnLAogICAgICAgIF07CiAgICAgICAgLy8gSWYgTWFpbGJveCBkaWRuJ3QgY2hhbmdlLCBkb24ndCB3YW50IHRvIHJlZmV0Y2gKICAgICAgICB2YXIgY3VycmVudE1haWxib3ggPSBzdG9yZS5nZXRTdGF0ZSgpLm1haWxib3g7CiAgICAgICAgdmFyIGlzRXF1YWwgPSB0cnVlOwogICAgICAgIG1haWxib3hQcm9wc1RvQ2hlY2suZm9yRWFjaChmdW5jdGlvbiAocCkgewogICAgICAgICAgICBpZiAobWFpbGJveFtwXSAhPT0gY3VycmVudE1haWxib3hbcF0pIHsKICAgICAgICAgICAgICAgIGlzRXF1YWwgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiAhaXNFcXVhbDsKICAgIH0pCiAgICAgICAgLmZsYXRNYXAoZnVuY3Rpb24gKG1haWxib3gpIHsKICAgICAgICAvLyBIYW5kbGUgc2VhcmNoIG1vZGUKICAgICAgICBpZiAobWFpbGJveC5xdWVyeSAmJiBtYWlsYm94LnF1ZXJ5ICE9PSAnJykgewogICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jb25jYXQoCiAgICAgICAgICAgIC8vIEFsd2F5cyB1cGRhdGUgbWFsaWJveCBvbiBsb2NhdGlvbiBjaGFuZ2UuCiAgICAgICAgICAgIE9ic2VydmFibGUub2YobWFpbGJveFNlbGVjdChtYWlsYm94LCBtYWlsYm94KSksIE9ic2VydmFibGUub2YodGhyZWFkc1NlYXJjaCh7IHF1ZXJ5OiBtYWlsYm94LnF1ZXJ5IH0pKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmNvbmNhdCgKICAgICAgICAvLyBBbHdheXMgdXBkYXRlIG1hbGlib3ggb24gbG9jYXRpb24gY2hhbmdlLgogICAgICAgIE9ic2VydmFibGUub2YobWFpbGJveFNlbGVjdChtYWlsYm94LCBtYWlsYm94KSksIE9ic2VydmFibGUub2YodGhyZWFkTGlzdChmYWxzZSkpKTsKICAgIH0pOwp9Owp2YXIgY29udGFjdFRocmVhZHMgPSBmdW5jdGlvbiAoYWN0aW9uJCwgc3RvcmUsIGRlcHMpIHsKICAgIHJldHVybiBhY3Rpb24kLm9mVHlwZShUSFJFQURTX1NFTEVDVEVEX0NPTlRBQ1QpCiAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoYWN0aW9uKSB7IHJldHVybiBhY3Rpb24uc3RhdHVzID09PSBBY3Rpb25TdGF0dXMuU3RhcnQ7IH0pCiAgICAgICAgLmZsYXRNYXAoZnVuY3Rpb24gKGFjdGlvbikgewogICAgICAgIHJldHVybiBsaXN0VGhyZWFkc0J5RW1haWwoYWN0aW9uLm1ldGEsIFRIUkVBRF9MSVNUX1NJWkUpCiAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24gKHRocmVhZHMpIHsgcmV0dXJuIHRocmVhZHNTZWxlY3RlZENvbnRhY3QoYWN0aW9uLm1ldGEsIHRocmVhZHMpOyB9KQogICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGUpIHsgcmV0dXJuIE9ic2VydmFibGUub2YodGhyZWFkc1NlbGVjdGVkQ29udGFjdChhY3Rpb24ubWV0YSwgZSkpCiAgICAgICAgICAgIC50YWtlVW50aWwoYWN0aW9uJAogICAgICAgICAgICAub2ZUeXBlKFRIUkVBRFNfU0VMRUNURURfQ09OVEFDVCkpCiAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGEpIHsgcmV0dXJuIGEuc3RhdHVzID09PSBBY3Rpb25TdGF0dXMuU3RhcnQ7IH0pOyB9KTsKICAgIH0pOwp9OwovLyBoYW5kbGUgcmVmcmVzaGluZyBvZiBsaXN0IG9mIHRocmVhZHMgZnJvbSBjYWNoZSBmb3Igc2VsZWN0ZWQgbWFpbGJveAp2YXIgdXBkYXRlTWFpbGJveFRocmVhZHMgPSBmdW5jdGlvbiAoYWN0aW9uJCwgc3RvcmUsIGRlcHMpIHsKICAgIHJldHVybiBhY3Rpb24kCiAgICAgICAgLm9mVHlwZShUSFJFQURfTElTVCkKICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChhY3Rpb24pIHsgcmV0dXJuIGFjdGlvbi5zdGF0dXMgPT09IEFjdGlvblN0YXR1cy5TdGFydDsgfSkKICAgICAgICAuZGVib3VuY2VUaW1lKDIwMCwgZGVwcy5zY2hlZHVsZXIpCiAgICAgICAgLmZsYXRNYXAoZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBtYWlsYm94TGlzdChzdG9yZS5nZXRTdGF0ZSgpLm1haWxib3gsIHN0b3JlKQogICAgICAgICAgICAudGFrZVVudGlsKGFjdGlvbiQuZmlsdGVyKGlzTWFpbGJveFVwZGF0ZUFjdGlvbikpOwogICAgfSk7Cn07Ci8vIGhhbmRsZSBzZWxlY3RpbmcgdGhlIGNvcnJlY3QgdGhyZWFkIHRvIGRpc3BsYXkKdmFyIGxvY2F0aW9uQ2hhbmdlU2VsZWN0VGhyZWFkID0gZnVuY3Rpb24gKGFjdGlvbiQsIHN0b3JlKSB7CiAgICByZXR1cm4gYWN0aW9uJAogICAgICAgIC5vZlR5cGUoTE9DQVRJT05fQ0hBTkdFKQogICAgICAgIC5tYXAoZnVuY3Rpb24gKGFjdGlvbikgewogICAgICAgIHJldHVybiBhY3Rpb24ucGF5bG9hZC5wYXRobmFtZS50b0xvd2VyQ2FzZSgpLnNwbGl0KCcvJyk7CiAgICB9KQogICAgICAgIC8vIERvIG5vdCBoYW5kbGUgb3V0c2lkZSBib3hlcwogICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKHNwbGl0KSB7IHJldHVybiAoWydkcmFmdHMnLCAnc2VuZGxhdGVyJywgJ291dGJveCddLmluZGV4T2Yoc3BsaXRbM10pID09PSAtMSk7IH0pCiAgICAgICAgLm1hcChmdW5jdGlvbiAoc3BsaXQpIHsKICAgICAgICBpZiAoc3BsaXQubGVuZ3RoIDwgNSkgewogICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgfQogICAgICAgIGlmIChzcGxpdFszXSA9PT0gJ2xpc3RzJyAmJiBzcGxpdC5sZW5ndGggPCA2KSB7CiAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICB9CiAgICAgICAgaWYgKHNwbGl0WzFdID09PSAncG9wb3V0JyAmJiBzcGxpdFsyXSA9PT0gJ3RocmVhZHMnKSB7CiAgICAgICAgICAgIHJldHVybiBzcGxpdFszXTsKICAgICAgICB9CiAgICAgICAgaWYgKHNwbGl0WzFdID09PSAnbWVudGlvbnMnIHx8IHNwbGl0WzFdID09PSAncHVibGljJykgewogICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzcGxpdFtzcGxpdC5sZW5ndGggLSAxXTsKICAgIH0pCiAgICAgICAgLmZsYXRNYXAoZnVuY3Rpb24gKGlkU3RyaW5nKSB7CiAgICAgICAgLy8gT3ZlcnJpZGUgYWNjb3VudC1pZCBmb3IgYm94IHNlbGVjdGlvbiB0byBzZWxlY3QgZW1wdHkgdGhyZWFkCiAgICAgICAgdmFyIHRocmVhZElkID0gaWRTdHJpbmc7CiAgICAgICAgaWYgKGlkU3RyaW5nLnN0YXJ0c1dpdGgoJ2FjY291bnQnKSkgewogICAgICAgICAgICB0aHJlYWRJZCA9ICcnOwogICAgICAgIH0KICAgICAgICAvLyBUaGlzIGlzIHdoZW4gc2VsZWN0aW5nIG90cGltaXN0aWMgYW5kIGluIG91dGJveAogICAgICAgIHZhciBhY3Rpb25zID0gWwogICAgICAgICAgICBPYnNlcnZhYmxlLm9mKGRyYWZ0U2VsZWN0KCcnLCBudWxsKSksCiAgICAgICAgICAgIE9ic2VydmFibGUub2YodGhyZWFkU2VsZWN0KHRocmVhZElkKSksCiAgICAgICAgXTsKICAgICAgICB2YXIgX2EgPSBzdG9yZS5nZXRTdGF0ZSgpLCBzZWxlY3RlZFNoYXJlZFRocmVhZCA9IF9hLnNlbGVjdGVkU2hhcmVkVGhyZWFkLCBzaGFyZWRUaHJlYWRzID0gX2Euc2hhcmVkVGhyZWFkczsKICAgICAgICB2YXIgc2hhcmVkVGhyZWFkVGhyZWFkSWQgPSBzZWxlY3RlZFNoYXJlZFRocmVhZCAmJiBzaGFyZWRUaHJlYWRzW3NlbGVjdGVkU2hhcmVkVGhyZWFkXSAmJgogICAgICAgICAgICBzaGFyZWRUaHJlYWRzW3NlbGVjdGVkU2hhcmVkVGhyZWFkXS5kYXRhICYmCiAgICAgICAgICAgIHNoYXJlZFRocmVhZHNbc2VsZWN0ZWRTaGFyZWRUaHJlYWRdLmRhdGEudGhyZWFkOwogICAgICAgIGlmICh0aHJlYWRJZCAmJiAodGhyZWFkSWQgIT09IHNoYXJlZFRocmVhZFRocmVhZElkIHx8ICFzaGFyZWRUaHJlYWRUaHJlYWRJZCkpIHsKICAgICAgICAgICAgYWN0aW9ucy5wdXNoKE9ic2VydmFibGUub2Yoc2hhcmVkVGhyZWFkU2VsZWN0QnlUaHJlYWQodGhyZWFkSWQpKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBPYnNlcnZhYmxlLm1lcmdlLmFwcGx5KE9ic2VydmFibGUsIGFjdGlvbnMpOwogICAgfSk7Cn07Ci8vIHRocmVhZCBzZWxlY3QgaGFuZGxpbmcKdmFyIHNlbGVjdFRocmVhZCA9IGZ1bmN0aW9uIChhY3Rpb24kLCBzdG9yZSwgZGVwcykgewogICAgcmV0dXJuIGFjdGlvbiQKICAgICAgICAub2ZUeXBlKFRIUkVBRF9TRUxFQ1QpCiAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoYWN0aW9uKSB7IHJldHVybiBhY3Rpb24uc3RhdHVzID09PSBBY3Rpb25TdGF0dXMuU3RhcnQ7IH0pCiAgICAgICAgLmRlYm91bmNlVGltZSgyMDAsIGRlcHMuc2NoZWR1bGVyKQogICAgICAgIC5mbGF0TWFwKGZ1bmN0aW9uIChhY3Rpb24pIHsKICAgICAgICAvLyB0cmFjayBpZiBmZXRjaGVkIGZyb20gc2VydmVyLCBoYXBwZW5zIHdoZW4gbm90IGZvdW5kIGluIGNhY2hlCiAgICAgICAgdmFyIGhhdmVGcmVzaFRocmVhZCA9IGZhbHNlOwogICAgICAgIHZhciBjbGVhckFjdGlvbnMgPSBPYnNlcnZhYmxlLm1lcmdlKE9ic2VydmFibGUub2YodGhyZWFkU2VsZWN0KCcnLCBudWxsKSksIE9ic2VydmFibGUub2Yoc2hhcmVkVGhyZWFkQWN0aXZpdHlDbGVhcihudWxsKSkpOwogICAgICAgIC8vIEhhbmRsZSBjbGVhcmluZyBpZiBzZWxlY3Rpbmcgbm90aGluZwogICAgICAgIGlmIChhY3Rpb24ubWV0YSA9PT0gJycpIHsKICAgICAgICAgICAgcmV0dXJuIGNsZWFyQWN0aW9uczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2YobnVsbCkKICAgICAgICAgICAgLmZsYXRNYXAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgc3RhdGUgPSBzdG9yZS5nZXRTdGF0ZSgpOwogICAgICAgICAgICB2YXIgZm91bmRUaHJlYWQgPSBzZWxlY3RUaHJlYWRTZWxlY3RvcihzdGF0ZSwgYWN0aW9uLm1ldGEpOwogICAgICAgICAgICB2YXIgc2hhcmVkVGhyZWFkSWQgPSBzdGF0ZS5zZWxlY3RlZFNoYXJlZFRocmVhZDsKICAgICAgICAgICAgdmFyIHNoYXJlZFRocmVhZCA9IHNoYXJlZFRocmVhZElkICYmIHNlbGVjdFNoYXJlZFRocmVhZChzdGF0ZSwgc2hhcmVkVGhyZWFkSWQpOwogICAgICAgICAgICB2YXIgaXNVc2VyVGhyZWFkID0gc2hhcmVkVGhyZWFkICYmIHN0YXRlLm1lICYmIHN0YXRlLm1lLmRhdGEgPwogICAgICAgICAgICAgICAgc3RhdGUubWUuZGF0YS5pZCA9PT0gc2hhcmVkVGhyZWFkLnVzZXIgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgIGlmIChzaGFyZWRUaHJlYWQgJiYgIWlzVXNlclRocmVhZCkgewogICAgICAgICAgICAgICAgZm91bmRUaHJlYWQgPSBzZWxlY3RBY3Rpdml0eVRocmVhZChzdGF0ZSwgYWN0aW9uLm1ldGEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmb3VuZFRocmVhZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2YoZm91bmRUaHJlYWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBDYWNoZS5nZXQoU3RvcmVzLlRocmVhZHMsIGFjdGlvbi5tZXRhKTsKICAgICAgICB9KQogICAgICAgICAgICAuZmxhdE1hcChmdW5jdGlvbiAodGhyZWFkKSB7CiAgICAgICAgICAgIC8vIGZldGNoIGZyb20gc2VydmVyIGlmIG5vdCBmb3VuZAogICAgICAgICAgICBpZiAoIXRocmVhZCAmJiAhIWFjdGlvbi5tZXRhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVwcy50aHJlYWRzLmdldChhY3Rpb24ubWV0YSkKICAgICAgICAgICAgICAgICAgICAuZmxhdE1hcChmdW5jdGlvbiAoZnJlc2hUaHJlYWQpIHsKICAgICAgICAgICAgICAgICAgICBoYXZlRnJlc2hUaHJlYWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBDYWNoZS5zYXZlKFN0b3Jlcy5UaHJlYWRzLCBmcmVzaFRocmVhZCkubWFwKGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZyZXNoVGhyZWFkOyB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uICgpIHsgcmV0dXJuIE9ic2VydmFibGUub2YodW5kZWZpbmVkKTsgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2YodGhyZWFkKTsKICAgICAgICB9KQogICAgICAgICAgICAuZmxhdE1hcChmdW5jdGlvbiAodGhyZWFkKSB7CiAgICAgICAgICAgIHZhciBzdGF0ZSA9IHN0b3JlLmdldFN0YXRlKCk7CiAgICAgICAgICAgIGlmICghdGhyZWFkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2xlYXJBY3Rpb25zOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaGFyZWRUaHJlYWRJZCA9IHN0YXRlLnNlbGVjdGVkU2hhcmVkVGhyZWFkOwogICAgICAgICAgICB2YXIgc2hhcmVkVGhyZWFkID0gc2hhcmVkVGhyZWFkSWQgJiYKICAgICAgICAgICAgICAgIHNlbGVjdFNoYXJlZFRocmVhZChzdGF0ZSwgc2hhcmVkVGhyZWFkSWQpOwogICAgICAgICAgICB2YXIgaXNVc2VyVGhyZWFkID0gc2hhcmVkVGhyZWFkICYmIHN0YXRlLm1lICYmIHN0YXRlLm1lLmRhdGEKICAgICAgICAgICAgICAgID8gc3RhdGUubWUuZGF0YS5pZCA9PT0gc2hhcmVkVGhyZWFkLnVzZXIgOiB0cnVlOwogICAgICAgICAgICB2YXIgbWVzc2FnZXMgPSBpc1VzZXJUaHJlYWQgPyB1bmlxQnkodGhyZWFkLm1lc3NhZ2VzLmNvbmNhdChzZWxlY3RPcHRpbWlzdGljTWVzc2FnZXNGb3JUaHJlYWQoc3RhdGUsIHRocmVhZC5pZCkpLCAncmZjSWQnKSA6IHRocmVhZC5tZXNzYWdlczsKICAgICAgICAgICAgLy8gUmVjb21wdXRlIHRocmVhZAogICAgICAgICAgICB2YXIgcGF0Y2hlZFRocmVhZCA9IGNvbXB1dGVUaHJlYWQoX19hc3NpZ24oX19hc3NpZ24oe30sIHRocmVhZCksIHsgbWVzc2FnZXM6IG1lc3NhZ2VzIH0pKTsKICAgICAgICAgICAgdmFyIG1lc3NhZ2VCb2RpZXMgPSBzdGF0ZS5tZXNzYWdlQm9kaWVzW3BhdGNoZWRUaHJlYWQuaWRdOwogICAgICAgICAgICBpZiAoIW1lc3NhZ2VCb2RpZXMgJiYgc2hhcmVkVGhyZWFkSWQgJiYgIWlzVXNlclRocmVhZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUubWVyZ2UoT2JzZXJ2YWJsZS5vZih0aHJlYWRTZWxlY3QocGF0Y2hlZFRocmVhZC5pZCwgcGF0Y2hlZFRocmVhZCkpLCBPYnNlcnZhYmxlLm9mKHNoYXJlZFRocmVhZE1lc3NhZ2VCb2RpZXNGZXRjaCh7CiAgICAgICAgICAgICAgICAgICAgc2hhcmVkVGhyZWFkOiBzaGFyZWRUaHJlYWRJZCwKICAgICAgICAgICAgICAgICAgICB0aHJlYWQ6IHBhdGNoZWRUaHJlYWQsCiAgICAgICAgICAgICAgICB9KSksIE9ic2VydmFibGUub2Yoc2hhcmVkVGhyZWFkQWN0aXZpdHlDbGVhcihudWxsKSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzZWxlY3RlZEFjdGl2aXR5ID0gc3RhdGUuc2VsZWN0ZWRBY3Rpdml0eTsKICAgICAgICAgICAgdmFyIHNlbGVjdGVkQ29udGFjdFRocmVhZCA9IHN0YXRlLnNlbGVjdGVkQ29udGFjdFRocmVhZDsKICAgICAgICAgICAgdmFyIGFjdGl2aXR5VGFiU2hvd24gPSBzdGF0ZS5yaWdodFNpZGViYXIudGFiID09PSBSaWdodFNpZGViYXJUYWIuQWN0aXZpdHk7CiAgICAgICAgICAgIHZhciBjb252ZXJzYXRpb25UYWJTaG93biA9IHN0YXRlLnJpZ2h0U2lkZWJhci50YWIgPT09IFJpZ2h0U2lkZWJhclRhYi5Db250YWN0CiAgICAgICAgICAgICAgICAmJiBzdGF0ZS5yaWdodFNpZGViYXIuc3ViVGFiID09PSBSaWdodFNpZGViYXJTdWJUYWIuQ29udmVyc2F0aW9uOwogICAgICAgICAgICB2YXIgYWN0aW9ucyA9IFsKICAgICAgICAgICAgICAgIE9ic2VydmFibGUub2Yoc2hhcmVkVGhyZWFkQWN0aXZpdHlDbGVhcihudWxsKSksCiAgICAgICAgICAgICAgICBPYnNlcnZhYmxlLm9mKHRocmVhZFNlbGVjdChwYXRjaGVkVGhyZWFkLmlkLCBwYXRjaGVkVGhyZWFkKSksCiAgICAgICAgICAgICAgICBPYnNlcnZhYmxlLm9mKGF0dGFjaG1lbnREb3dubG9hZFByb2dyZXNzQ2xlYXIobnVsbCkpLAogICAgICAgICAgICAgICAgT2JzZXJ2YWJsZS5vZihhY3Rpdml0eVNlbGVjdChhY3Rpdml0eVRhYlNob3duICYmIHNlbGVjdGVkQWN0aXZpdHkgJiYgdGhyZWFkCiAgICAgICAgICAgICAgICAgICAgJiYgdGhyZWFkLmlkID09PSBzZWxlY3RlZEFjdGl2aXR5LnRocmVhZCA/CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRBY3Rpdml0eSA6IHVuZGVmaW5lZCkpLAogICAgICAgICAgICAgICAgT2JzZXJ2YWJsZS5vZihjb250YWN0VGhyZWFkU2VsZWN0KGNvbnZlcnNhdGlvblRhYlNob3duICYmIHNlbGVjdGVkQ29udGFjdFRocmVhZCAmJgogICAgICAgICAgICAgICAgICAgIHRocmVhZC5pZCA9PT0gc2VsZWN0ZWRDb250YWN0VGhyZWFkLmlkID8KICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZENvbnRhY3RUaHJlYWQgOiB1bmRlZmluZWQpKSwKICAgICAgICAgICAgXTsKICAgICAgICAgICAgLy8gaGFuZGxlIGZyZXNoIHRocmVhZCAoZmV0Y2hlZCBmcm9tIHNlcnZlcikKICAgICAgICAgICAgaWYgKGhhdmVGcmVzaFRocmVhZCkgewogICAgICAgICAgICAgICAgYWN0aW9ucy5wdXNoKE9ic2VydmFibGUub2YodGhyZWFkU2luZ2xlKHRocmVhZCkpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbGFzdE1lc3NhZ2UgPSBsYXN0KHRocmVhZC5tZXNzYWdlcyk7CiAgICAgICAgICAgIHZhciBtYWlsYm94ID0gc3RvcmUuZ2V0U3RhdGUoKS5tYWlsYm94OwogICAgICAgICAgICBpZiAobWFpbGJveCAmJiBsYXN0TWVzc2FnZSAmJiAhaXNEcmFmdEJveChtYWlsYm94LnR5cGUpKSB7CiAgICAgICAgICAgICAgICBhY3Rpb25zLnB1c2goT2JzZXJ2YWJsZS5vZihjb250YWN0U2VsZWN0KGxhc3RNZXNzYWdlLnNlbnQgPyBsYXN0TWVzc2FnZS50b1swXSA6IGxhc3RNZXNzYWdlLmZyb20pKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFtZXNzYWdlQm9kaWVzKSB7CiAgICAgICAgICAgICAgICBhY3Rpb25zLnB1c2goT2JzZXJ2YWJsZS5vZihtZXNzYWdlQm9kaWVzRmV0Y2gocGF0Y2hlZFRocmVhZC5pZCkpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2FsZW5kYXJFdmVudE1lc3NhZ2VzID0gdGhyZWFkLm1lc3NhZ2VzLmZpbHRlcihmdW5jdGlvbiAobSkgeyByZXR1cm4gISFtLmNhbGVuZGFyRXZlbnQ7IH0pOwogICAgICAgICAgICB2YXIgbGF0ZXN0Q2FsZW5kYXJFdmVudE1lc3NhZ2UgPSBsYXN0KGNhbGVuZGFyRXZlbnRNZXNzYWdlcyk7CiAgICAgICAgICAgIGlmIChsYXRlc3RDYWxlbmRhckV2ZW50TWVzc2FnZSAmJiBsYXRlc3RDYWxlbmRhckV2ZW50TWVzc2FnZS5jYWxlbmRhckV2ZW50KSB7CiAgICAgICAgICAgICAgICBhY3Rpb25zLnB1c2goT2JzZXJ2YWJsZS5vZihjYWxlbmRhckV2ZW50R2V0KGxhdGVzdENhbGVuZGFyRXZlbnRNZXNzYWdlLmNhbGVuZGFyRXZlbnQpKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBhY3Rpb25zLnB1c2goT2JzZXJ2YWJsZS5vZihjYWxlbmRhckV2ZW50R2V0KCcnLCBudWxsKSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBPYnNlcnZhYmxlLm1lcmdlLmFwcGx5KE9ic2VydmFibGUsIGFjdGlvbnMpOwogICAgICAgIH0pOwogICAgfSk7Cn07CmV4cG9ydCB2YXIgc2VhcmNoVGhyZWFkcyA9IGZ1bmN0aW9uIChhY3Rpb24kLCBzdG9yZSwgZGVwcykgewogICAgcmV0dXJuIGFjdGlvbiQKICAgICAgICAub2ZUeXBlKFRIUkVBRFNfU0VBUkNIKQogICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGFjdGlvbikgeyByZXR1cm4gKGFjdGlvbi5zdGF0dXMgPT09IEFjdGlvblN0YXR1cy5TdGFydCk7IH0pCiAgICAgICAgLmZsYXRNYXAoZnVuY3Rpb24gKGFjdGlvbikgewogICAgICAgIHZhciBtYWlsYm94ID0gc3RvcmUuZ2V0U3RhdGUoKS5tYWlsYm94OwogICAgICAgIHZhciBpc09mZmxpbmUgPSAhc3RvcmUuZ2V0U3RhdGUoKS5pc09ubGluZTsKICAgICAgICAvLyBSZWZyZXNoIHRocmVhZHMgbGlzdCB3aGVuIGEgdXNlciBpcyB0eXBpbmcgaW4gdGhlIHNlYXJjaCBib3gKICAgICAgICAvLyBhbmQgYmFja3NwYWNlcyB1bnRpbCB0aGUgc2VhcmNoIGJveCBpcyBlbXB0eS4KICAgICAgICBpZiAoIWFjdGlvbi5tZXRhIHx8IGFjdGlvbi5tZXRhLnF1ZXJ5ID09PSAnJykgewogICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jb25jYXQoT2JzZXJ2YWJsZS5vZihtYWlsYm94U2VsZWN0KG1haWxib3gsIG1haWxib3gpKSwgT2JzZXJ2YWJsZS5vZih0aHJlYWRMaXN0KGZhbHNlKSkpOwogICAgICAgIH0KICAgICAgICB2YXIgbWFpbEFjY291bnRzID0gc3RvcmUuZ2V0U3RhdGUoKS5hY2NvdW50cwogICAgICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChhKSB7IHJldHVybiBhLnR5cGUgIT09IEFjY291bnRUeXBlLkFsaWFzOyB9KTsKICAgICAgICAvLyBVc2UgbG9jYWwgc2VhcmNoIGlmIFNlYXJjaERCIGlzIGVuYWJsZWQKICAgICAgICB2YXIgc2VhcmNoTWVjaGFuaXNtcyA9IGdldFNlYXJjaERiQ29uZmlnKCkuZW5hYmxlZAogICAgICAgICAgICA/IFtuZXdMb2NhbFRocmVhZFNlYXJjaChtYWlsYm94KQogICAgICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgIC8vIExvZyBlcnJvcnMgd2hlcmUgc2VhcmNoREIgZmV0Y2ggaGFzIGZhaWxlZAogICAgICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlRXhjZXB0aW9uKGUpOwogICAgICAgICAgICAgICAgICAgIC8vIEJ1dCBhbGxvdyBlbXB0eSB0byB3b3JrIGluIG9yZGVyIHRvIG5vdCBmYWlsIGJhY2t1cCBtZWNoYW5pc21zCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2YoW10pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAubWFwKGZ1bmN0aW9uIChyKSB7IHJldHVybiAoeyBwcm92aWRlcjogZmFsc2UsIHRocmVhZHM6IHIgfSk7IH0pXQogICAgICAgICAgICA6IFtdOwogICAgICAgIC8vIEFkZCBwcm92aWRlciBzZWFyY2ggb24gY29tcGxldGUgc2VhcmNoCiAgICAgICAgaWYgKG1haWxib3gucHJvdmlkZXJTZWFyY2gpIHsKICAgICAgICAgICAgc2VhcmNoTWVjaGFuaXNtcyA9IHNlYXJjaE1lY2hhbmlzbXMuY29uY2F0KHByb3ZpZGVyVGhyZWFkU2VhcmNoKGRlcHMudGhyZWFkcywgbWFpbGJveCkKICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgLy8gTG9nIGVycm9ycyB3aGVyZSBzZWFyY2hEQiBmZXRjaCBoYXMgZmFpbGVkCiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZQogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTsKICAgICAgICAgICAgICAgIGNhcHR1cmVFeGNlcHRpb24oZSk7CiAgICAgICAgICAgICAgICAvLyBEbyBiYWNrdXAgaWYgb2ZmbGluZSBhbmQgbm8gc2VhcmNoZGIgY29uZmlnCiAgICAgICAgICAgICAgICBpZiAoaXNPZmZsaW5lICYmICFnZXRTZWFyY2hEYkNvbmZpZygpLmVuYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYmFja3VwU2VhcmNoZXMgPSBtYWlsQWNjb3VudHMubWFwKGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2NhbFRocmVhZFNlYXJjaChfX2Fzc2lnbihfX2Fzc2lnbih7fSwgbWFpbGJveCksIHsgYWNjb3VudDogYS5pZCB9KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyKSB7IHJldHVybiBbXTsgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUKICAgICAgICAgICAgICAgICAgICAgICAgLnppcC5hcHBseShPYnNlcnZhYmxlLCBiYWNrdXBTZWFyY2hlcykubWFwKGZ1bmN0aW9uIChyZXN1bHRzKSB7IHJldHVybiBmbGF0dGVuKHJlc3VsdHMpOyB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIEJ1dCBhbGxvdyBlbXB0eSB0byB3b3JrIGluIG9yZGVyIHRvIG5vdCBmYWlsIGJhY2t1cCBtZWNoYW5pc21zCiAgICAgICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5vZihbXSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAubWFwKChmdW5jdGlvbiAocikgeyByZXR1cm4gKHsgcHJvdmlkZXI6IHRydWUsIHRocmVhZHM6IHIgfSk7IH0pKSk7CiAgICAgICAgICAgIC8vIFRyaWdnZXIgT2xkIFNlYXJjaCBtZWNoYW5pc20gZm9yIElNQVAgYWNjb3VudHMgaW4gcGxhY2Ugb2YgcHJvdmlkZXIgc2VhcmNoCiAgICAgICAgICAgIG1haWxBY2NvdW50cwogICAgICAgICAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgaWYgKG1haWxib3guYWNjb3VudCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYWlsYm94LmFjY291bnQgPT09IGEuaWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gW0FjY291bnRUeXBlLklNQVAsIEFjY291bnRUeXBlLmlDbG91ZF0uaW5kZXhPZihhLnR5cGUpID4gLTE7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAuZm9yRWFjaChmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgdmFyIG9sZEFjY291bnRSZXN1bHRzID0gbG9jYWxUaHJlYWRTZWFyY2goX19hc3NpZ24oX19hc3NpZ24oe30sIG1haWxib3gpLCB7IGFjY291bnQ6IGEuaWQgfSkpCiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTG9nIGVycm9ycyB3aGVyZSBzZWFyY2hEQiBmZXRjaCBoYXMgZmFpbGVkCiAgICAgICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGUKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpOwogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVFeGNlcHRpb24oZSk7CiAgICAgICAgICAgICAgICAgICAgLy8gQnV0IGFsbG93IGVtcHR5IHRvIHdvcmsgaW4gb3JkZXIgdG8gbm90IGZhaWwgYmFja3VwIG1lY2hhbmlzbXMKICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5vZihbXSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24gKHIpIHsgcmV0dXJuICh7IHByb3ZpZGVyOiBmYWxzZSwgdGhyZWFkczogciB9KTsgfSk7CiAgICAgICAgICAgICAgICBzZWFyY2hNZWNoYW5pc21zLnB1c2gob2xkQWNjb3VudFJlc3VsdHMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUubWVyZ2UuYXBwbHkoT2JzZXJ2YWJsZSwgc2VhcmNoTWVjaGFuaXNtcykubWFwKGZ1bmN0aW9uIChwYXlsb2FkKSB7CiAgICAgICAgICAgIHZhciBtYWlsYm94UXVlcnkgPSBzdG9yZS5nZXRTdGF0ZSgpLm1haWxib3gucXVlcnk7CiAgICAgICAgICAgIHJldHVybiBfX2Fzc2lnbihfX2Fzc2lnbih7fSwgcGF5bG9hZCksIHsgdGhyZWFkczogcGF5bG9hZC50aHJlYWRzLm1hcChmdW5jdGlvbiAodGhyZWFkKSB7IHJldHVybiAoX19hc3NpZ24oX19hc3NpZ24oe30sIHRocmVhZCksIHsgcXVlcnk6IG1haWxib3hRdWVyeSB9KSk7IH0pIH0pOwogICAgICAgIH0pCiAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24gKHBheWxvYWQpIHsgcmV0dXJuIHRocmVhZHNTZWFyY2goYWN0aW9uLm1ldGEsIHBheWxvYWQpOyB9KQogICAgICAgICAgICAudGFrZVVudGlsKGFjdGlvbiQub2ZUeXBlKFRIUkVBRFNfU0VBUkNIKQogICAgICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChhKSB7IHJldHVybiBhLnN0YXR1cyA9PT0gQWN0aW9uU3RhdHVzLlN0YXJ0OyB9KSk7CiAgICB9KTsKfTsKZXhwb3J0IHZhciBmZXRjaFRocmVhZCA9IGZ1bmN0aW9uIChhY3Rpb24kLCBzdG9yZSkgewogICAgcmV0dXJuIGFjdGlvbiQKICAgICAgICAub2ZUeXBlKFRIUkVBRF9GRVRDSCkKICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChhY3Rpb24pIHsgcmV0dXJuIGFjdGlvbi5zdGF0dXMgPT09IEFjdGlvblN0YXR1cy5TdGFydDsgfSkKICAgICAgICAuZmxhdE1hcChmdW5jdGlvbiAoYWN0aW9uKSB7CiAgICAgICAgcmV0dXJuIENhY2hlLmdldChTdG9yZXMuVGhyZWFkcywgYWN0aW9uLm1ldGEpCiAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24gKHRocmVhZCkgewogICAgICAgICAgICBpZiAoIXRocmVhZCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaHJlYWQgbm90IGZvdW5kIGluIGNhY2hlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRocmVhZEZldGNoKGFjdGlvbi5tZXRhLCB0aHJlYWQpOwogICAgICAgIH0pCiAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZSkgeyByZXR1cm4gT2JzZXJ2YWJsZS5vZih0aHJlYWRGZXRjaChhY3Rpb24ubWV0YSwgZSkpOyB9KTsKICAgIH0pOwp9OwovLyBIYW5kbGVzIHRocmVhZCBwYXRjaGVzLiBDYWxsZWQgZnJvbSBUaHJlYWRDb21taXRTdWJtaXQsIHNob3VsZCBub3QgYmUgY2FsbGVkIGRpcmVjdGx5CnZhciB1cGRhdGVUaHJlYWQgPSBmdW5jdGlvbiAoYWN0aW9uJCwgc3RvcmUpIHsKICAgIHJldHVybiBhY3Rpb24kCiAgICAgICAgLm9mVHlwZShUSFJFQURfVVBEQVRFKQogICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGFjdGlvbikgeyByZXR1cm4gYWN0aW9uLnN0YXR1cyA9PT0gQWN0aW9uU3RhdHVzLlN0YXJ0OyB9KQogICAgICAgIC5mbGF0TWFwKGZ1bmN0aW9uIChhY3Rpb24pIHsKICAgICAgICB2YXIgc3RhdGUgPSBzdG9yZS5nZXRTdGF0ZSgpOwogICAgICAgIHZhciBjb21taXQgPSBhY3Rpb24ubWV0YTsKICAgICAgICB2YXIgZm91bmRUaHJlYWQgPSBzZWxlY3RUaHJlYWRTZWxlY3RvcihzdGF0ZSwgY29tbWl0LnJlc291cmNlSWQpOwogICAgICAgIHJldHVybiAoISFmb3VuZFRocmVhZAogICAgICAgICAgICA/IE9ic2VydmFibGUub2YoZm91bmRUaHJlYWQpCiAgICAgICAgICAgIDogQ2FjaGUuZ2V0KFN0b3Jlcy5UaHJlYWRzLCBjb21taXQucmVzb3VyY2VJZCkpCiAgICAgICAgICAgIC5mbGF0TWFwKGZ1bmN0aW9uICh0aHJlYWQpIHsKICAgICAgICAgICAgaWYgKCF0aHJlYWQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVGhyZWFkIG5vdCBmb3VuZCBpbiBjYWNoZScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1cGRhdGVkVGhyZWFkID0gY29tcHV0ZVRocmVhZChwYXRjaGVkKHRocmVhZCwgY29tbWl0KSk7CiAgICAgICAgICAgIC8vIEhhbmRsZSB1cGRhdGVzIHdpdGggY29tcHV0ZWQgdGhyZWFkCiAgICAgICAgICAgIHZhciBvcHRpbWlzdGljTWVzc2FnZXMgPSBzZWxlY3RPcHRpbWlzdGljTWVzc2FnZXNGb3JUaHJlYWQoc3RvcmUuZ2V0U3RhdGUoKSwgdXBkYXRlZFRocmVhZC5pZCk7CiAgICAgICAgICAgIC8vIEFwcGVuZCBhbnkgbmVjZXNzYXJ5IG9wdGltaXN0aWMgbWVzc2FnZXMKICAgICAgICAgICAgLy8gVE9ETyhTSElOKTogSW1wbGVtZW50IGRlZHVwbGljYXRpb24gdXNpbmcgcmZjSWQKICAgICAgICAgICAgaWYgKG9wdGltaXN0aWNNZXNzYWdlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBhbGxNZXNzYWdlcyA9IHVuaXFCeSh1cGRhdGVkVGhyZWFkLm1lc3NhZ2VzLmNvbmNhdChvcHRpbWlzdGljTWVzc2FnZXMpLCAncmZjSWQnKTsKICAgICAgICAgICAgICAgIHVwZGF0ZWRUaHJlYWQubWVzc2FnZXMgPSBhbGxNZXNzYWdlczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gQ2FjaGUKICAgICAgICAgICAgICAgIC5zYXZlKFN0b3Jlcy5UaHJlYWRzLCB1cGRhdGVkVGhyZWFkKQogICAgICAgICAgICAgICAgLmZsYXRNYXAoZnVuY3Rpb24gKCkgeyByZXR1cm4gT2JzZXJ2YWJsZS5vZih0aHJlYWRVcGRhdGUoY29tbWl0LCB1cGRhdGVkVGhyZWFkKSk7IH0pOwogICAgICAgIH0pOwogICAgfSk7Cn07Ci8vIFRocmVhZCB1cGRhdGVzIHNob3VsZCB1cGRhdGUgc2VsZWN0ZWQgdGhyZWFkCmV4cG9ydCB2YXIgc2VsZWN0ZWRUaHJlYWRVcGRhdGVkID0gZnVuY3Rpb24gKGFjdGlvbiQsIHN0b3JlKSB7CiAgICByZXR1cm4gYWN0aW9uJAogICAgICAgIC5vZlR5cGUoVEhSRUFEX1VQREFURSkKICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChhY3Rpb24pIHsgcmV0dXJuIGFjdGlvbi5zdGF0dXMgPT09IEFjdGlvblN0YXR1cy5TdWNjZXNzOyB9KQogICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGFjdGlvbikgewogICAgICAgIHZhciBzdGF0ZSA9IHN0b3JlLmdldFN0YXRlKCk7CiAgICAgICAgdmFyIGV4aXN0aW5nVGhyZWFkID0gc3RhdGUuc2VsZWN0ZWRUaHJlYWQ7CiAgICAgICAgcmV0dXJuIGV4aXN0aW5nVGhyZWFkICYmIG1hdGNoZXNUaHJlYWQoZXhpc3RpbmdUaHJlYWQsIGFjdGlvbi5wYXlsb2FkKSB8fCBmYWxzZTsKICAgIH0pCiAgICAgICAgLm1hcChmdW5jdGlvbiAoYWN0aW9uKSB7IHJldHVybiBtZXNzYWdlQm9kaWVzRmV0Y2goYWN0aW9uLnBheWxvYWQuaWQpOyB9KTsKfTsKLy8gVGhyZWFkIHVwZGF0ZXMgc2hvdWxkIHVwZGF0ZSBzZWxlY3RlZCB0aHJlYWQKZXhwb3J0IHZhciBzZWxlY3RlZFRocmVhZFNpbmdsZSA9IGZ1bmN0aW9uIChhY3Rpb24kLCBzdG9yZSkgewogICAgcmV0dXJuIGFjdGlvbiQKICAgICAgICAub2ZUeXBlKFRIUkVBRF9TSU5HTEUpCiAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoYWN0aW9uKSB7IHJldHVybiBhY3Rpb24uc3RhdHVzID09PSBBY3Rpb25TdGF0dXMuU3RhcnQ7IH0pCiAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoYWN0aW9uKSB7CiAgICAgICAgdmFyIHN0YXRlID0gc3RvcmUuZ2V0U3RhdGUoKTsKICAgICAgICB2YXIgZXhpc3RpbmdUaHJlYWQgPSBzdGF0ZS5zZWxlY3RlZFRocmVhZDsKICAgICAgICByZXR1cm4gZXhpc3RpbmdUaHJlYWQgJiYgbWF0Y2hlc1RocmVhZChleGlzdGluZ1RocmVhZCwgYWN0aW9uLm1ldGEpIHx8IGZhbHNlOwogICAgfSkKICAgICAgICAubWFwKGZ1bmN0aW9uIChhY3Rpb24pIHsKICAgICAgICByZXR1cm4gbWVzc2FnZUJvZGllc0ZldGNoKGFjdGlvbi5tZXRhLmlkKTsKICAgIH0pOwp9OwovLyBIYW5kbGVzIGVtaXR0aW5nIHRocmVhZCB1cGRhdGUgZXZlbnRzCmV4cG9ydCB2YXIgdXBkYXRlVGhyZWFkcyA9IGZ1bmN0aW9uIChhY3Rpb24kLCBzdG9yZSwgZGVwcykgewogICAgcmV0dXJuIGFjdGlvbiQKICAgICAgICAub2ZUeXBlKFRIUkVBRF9DT01NSVRTX1NVQk1JVCkKICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChhY3Rpb24pIHsgcmV0dXJuIGFjdGlvbi5zdGF0dXMgPT09IEFjdGlvblN0YXR1cy5TdGFydDsgfSkKICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChhY3Rpb24pIHsKICAgICAgICB2YXIgc3RhdGUgPSBzdG9yZS5nZXRTdGF0ZSgpOwogICAgICAgIHJldHVybiBzdGF0ZS5zZWxlY3RlZElkcy5zaXplID4gMCB8fCAhIWFjdGlvbi5tZXRhLnNpbmdsZVJlc291cmNlIHx8CiAgICAgICAgICAgICEhc3RhdGUudGhyZWFkU3dpcGVJZCB8fAogICAgICAgICAgICAhIShzdGF0ZS5zZWxlY3RlZFRocmVhZCAmJiBzdGF0ZS5zZWxlY3RlZFRocmVhZC5pZCk7CiAgICB9KQogICAgICAgIC8vIFRyYWNrIFRocmVhZCBPcGVyYXRpb25zIGFuZCBSZWFkL1VucmVhZAogICAgICAgIC5kbyhmdW5jdGlvbiAoYWN0aW9uKSB7CiAgICAgICAgLy8gVHJhY2sgVGhyZWFkIE9wZXJhdGlvbiBFdmVudHMKICAgICAgICBpZiAoYWN0aW9uLm1ldGEuYm94KSB7CiAgICAgICAgICAgIHJlY29yZEV2ZW50KFVzZXJFdmVudHMuVGhyZWFkT3BlcmF0aW9uLCB7IGJveDogYWN0aW9uLm1ldGEuYm94IH0pOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChhY3Rpb24ubWV0YS53aGVuKSB7CiAgICAgICAgICAgIHJlY29yZEV2ZW50KFVzZXJFdmVudHMuVGhyZWFkT3BlcmF0aW9uLCB7IGJveDogVGhyZWFkQm94LkxhdGVyIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChhY3Rpb24ubWV0YS5sYWJlbCkgewogICAgICAgICAgICByZWNvcmRFdmVudChVc2VyRXZlbnRzLlRocmVhZE9wZXJhdGlvbiwgeyBib3g6IFRocmVhZEJveC5MaXN0IH0pOwogICAgICAgIH0KICAgICAgICAvLyBUcmFjayBSZWFkIEV2ZW50cwogICAgICAgIGlmIChhY3Rpb24ubWV0YS5yZWFkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgYWN0aW9uLm1ldGEucmVhZAogICAgICAgICAgICAgICAgPyByZWNvcmRFdmVudChVc2VyRXZlbnRzLlRocmVhZFJlYWQpCiAgICAgICAgICAgICAgICA6IHJlY29yZEV2ZW50KFVzZXJFdmVudHMuVGhyZWFkVW5yZWFkKTsKICAgICAgICB9CiAgICAgICAgLy8gVHJhY2sgTXV0ZSBFdmVudHMKICAgICAgICBpZiAoYWN0aW9uLm1ldGEubXV0ZWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBhY3Rpb24ubWV0YS5tdXRlZAogICAgICAgICAgICAgICAgPyByZWNvcmRFdmVudChVc2VyRXZlbnRzLlRocmVhZE11dGVkKQogICAgICAgICAgICAgICAgOiByZWNvcmRFdmVudChVc2VyRXZlbnRzLlRocmVhZFVubXV0ZWQpOwogICAgICAgIH0KICAgIH0pCiAgICAgICAgLmZsYXRNYXAoZnVuY3Rpb24gKGFjdGlvbikgewogICAgICAgIHZhciBzdGF0ZSA9IHN0b3JlLmdldFN0YXRlKCk7CiAgICAgICAgdmFyIHNlbGVjdGVkVGhyZWFkSWQgPSBzdGF0ZS5zZWxlY3RlZFRocmVhZCAmJiBzdGF0ZS5zZWxlY3RlZFRocmVhZC5pZDsKICAgICAgICB2YXIgdGhyZWFkSWRzID0gYWN0aW9uLm1ldGEuc2luZ2xlUmVzb3VyY2UKICAgICAgICAgICAgPyBbYWN0aW9uLm1ldGEuc2luZ2xlUmVzb3VyY2VdCiAgICAgICAgICAgIDogQXJyYXkuZnJvbShzdGF0ZS5zZWxlY3RlZElkcy5rZXlzKCkpOwogICAgICAgIC8vIEFkZCBzZWxlY3RlZFRocmVhZElkIGlmIHRocmVhZElkcyBsZW5ndGggZG9lcyBub3QgZXhpc3QKICAgICAgICBpZiAoIWFjdGlvbi5tZXRhLnNpbmdsZVJlc291cmNlICYmIHNlbGVjdGVkVGhyZWFkSWQgJiYgdGhyZWFkSWRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICB0aHJlYWRJZHMgPSBbc2VsZWN0ZWRUaHJlYWRJZF07CiAgICAgICAgfQogICAgICAgIC8vIERvIHNpbmdsZSByZXNvdXJjZSBpZiBzd2lwZSB3YXMgYWN0aXZhdGVkCiAgICAgICAgaWYgKHN0YXRlLnRocmVhZFN3aXBlSWQpIHsKICAgICAgICAgICAgdGhyZWFkSWRzID0gW3N0YXRlLnRocmVhZFN3aXBlSWRdOwogICAgICAgIH0KICAgICAgICB2YXIgdGhyZWFkVXBkYXRlcyA9IHRocmVhZElkcy5tYXAoZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgICAgIHZhciBmb3VuZFRocmVhZCA9IHNlbGVjdFRocmVhZFNlbGVjdG9yKHN0YXRlLCBpZCk7CiAgICAgICAgICAgIHJldHVybiAoISFmb3VuZFRocmVhZCA/IE9ic2VydmFibGUub2YoZm91bmRUaHJlYWQpIDogQ2FjaGUuZ2V0KFN0b3Jlcy5UaHJlYWRzLCBpZCkpCiAgICAgICAgICAgICAgICAubWFwKGZ1bmN0aW9uICh0aHJlYWQpIHsgcmV0dXJuIGNyZWF0ZVRocmVhZENvbW1pdCh0aHJlYWQsIGFjdGlvbi5tZXRhKTsgfSkKICAgICAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGNvbW1pdCkgeyByZXR1cm4gY29tbWl0ICE9PSB1bmRlZmluZWQ7IH0pCiAgICAgICAgICAgICAgICAubWFwKGZ1bmN0aW9uIChjb21taXQpIHsgcmV0dXJuIChfX2Fzc2lnbihfX2Fzc2lnbih7fSwgY29tbWl0KSwgeyBjcmVhdGVkOiBkZXBzLm5vdygpIH0pKTsgfSkKICAgICAgICAgICAgICAgIC5mbGF0TWFwKGZ1bmN0aW9uIChjb21taXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdWJtaXRDb21taXQoY29tbWl0KS5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChjb21taXQubWV0aG9kID09PSAnREVMRVRFJykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhyZWFkRGVsZXRlKGNvbW1pdC5yZXNvdXJjZUlkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRocmVhZFVwZGF0ZShjb21taXQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIC8vIFVuc2V0IHN3aXBlIGlkIGlmIGV4aXN0cwogICAgICAgIGlmIChzdGF0ZS50aHJlYWRTd2lwZUlkKSB7CiAgICAgICAgICAgIHRocmVhZFVwZGF0ZXMudW5zaGlmdChPYnNlcnZhYmxlLm9mKHRocmVhZFN3aXBlSWRTZXQobnVsbCkpKTsKICAgICAgICB9CiAgICAgICAgdGhyZWFkVXBkYXRlcy51bnNoaWZ0KE9ic2VydmFibGUub2YodGhyZWFkQ29tbWl0c1N1Ym1pdChhY3Rpb24ubWV0YSwgbnVsbCkpKTsKICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5tZXJnZS5hcHBseShPYnNlcnZhYmxlLCB0aHJlYWRVcGRhdGVzKTsKICAgIH0pOwp9OwpleHBvcnQgdmFyIGRyYWZ0U2VuZFVwZGF0ZVNlbGVjdGVkVGhyZWFkID0gZnVuY3Rpb24gKGFjdGlvbiQsIHN0b3JlKSB7CiAgICByZXR1cm4gYWN0aW9uJAogICAgICAgIC5vZlR5cGUoRFJBRlRfU0VORCkKICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChhY3Rpb24pIHsKICAgICAgICBpZiAoYWN0aW9uLnN0YXR1cyAhPT0gQWN0aW9uU3RhdHVzLlN1Y2Nlc3MpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB2YXIgZXhpc3RpbmdUaHJlYWQgPSBzdG9yZS5nZXRTdGF0ZSgpLnNlbGVjdGVkVGhyZWFkOwogICAgICAgIGlmIChleGlzdGluZ1RocmVhZCAmJiBleGlzdGluZ1RocmVhZC5pZCA9PT0gYWN0aW9uLnBheWxvYWQudGhyZWFkVjIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0pCiAgICAgICAgLm1hcChmdW5jdGlvbiAoYWN0aW9uKSB7IHJldHVybiB0aHJlYWRTZWxlY3QoYWN0aW9uLnBheWxvYWQudGhyZWFkVjIpOyB9KTsKfTsKZXhwb3J0IHZhciBzZWxlY3RDb250YWN0VGhyZWFkID0gZnVuY3Rpb24gKGFjdGlvbiQpIHsKICAgIHJldHVybiBhY3Rpb24kCiAgICAgICAgLm9mVHlwZShDT05UQUNUX1RIUkVBRF9TRUxFQ1QpCiAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoYWN0aW9uKSB7IHJldHVybiBhY3Rpb24uc3RhdHVzID09PSBBY3Rpb25TdGF0dXMuU3RhcnQ7IH0pCiAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoYWN0aW9uKSB7IHJldHVybiBhY3Rpb24ubWV0YSAhPT0gdW5kZWZpbmVkOyB9KQogICAgICAgIC5mbGF0TWFwKGZ1bmN0aW9uIChhY3Rpb24pIHsKICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5vZihhY3Rpdml0eVNlbGVjdCh1bmRlZmluZWQpKQogICAgICAgICAgICAudGFrZVVudGlsKGFjdGlvbiQub2ZUeXBlKENPTlRBQ1RfVEhSRUFEX1NFTEVDVCkpOwogICAgfSk7Cn07CmV4cG9ydCB2YXIgZGlzYWJsZVRyYWNrRXBpYyA9IGZ1bmN0aW9uIChhY3Rpb24kLCBzdG9yZSwgZGVwcykgewogICAgcmV0dXJuIGFjdGlvbiQKICAgICAgICAub2ZUeXBlKFRIUkVBRF9ESVNBQkxFX1RSQUNLKQogICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGFjdGlvbikgeyByZXR1cm4gYWN0aW9uLnN0YXR1cyA9PT0gQWN0aW9uU3RhdHVzLlN0YXJ0OyB9KQogICAgICAgIC5mbGF0TWFwKGZ1bmN0aW9uIChhY3Rpb24pIHsKICAgICAgICByZXR1cm4gZGVwcy50aHJlYWRzCiAgICAgICAgICAgIC5kaXNhYmxlVHJhY2soYWN0aW9uLm1ldGEpCiAgICAgICAgICAgIC5mbGF0TWFwKGZ1bmN0aW9uIChyKSB7IHJldHVybiBPYnNlcnZhYmxlLm1lcmdlKE9ic2VydmFibGUub2YodGhyZWFkRGlzYWJsZVRyYWNrKGFjdGlvbi5tZXRhLCByKSksIE9ic2VydmFibGUub2YodG9hc3RTZXQobmV3IENvbmZpcm1hdGlvbkVycm9yKCdUcmFja2luZyBoYXMgYmVlbiBkaXNhYmxlZCBmb3IgdGhpcyBjb252ZXJzYXRpb24nLCB0cnVlLCBDb25maXJtYXRpb25Qb3NpdG9uLlRvcENlbnRlcikpKSk7IH0pCiAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5tZXJnZShPYnNlcnZhYmxlLm9mKHRocmVhZERpc2FibGVUcmFjayhhY3Rpb24ubWV0YSwgZSkpLCBPYnNlcnZhYmxlLm9mKHRvYXN0U2V0KG5ldyBFcnJvcigiRmFpbGVkIHRvIHVwZGF0ZSB0cmFja2luZyBzZXR0aW5nczogIiArIGUubWVzc2FnZSkpKSk7CiAgICAgICAgfSk7CiAgICB9KTsKfTsKZXhwb3J0IGRlZmF1bHQgWwogICAgdXBkYXRlTWFpbGJveFRocmVhZHMsCiAgICBsb2NhdGlvbkNoYW5nZVVwZGF0ZU1haWxib3gsCiAgICBsb2NhdGlvbkNoYW5nZVNlbGVjdFRocmVhZCwKICAgIHNlbGVjdGVkVGhyZWFkVXBkYXRlZCwKICAgIHNlbGVjdGVkVGhyZWFkU2luZ2xlLAogICAgc2VsZWN0VGhyZWFkLAogICAgdXBkYXRlVGhyZWFkLAogICAgdXBkYXRlVGhyZWFkcywKICAgIGNvbnRhY3RUaHJlYWRzLAogICAgc2VhcmNoVGhyZWFkcywKICAgIGZldGNoVGhyZWFkLAogICAgZHJhZnRTZW5kVXBkYXRlU2VsZWN0ZWRUaHJlYWQsCiAgICBzZWxlY3RDb250YWN0VGhyZWFkLAogICAgbWFpbGJveFNlbGVjdEVwaWMsCiAgICBkcmFmdFNlbmRBbmRBcmNoaXZlRXBpYywKICAgIGRpc2FibGVUcmFja0VwaWMsCl07Cg=="},{"version":3,"file":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/src/epics/threads.ts","sourceRoot":"","sources":["/Users/andrewsamboy/Desktop/Git/polymail/webapp/src/epics/threads.ts"],"names":[],"mappings":"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","sourcesContent":["import { MiddlewareAPI } from 'redux';\nimport { orderBy, last, uniqBy, flatten } from 'lodash';\nimport { Observable } from 'rxjs';\nimport { Epic } from 'redux-observable';\nimport { submitCommit, createThreadCommit } from '@src/lib/commit';\nimport Cache, { Stores } from '@src/lib/db';\nimport { getQueryVariable } from '@src/lib/query';\n\nimport { activitySelect } from '@src/ducks/activityFeed';\nimport {\n  patched,\n  matchesThread,\n  computeThread,\n  mailboxThreadsPredicate,\n  listThreadsByBox,\n  listThreadsByAccountBox,\n  listThreadsByList,\n  listThreadsByAccountList,\n  listThreadsSent,\n  listThreadsAccountSent,\n  listThreadsByEmail,\n  listThreadsStarred,\n  listThreadsFollowUp,\n  THREAD_LIST_SIZE,\n  listThreadsAccountStarred,\n} from '@src/lib/thread';\n\nimport {\n  parseQueryParams,\n  localThreadSearch,\n  providerThreadSearch,\n} from '@src/lib/search';\n\nimport {\n  StoreState,\n  Action,\n  ActionStatus,\n  Thread,\n  ThreadBox,\n  Mailbox,\n  MailboxType,\n  Commit,\n  Activity,\n  ThreadCommitMeta,\n  MessageBody,\n  AccountType,\n  Message,\n  Draft,\n} from '@src/types/index';\nimport {\n  RightSidebarTab,\n  RightSidebarSubTab,\n} from '@src/types/rightSidebar';\n\nimport { LOCATION_CHANGE, LocationChangeAction } from 'react-router-redux';\n\nimport {\n  threadSelect, THREAD_SELECT,\n  THREAD_LIST, threadList,\n  THREAD_UPDATE, threadUpdate,\n  THREADS_SELECTED_CONTACT, threadsSelectedContact,\n  THREADS_SEARCH, threadsSearch,\n  THREAD_FETCH, threadFetch,\n  THREAD_COMMITS_SUBMIT, threadCommitsSubmit,\n  contactThreadSelect,\n  CONTACT_THREAD_SELECT,\n  THREAD_SINGLE,\n  threadDelete,\n  threadSwipeIdSet,\n  attachmentDownloadProgressClear,\n  selectThread as selectThreadSelector,\n  threadSingle,\n  selectActivityThread,\n  ThreadSearchPayload, THREAD_DISABLE_TRACK, threadDisableTrack,\n} from '@src/ducks/threads';\n\nimport { messageBodiesFetch, sharedThreadMessageBodiesFetch } from '@src/ducks/messageBodies';\n\nimport {\n  DRAFT_SEND,\n  selectOptimisticMessagesForThread,\n  draftSelect,\n  selectSendingDrafts,\n} from '@src/ducks/drafts';\nimport { Deps } from '@src/lib/epic';\nimport { contactSelect } from '@src/ducks/contacts';\nimport { mailboxSelect, MAILBOX_SELECT } from '@src/ducks/mailbox';\nimport { recordEvent, UserEvents } from '@src/lib/analytics';\nimport { toThread } from '@src/lib/draft';\nimport { calendarEventGet } from '@src/ducks/calendars';\nimport {\n  sharedThreadSelectByThread,\n  selectSharedThread,\n  sharedThreadActivityClear,\n} from '@src/ducks/sharedThreads';\nimport { draftSendAndArchiveEpic } from '@src/epics/drafts';\nimport { newLocalThreadSearch } from '@src/lib/searchDb';\nimport { getSearchDbConfig } from '@src/lib/device';\nimport { isDraftBox } from '@src/lib/mailbox';\nimport { captureException } from '@sentry/browser';\nimport { ConfirmationError, ConfirmationPositon, toastSet } from '@src/ducks/toasts';\n\nexport const isMailboxUpdateAction = (action: Action<any, any>) => {\n  const types = [THREAD_LIST, LOCATION_CHANGE, THREADS_SEARCH];\n\n  return !!types.filter(type => action.type === type).length;\n};\n\n// Observable that returns threadList action for a given Mailbox\nfunction mailboxList(mailbox: Mailbox, store: MiddlewareAPI<StoreState>) {\n  // Don't need to fetch threads from indexed db if viewing drafts\n  if (isDraftBox(mailbox.type)) {\n    return Observable.concat(\n      Observable.of(mailboxSelect(mailbox, mailbox)),\n      Observable.of(threadList(false, [])),\n    );\n  }\n\n  // Do not update mailbox threads when in query mode\n  const mailboxThreads = store.getState().mailboxThreads.data;\n  if (mailbox.query && mailbox.query !== '' && mailboxThreads) {\n    return Observable.concat(\n      Observable.of(mailboxSelect(mailbox, mailbox)),\n      Observable.of(threadList(false, mailboxThreads)),\n    );\n  }\n\n  // Predicate Filters, need to run unread filtering at db level\n  const predicateFilter = (thread: Thread) => mailboxThreadsPredicate(mailbox, thread);\n\n  // Handle MailboxBox and List filters\n  let listThreads: Observable<Thread[]>;\n  if (mailbox.type === MailboxType.Inbox) {\n    listThreads = mailbox.account ?\n      listThreadsByAccountBox(mailbox.account, ThreadBox.Inbox, undefined, predicateFilter) :\n      listThreadsByBox(ThreadBox.Inbox, undefined, predicateFilter);\n\n  } else if (mailbox.type === MailboxType.Archive) {\n    listThreads = mailbox.account ?\n      listThreadsByAccountBox(mailbox.account, ThreadBox.Archive, undefined, predicateFilter) :\n      listThreadsByBox(ThreadBox.Archive, undefined, predicateFilter);\n\n  } else if (mailbox.type === MailboxType.Later) {\n    listThreads = mailbox.account ?\n      listThreadsByAccountBox(mailbox.account, ThreadBox.Later, undefined, predicateFilter) :\n      listThreadsByBox(ThreadBox.Later, undefined, predicateFilter);\n\n  } else if (mailbox.type === MailboxType.Spam) {\n    listThreads = mailbox.account ?\n      listThreadsByAccountBox(mailbox.account, ThreadBox.Spam, undefined, predicateFilter) :\n      listThreadsByBox(ThreadBox.Spam, undefined, predicateFilter);\n\n  } else if (mailbox.type === MailboxType.Trash) {\n    listThreads = mailbox.account ?\n      listThreadsByAccountBox(mailbox.account, ThreadBox.Trash, undefined, predicateFilter) :\n      listThreadsByBox(ThreadBox.Trash, undefined, predicateFilter);\n\n  } else if (mailbox.list) {\n    listThreads = mailbox.account ?\n      listThreadsByAccountList(mailbox.account, mailbox.list, undefined, predicateFilter) :\n      listThreadsByList(mailbox.list, undefined, predicateFilter);\n\n  } else if (mailbox.sent) {\n    listThreads = mailbox.account ?\n      listThreadsAccountSent(mailbox.account, undefined, predicateFilter) :\n      listThreadsSent(undefined, predicateFilter);\n\n  } else if (mailbox.starred) {\n    listThreads = mailbox.account ?\n      listThreadsAccountStarred(mailbox.account, predicateFilter) :\n      listThreadsStarred(predicateFilter);\n\n  // tslint:disable-next-line\n  } else if (mailbox.followUp) {\n    listThreads = listThreadsFollowUp(predicateFilter);\n\n  } else {\n\n    // Slow full index scan. Avoid if possible.\n    listThreads = Cache.list<Thread>(Stores.Threads, predicateFilter);\n  }\n\n  // Perform list operation on db\n  return listThreads\n    .map((threads) => {\n      // Filter\n      // Add optimistics\n      const sendingDrafts: Draft[] = selectSendingDrafts(store.getState())\n        .filter((draft: Draft) => !draft.threadV2);\n      sendingDrafts\n        .forEach((draft) => {\n          const thread = toThread(draft, store.getState().accounts);\n          if (mailboxThreadsPredicate(mailbox, thread)) {\n            threads.push(thread);\n          }\n        });\n\n      // Patch in optimistic messages\n      const optimisticThreads = threads.map((thread) => {\n        const messages = uniqBy(\n          thread.messages.concat(selectOptimisticMessagesForThread(store.getState(), thread.id)),\n          'rfcId',\n        );\n        return { ...thread, messages };\n      });\n\n      // Handle Sent folder sort\n      if (mailbox.sent) {\n        return orderBy(\n          optimisticThreads.map(thread => computeThread(thread)), t => t.lastSent, 'desc',\n        );\n      }\n\n      // Sort\n      switch (mailbox.type) {\n        case MailboxType.Inbox:\n          return orderBy(\n            optimisticThreads.map(thread => computeThread(thread)), t => t.sort, 'desc',\n          );\n        case MailboxType.Later:\n          return orderBy(\n            optimisticThreads.map(thread => computeThread(thread)), t => t.sort, 'asc',\n          );\n        default:\n          return orderBy(\n            optimisticThreads.map(thread => computeThread(thread)), t => t.internal, 'desc',\n          );\n      }\n    })\n    .flatMap(threads => Observable.concat(\n      Observable.of(mailboxSelect(mailbox, mailbox)),\n      Observable.of(threadList(false, threads)),\n    ))\n    .catch((e: Error) => Observable.of(threadList(false, e)));\n}\n\nconst mailboxSelectEpic: Epic<Action<Mailbox|boolean, any>, StoreState> = action$ =>\n  action$\n  .ofType(MAILBOX_SELECT)\n  .filter(action => action.status === ActionStatus.Start)\n  .map(action => threadList(false));\n\n// handle location change based updates to selected mailbox\nconst locationChangeUpdateMailbox: Epic<Action<any, any>, StoreState, Deps> =\n  (action$, store, deps) =>\n    action$.ofType(LOCATION_CHANGE)\n      .filter((action) => {\n        const path = ((action as any) as LocationChangeAction).payload.pathname.toLowerCase();\n        const split = path.split('/');\n        if (split[3] && split[3] === 'compose') {\n          return false;\n        }\n        return path.startsWith('/mail') || path === '/';\n      })\n      .debounceTime(200, deps.scheduler)\n      .map((action) => {\n        // Convert the route into a Mailbox model\n        const mailbox: Mailbox = {\n          type: MailboxType.Any,\n        };\n\n        const routeAction = (action as any) as LocationChangeAction;\n        if (routeAction.payload.pathname === '/') {\n          mailbox.type = MailboxType.Inbox;\n        }\n\n        const path = routeAction.payload.pathname.split('/');\n\n        const selectedAccount = (path[2] || 'all').toLowerCase();\n        const account = (path[4] || '').toLowerCase();\n        const box = (path[3] || 'inbox').toLowerCase();\n\n        if (selectedAccount !== 'all' || account.startsWith('account-')) {\n          mailbox.account = selectedAccount !== 'all' ? selectedAccount\n            : account.slice(account.indexOf('-') + 1);\n        }\n\n        // Set query parameter according to filter\n        const unreadQuery = getQueryVariable('unread', routeAction.payload.search);\n        if (unreadQuery) {\n          mailbox.read = false;\n        }\n\n        switch (box) {\n          case 'inbox':\n            mailbox.type = MailboxType.Inbox;\n            break;\n          case 'archive':\n            mailbox.type = MailboxType.Archive;\n            break;\n          case 'later':\n            mailbox.type = MailboxType.Later;\n            break;\n          case 'spam':\n            mailbox.type = MailboxType.Spam;\n            break;\n          case 'trash':\n            mailbox.type = MailboxType.Trash;\n            break;\n          case 'starred':\n            mailbox.starred = true;\n            break;\n          case 'lists':\n            mailbox.list = path[4] || '';\n            break;\n          case 'sendlater':\n            mailbox.type = MailboxType.SendLater;\n            break;\n          case 'sent':\n            mailbox.sent = true;\n            break;\n          case 'followup':\n            mailbox.followUp = true;\n            break;\n          case 'outbox':\n            mailbox.type = MailboxType.Outbox;\n            break;\n          case 'drafts':\n            mailbox.type = MailboxType.Drafts;\n            break;\n          default:\n            break;\n        }\n        const mailboxPropsToCheck = [\n          'type',\n          'list',\n          'account',\n          'starred',\n        ];\n        let isEqual = true;\n        mailboxPropsToCheck.forEach((p) => {\n          if (mailbox[p] !== store.getState().mailbox[p]) {\n            isEqual = false;\n          }\n        });\n\n        const query =\n          // explicit query param\n          (routeAction.payload.search && getQueryVariable('query', routeAction.payload.search)) ||\n          // preserve query if same mailbox\n          (isEqual && store.getState().mailbox.query);\n\n        if (query) {\n          mailbox.query = query;\n\n          // preserve query params if it's the same query\n          mailbox.queryParams = store.getState().mailbox.query === query ?\n            mailbox.queryParams = store.getState().mailbox.queryParams :\n            mailbox.queryParams = parseQueryParams(query, store.getState().lists);\n        }\n\n        return mailbox;\n      })\n      .filter((mailbox) => {\n        const mailboxPropsToCheck = [\n          'type',\n          'query',\n          'queryParams',\n          'list',\n          'account',\n          'starred',\n          'sent',\n          'followUp',\n        ];\n        // If Mailbox didn't change, don't want to refetch\n        const currentMailbox = store.getState().mailbox;\n\n        let isEqual = true;\n        mailboxPropsToCheck.forEach((p) => {\n          if (mailbox[p] !== currentMailbox[p]) {\n            isEqual = false;\n          }\n        });\n\n        return !isEqual;\n      })\n      .flatMap((mailbox) => {\n        // Handle search mode\n        if (mailbox.query && mailbox.query !== '') {\n          return Observable.concat(\n            // Always update malibox on location change.\n            Observable.of(mailboxSelect(mailbox, mailbox)),\n            Observable.of(threadsSearch({ query: mailbox.query })),\n          );\n        }\n        return Observable.concat(\n          // Always update malibox on location change.\n          Observable.of(mailboxSelect(mailbox, mailbox)),\n          Observable.of(threadList(false)),\n        );\n      });\n\nconst contactThreads: Epic<Action<string, Thread[]>, StoreState> = (action$, store, deps) =>\n action$.ofType(THREADS_SELECTED_CONTACT)\n  .filter(action => action.status === ActionStatus.Start)\n  .flatMap(action =>\n    listThreadsByEmail(action.meta, THREAD_LIST_SIZE)\n      .map(threads => threadsSelectedContact(action.meta, threads))\n      .catch((e: Error) => Observable.of(threadsSelectedContact(action.meta, e))\n      .takeUntil(\n        action$\n          .ofType(THREADS_SELECTED_CONTACT))\n          .filter(a => a.status === ActionStatus.Start),\n      ),\n  );\n\n// handle refreshing of list of threads from cache for selected mailbox\nconst updateMailboxThreads: Epic<Action<any, any>, StoreState, Deps> =\n  (action$, store, deps) =>\n     action$\n      .ofType(THREAD_LIST)\n      .filter(action => action.status === ActionStatus.Start)\n      .debounceTime(200, deps.scheduler)\n      .flatMap(() =>\n        mailboxList(store.getState().mailbox, store)\n          .takeUntil(action$.filter(isMailboxUpdateAction)),\n      );\n\n// handle selecting the correct thread to display\nconst locationChangeSelectThread:\n  Epic<Action<any, any>, StoreState>\n  = (action$, store) =>\n  action$\n    .ofType(LOCATION_CHANGE)\n    .map((action: any): string[] => {\n      return (action as LocationChangeAction).payload.pathname.toLowerCase().split('/');\n    })\n    // Do not handle outside boxes\n    .filter(split => (['drafts', 'sendlater', 'outbox'].indexOf(split[3]) === -1))\n    .map((split: string[]): string => {\n      if (split.length < 5) {\n        return '';\n      }\n\n      if (split[3] ===  'lists' && split.length < 6) {\n        return '';\n      }\n\n      if (split[1] === 'popout' && split[2] === 'threads') {\n        return split[3];\n      }\n\n      if (split[1] === 'mentions' || split[1] === 'public') {\n        return '';\n      }\n\n      return split[split.length - 1];\n    })\n    .flatMap((idString) => {\n\n      // Override account-id for box selection to select empty thread\n      let threadId = idString;\n      if (idString.startsWith('account')) {\n        threadId = '';\n      }\n\n      // This is when selecting otpimistic and in outbox\n      const actions = [\n        Observable.of(draftSelect('', null)),\n        Observable.of(threadSelect(threadId)),\n      ];\n\n      const { selectedSharedThread, sharedThreads } = store.getState();\n      const sharedThreadThreadId = selectedSharedThread && sharedThreads[selectedSharedThread] &&\n        sharedThreads[selectedSharedThread].data &&\n        sharedThreads[selectedSharedThread].data!.thread;\n      if (threadId && (threadId !== sharedThreadThreadId || !sharedThreadThreadId)) {\n        actions.push(Observable.of(sharedThreadSelectByThread(threadId)));\n      }\n\n      return Observable.merge(\n        ...actions,\n      );\n    });\n\n// thread select handling\nconst selectThread: Epic<Action<string|{}|undefined|null, Thread|Activity|null>, StoreState, Deps> =\n(action$, store, deps) =>\n  action$\n    .ofType(THREAD_SELECT)\n    .filter(action => action.status === ActionStatus.Start)\n    .debounceTime(200, deps.scheduler)\n    .flatMap((action: Action<string, Thread|null>) => {\n      // track if fetched from server, happens when not found in cache\n      let haveFreshThread = false;\n\n      const clearActions = Observable.merge(\n        Observable.of(threadSelect('', null)),\n        Observable.of(sharedThreadActivityClear(null)),\n      );\n\n      // Handle clearing if selecting nothing\n      if (action.meta === '') {\n        return clearActions;\n      }\n\n      return Observable.of(null)\n        .flatMap(() => {\n          const state = store.getState();\n          let foundThread = selectThreadSelector(state, action.meta);\n          const sharedThreadId = state.selectedSharedThread;\n          const sharedThread = sharedThreadId && selectSharedThread(state, sharedThreadId);\n          const isUserThread = sharedThread && state.me && state.me.data ?\n            state.me.data.id === sharedThread.user : undefined;\n\n          if (sharedThread && !isUserThread) {\n            foundThread = selectActivityThread(state, action.meta);\n          }\n\n          if (foundThread) {\n            return Observable.of(foundThread);\n          }\n\n          return Cache.get(Stores.Threads, action.meta);\n        })\n        .flatMap((thread?: Thread) => {\n          // fetch from server if not found\n          if (!thread && !!action.meta) {\n            return deps.threads.get(action.meta)\n              .flatMap((freshThread) => {\n                haveFreshThread = true;\n                return Cache.save(Stores.Threads, freshThread).map(() => freshThread);\n              })\n              .catch(() => Observable.of(undefined));\n          }\n\n          return Observable.of(thread);\n        })\n        .flatMap((thread?: Thread) => {\n          const state = store.getState();\n          if (!thread) {\n            return clearActions;\n          }\n\n          const sharedThreadId = state.selectedSharedThread;\n          const sharedThread = sharedThreadId &&\n            selectSharedThread(state, sharedThreadId);\n          const isUserThread = sharedThread && state.me && state.me.data\n            ? state.me.data.id === sharedThread.user : true;\n          const messages = isUserThread ? uniqBy(\n            thread.messages.concat(selectOptimisticMessagesForThread(state, thread.id)),\n            'rfcId',\n          ) : thread.messages;\n\n          // Recompute thread\n          const patchedThread: Thread = computeThread({ ...thread, messages });\n          const messageBodies = state.messageBodies[patchedThread.id];\n\n          if (!messageBodies && sharedThreadId && !isUserThread) {\n            return Observable.merge(\n              Observable.of(threadSelect(patchedThread.id, patchedThread)),\n              Observable.of(sharedThreadMessageBodiesFetch({\n                sharedThread: sharedThreadId,\n                thread: patchedThread,\n              })),\n              Observable.of(sharedThreadActivityClear(null)),\n            );\n          }\n\n          const selectedActivity = state.selectedActivity;\n          const selectedContactThread = state.selectedContactThread;\n          const activityTabShown = state.rightSidebar.tab === RightSidebarTab.Activity;\n          const conversationTabShown = state.rightSidebar.tab === RightSidebarTab.Contact\n            && state.rightSidebar.subTab === RightSidebarSubTab.Conversation;\n          const actions: Array<Observable<Action<any, any>>> = [\n            Observable.of(sharedThreadActivityClear(null)),\n            Observable.of(threadSelect(patchedThread.id, patchedThread)),\n            Observable.of(attachmentDownloadProgressClear(null)),\n            Observable.of(activitySelect(\n              activityTabShown && selectedActivity && thread\n              && thread.id === selectedActivity.thread ?\n              selectedActivity : undefined,\n            )),\n            Observable.of(contactThreadSelect(\n              conversationTabShown && selectedContactThread &&\n              thread.id === selectedContactThread.id ?\n                selectedContactThread : undefined,\n            )),\n          ];\n\n          // handle fresh thread (fetched from server)\n          if (haveFreshThread) {\n            actions.push(Observable.of(threadSingle(thread)));\n          }\n\n          const lastMessage = last(thread.messages);\n\n          const mailbox = store.getState().mailbox;\n          if (mailbox && lastMessage && !isDraftBox(mailbox.type)) {\n            actions.push(\n              Observable.of(contactSelect(lastMessage.sent ? lastMessage.to[0] : lastMessage.from)),\n            );\n          }\n\n          if (!messageBodies) {\n            actions.push(\n              Observable.of(messageBodiesFetch(patchedThread.id)),\n            );\n          }\n\n          const calendarEventMessages = thread.messages.filter(m => !!m.calendarEvent);\n          const latestCalendarEventMessage = last(calendarEventMessages);\n          if (latestCalendarEventMessage && latestCalendarEventMessage.calendarEvent) {\n            actions.push(\n              Observable.of(calendarEventGet(latestCalendarEventMessage.calendarEvent)),\n            );\n          } else {\n            actions.push(\n              Observable.of(calendarEventGet('', null)),\n            );\n          }\n\n          return Observable.merge(\n            ...actions,\n          );\n        });\n    });\n\nexport const searchThreads: Epic<\n  Action<any, ThreadSearchPayload|Mailbox|Thread[]>, StoreState\n> = (action$, store, deps) =>\n  action$\n    .ofType(THREADS_SEARCH)\n    .filter(action => (action.status === ActionStatus.Start))\n    .flatMap((action) => {\n      const mailbox = store.getState().mailbox;\n      const isOffline = !store.getState().isOnline;\n\n      // Refresh threads list when a user is typing in the search box\n      // and backspaces until the search box is empty.\n      if (!action.meta || action.meta.query === '') {\n        return Observable.concat(\n          Observable.of(mailboxSelect(mailbox, mailbox)),\n          Observable.of(threadList(false)),\n        );\n      }\n\n      const mailAccounts = store.getState().accounts\n        .filter(a => a.type !== AccountType.Alias);\n\n      // Use local search if SearchDB is enabled\n      let searchMechanisms = getSearchDbConfig().enabled\n      ? [newLocalThreadSearch(mailbox)\n          .catch((e) => {\n            // Log errors where searchDB fetch has failed\n            // tslint:disable-next-line:no-console\n            console.error(e);\n            captureException(e);\n\n            // But allow empty to work in order to not fail backup mechanisms\n            return Observable.of([]);\n          })\n          .map(r => ({ provider: false, threads: r }))]\n      : [];\n\n      // Add provider search on complete search\n      if (mailbox.providerSearch) {\n        searchMechanisms = searchMechanisms.concat(\n          providerThreadSearch(deps.threads, mailbox)\n            .catch((e) => {\n              // Log errors where searchDB fetch has failed\n              // tslint:disable-next-line:no-console\n              console.error(e);\n              captureException(e);\n\n              // Do backup if offline and no searchdb config\n              if (isOffline && !getSearchDbConfig().enabled) {\n                const backupSearches = mailAccounts.map((a) => {\n                  return localThreadSearch({\n                    ...mailbox,\n                    account: a.id,\n                  })\n                  .catch(err => []);\n                });\n\n                return Observable\n                  .zip(...backupSearches)\n                  .map(results => flatten(results));\n              }\n\n              // But allow empty to work in order to not fail backup mechanisms\n              return Observable.of([]);\n            })\n            .map((r => ({ provider: true, threads: r }))),\n        );\n\n        // Trigger Old Search mechanism for IMAP accounts in place of provider search\n        mailAccounts\n          .filter((a) => {\n            if (mailbox.account) {\n              return mailbox.account === a.id;\n            }\n\n            return [AccountType.IMAP, AccountType.iCloud].indexOf(a.type) > -1;\n          })\n          .forEach((a) => {\n            const oldAccountResults = localThreadSearch({\n                ...mailbox,\n                account: a.id,\n              })\n              .catch((e) => {\n                // Log errors where searchDB fetch has failed\n                // tslint:disable-next-line:no-console\n                console.error(e);\n                captureException(e);\n\n                // But allow empty to work in order to not fail backup mechanisms\n                return Observable.of([]);\n              })\n              .map(r => ({ provider: false, threads: r }));\n            searchMechanisms.push(oldAccountResults);\n            return;\n          });\n      }\n\n      return Observable.merge(...searchMechanisms)\n        .map((payload: ThreadSearchPayload) => {\n          const mailboxQuery = store.getState().mailbox.query;\n          return {\n            ...payload,\n            threads: payload.threads.map(thread => ({ ...thread, query: mailboxQuery })),\n          };\n        })\n        .map((payload: ThreadSearchPayload) => threadsSearch(action.meta, payload))\n        .takeUntil(\n          action$.ofType(THREADS_SEARCH)\n            .filter(a => a.status === ActionStatus.Start),\n        );\n    });\n\nexport const fetchThread: Epic<Action<string, Thread>, StoreState> = (action$, store) =>\n  action$\n    .ofType(THREAD_FETCH)\n    .filter(action => action.status === ActionStatus.Start)\n    .flatMap(action =>\n      Cache.get(Stores.Threads, action.meta)\n        .map((thread: Thread) => {\n          if (!thread) {\n            throw new Error('Thread not found in cache');\n          }\n\n          return threadFetch(action.meta, thread);\n        })\n        .catch((e: Error) => Observable.of(threadFetch(action.meta, e))),\n    );\n\n// Handles thread patches. Called from ThreadCommitSubmit, should not be called directly\nconst updateThread: Epic<Action<Commit, Thread>, StoreState> = (action$, store) => {\n  return action$\n    .ofType(THREAD_UPDATE)\n    .filter(action => action.status === ActionStatus.Start)\n    .flatMap((action: any) => {\n      const state = store.getState();\n      const commit: Commit = action.meta;\n      const foundThread = selectThreadSelector(state, commit.resourceId);\n      return (!!foundThread\n          ? Observable.of(foundThread)\n          : Cache.get(Stores.Threads, commit.resourceId)\n        )\n        .flatMap((thread: Thread) => {\n          if (!thread) {\n            throw new Error('Thread not found in cache');\n          }\n\n          const updatedThread = computeThread(patched(thread, commit));\n\n          // Handle updates with computed thread\n          const optimisticMessages: Message[] = selectOptimisticMessagesForThread(\n            store.getState(),\n            updatedThread.id,\n          );\n\n          // Append any necessary optimistic messages\n          // TODO(SHIN): Implement deduplication using rfcId\n          if (optimisticMessages.length) {\n            const allMessages = uniqBy(updatedThread.messages.concat(optimisticMessages), 'rfcId');\n            updatedThread.messages = allMessages;\n          }\n\n          return Cache\n            .save(Stores.Threads, updatedThread)\n            .flatMap(() => Observable.of(threadUpdate(commit, updatedThread)));\n        });\n    });\n};\n\n// Thread updates should update selected thread\nexport const selectedThreadUpdated: Epic<Action<Commit|string, MessageBody[]>, StoreState> =\n  (action$, store) =>\n    action$\n      .ofType(THREAD_UPDATE)\n      .filter(action => action.status === ActionStatus.Success)\n      .filter((action: any) => {\n        const state = store.getState();\n        const existingThread = state.selectedThread;\n        return existingThread && matchesThread(existingThread, action.payload) || false;\n      })\n      .map(action => messageBodiesFetch(action.payload.id));\n\n// Thread updates should update selected thread\nexport const selectedThreadSingle: Epic<Action<Thread|string, MessageBody[]>, StoreState> =\n  (action$, store) =>\n    action$\n      .ofType(THREAD_SINGLE)\n      .filter(action => action.status === ActionStatus.Start)\n      .filter((action: any) => {\n        const state = store.getState();\n        const existingThread = state.selectedThread;\n        return existingThread && matchesThread(existingThread, action.meta) || false;\n      })\n      .map((action: any) => {\n        return messageBodiesFetch(action.meta.id);\n      });\n\n// Handles emitting thread update events\nexport const updateThreads: Epic<Action<\n  ThreadCommitMeta|Commit, Thread|undefined\n>, StoreState, Deps> = (action$, store, deps) => {\n  return action$\n    .ofType(THREAD_COMMITS_SUBMIT)\n    .filter(action => action.status === ActionStatus.Start)\n    .filter((action: any) => {\n      const state = store.getState();\n      return state.selectedIds.size > 0 || !!action.meta.singleResource ||\n        !!state.threadSwipeId ||\n        !!(state.selectedThread && state.selectedThread.id);\n    })\n    // Track Thread Operations and Read/Unread\n    .do((action: Action<ThreadCommitMeta, Thread>) => {\n\n      // Track Thread Operation Events\n      if (action.meta.box) {\n        recordEvent(UserEvents.ThreadOperation, { box: action.meta.box });\n      } else if (action.meta.when) {\n        recordEvent(UserEvents.ThreadOperation, { box: ThreadBox.Later });\n      } else if (action.meta.label) {\n        recordEvent(UserEvents.ThreadOperation, { box: ThreadBox.List });\n      }\n\n      // Track Read Events\n      if (action.meta.read !== undefined) {\n        action.meta.read\n          ? recordEvent(UserEvents.ThreadRead)\n          : recordEvent(UserEvents.ThreadUnread);\n      }\n\n      // Track Mute Events\n      if (action.meta.muted !== undefined) {\n        action.meta.muted\n          ? recordEvent(UserEvents.ThreadMuted)\n          : recordEvent(UserEvents.ThreadUnmuted);\n      }\n    })\n    .flatMap((action: Action<ThreadCommitMeta, null>) => {\n      const state = store.getState();\n      const selectedThreadId = state.selectedThread && state.selectedThread.id;\n      let threadIds = action.meta.singleResource\n        ? [action.meta.singleResource]\n        : Array.from(state.selectedIds.keys());\n\n      // Add selectedThreadId if threadIds length does not exist\n      if (!action.meta.singleResource && selectedThreadId && threadIds.length === 0) {\n        threadIds = [selectedThreadId];\n      }\n\n      // Do single resource if swipe was activated\n      if (state.threadSwipeId) {\n        threadIds = [state.threadSwipeId];\n      }\n\n      const threadUpdates = threadIds.map((id: string) => {\n        const foundThread = selectThreadSelector(state, id);\n        return (!!foundThread ? Observable.of(foundThread) : Cache.get(Stores.Threads, id))\n          .map((thread: Thread) => createThreadCommit(thread, action.meta))\n          .filter((commit: Commit) => commit !== undefined)\n          .map(commit => ({ ...commit, created: deps.now() }))\n          .flatMap((commit: Commit) =>\n            submitCommit(commit).map(() => {\n              if (commit.method === 'DELETE') {\n                return threadDelete(commit.resourceId);\n              }\n              return threadUpdate(commit) as Action<any, any>;\n            }));\n      });\n\n      // Unset swipe id if exists\n      if (state.threadSwipeId) {\n        threadUpdates.unshift(Observable.of(threadSwipeIdSet(null)));\n      }\n\n      threadUpdates.unshift(Observable.of(threadCommitsSubmit(action.meta, null)));\n\n      return Observable.merge(...threadUpdates);\n    });\n};\n\nexport const draftSendUpdateSelectedThread: Epic<Action<any, any>, StoreState> = (action$, store) =>\n    action$\n      .ofType(DRAFT_SEND)\n      .filter((action) => {\n        if (action.status !== ActionStatus.Success) {\n          return false;\n        }\n\n        const existingThread = store.getState().selectedThread;\n        if (existingThread && existingThread.id === action.payload.threadV2) {\n          return true;\n        }\n\n        return false;\n      })\n      .map(action => threadSelect(action.payload.threadV2));\n\nexport const selectContactThread:\n  Epic<Action<Activity|undefined|Thread, Activity|Thread>, StoreState> = action$ =>\n  action$\n    .ofType(CONTACT_THREAD_SELECT)\n    .filter(action => action.status === ActionStatus.Start)\n    .filter(action => action.meta !== undefined)\n    .flatMap(action =>\n      Observable.of(activitySelect(undefined))\n        .takeUntil(action$.ofType(CONTACT_THREAD_SELECT)),\n    );\n\nexport const disableTrackEpic: Epic<\n  Action<string|Error|null, Thread|null>, StoreState, Deps\n> = (action$, store, deps) =>\n  action$\n    .ofType(THREAD_DISABLE_TRACK)\n    .filter(action => action.status === ActionStatus.Start)\n    .flatMap((action: Action<string, Thread>) =>\n      deps.threads\n        .disableTrack(action.meta)\n        .flatMap(r => Observable.merge(\n          Observable.of(threadDisableTrack(action.meta, r)),\n          Observable.of(toastSet(\n            new ConfirmationError(\n              'Tracking has been disabled for this conversation',\n              true,\n              ConfirmationPositon.TopCenter,\n            ),\n          ),\n        )))\n        .catch((e: Error) => {\n          return Observable.merge(\n            Observable.of(threadDisableTrack(action.meta, e)),\n            Observable.of(toastSet(new Error(`Failed to update tracking settings: ${e.message}`))),\n          );\n        }));\n\nexport default [\n  updateMailboxThreads,\n  locationChangeUpdateMailbox,\n  locationChangeSelectThread,\n  selectedThreadUpdated,\n  selectedThreadSingle,\n  selectThread,\n  updateThread,\n  updateThreads,\n  contactThreads,\n  searchThreads,\n  fetchThread,\n  draftSendUpdateSelectedThread,\n  selectContactThread,\n  mailboxSelectEpic,\n  draftSendAndArchiveEpic,\n  disableTrackEpic,\n];\n"]}]}