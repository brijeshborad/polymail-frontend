{"remainingRequest":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/node_modules/ts-loader/index.js??ref--6-1!/Users/andrewsamboy/Desktop/Git/polymail/webapp/src/ducks/drafts.ts","dependencies":[{"path":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/src/ducks/drafts.ts","mtime":1675280254048},{"path":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/node_modules/cache-loader/dist/cjs.js","mtime":1675365393858},{"path":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/node_modules/ts-loader/index.js","mtime":1675365391714}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:dmFyIF9fYXNzaWduID0gKHRoaXMgJiYgdGhpcy5fX2Fzc2lnbikgfHwgZnVuY3Rpb24gKCkgewogICAgX19hc3NpZ24gPSBPYmplY3QuYXNzaWduIHx8IGZ1bmN0aW9uKHQpIHsKICAgICAgICBmb3IgKHZhciBzLCBpID0gMSwgbiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgICAgICAgcyA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgICAgZm9yICh2YXIgcCBpbiBzKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHMsIHApKQogICAgICAgICAgICAgICAgdFtwXSA9IHNbcF07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0OwogICAgfTsKICAgIHJldHVybiBfX2Fzc2lnbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9Owp2YXIgX2EsIF9iLCBfYywgX2QsIF9lLCBfZiwgX2csIF9oLCBfaiwgX2ssIF9sLCBfbSwgX28sIF9wLCBfcSwgX3IsIF9zOwppbXBvcnQgeyBjcmVhdGVTZWxlY3RvciB9IGZyb20gJ0BzcmMvbGliL3NlbGVjdG9yJzsKaW1wb3J0IHsgb3JkZXJCeSwga2V5QnksIGZpbHRlciwgZm9ySW4sIGxhc3QsIHZhbHVlcywgY29tcGFjdCwgZmluZEluZGV4LCB1bmlxQnkgfSBmcm9tICdsb2Rhc2gnOwppbXBvcnQgdXBkYXRlIGZyb20gJ2ltbXV0YWJpbGl0eS1oZWxwZXInOwppbXBvcnQgeyBjcmVhdGUsIGNyZWF0ZUFjdGlvbiB9IGZyb20gJ0BzcmMvbGliL3JlZHV4JzsKaW1wb3J0IHsgdG9NZXNzYWdlLCB0b01lc3NhZ2VCb2R5LCB0b1RocmVhZCwgaXNEcmFmdFNlbmRpbmcsIGlzRHJhZnRPdXRib3gsIH0gZnJvbSAnQHNyYy9saWIvZHJhZnQnOwppbXBvcnQgeyByZXNvdXJjZVBlbmRpbmcsIHJlc291cmNlT2ssIHJlc291cmNlRmFpbGVkIH0gZnJvbSAnQHNyYy9saWIvcmVzb3VyY2UnOwppbXBvcnQgeyBSZXNvdXJjZVN0YXR1cywgRHJhZnRTdGF0dXMsIH0gZnJvbSAnQHNyYy90eXBlcyc7CmltcG9ydCB7IGZudjFhMzIgfSBmcm9tICdAc3JjL2xpYi9jcnlwdCc7CmZ1bmN0aW9uIGNyZWF0ZU5lc3Rpbmcoc3RhdGUsIGRyYWZ0KSB7CiAgICB2YXIgX2E7CiAgICBpZiAoc3RhdGUuZHJhZnRzW2RyYWZ0XSkgewogICAgICAgIHJldHVybiBzdGF0ZTsKICAgIH0KICAgIHJldHVybiB1cGRhdGUoc3RhdGUsIHsKICAgICAgICBkcmFmdHM6IChfYSA9IHt9LAogICAgICAgICAgICBfYVtkcmFmdF0gPSB7CiAgICAgICAgICAgICAgICAkc2V0OiByZXNvdXJjZVBlbmRpbmcoKSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2EpLAogICAgfSk7Cn0KZnVuY3Rpb24gY3JlYXRlTWV0YU5lc3Rpbmcoc3RhdGUsIGRyYWZ0KSB7CiAgICB2YXIgX2E7CiAgICBpZiAoc3RhdGUuYXR0YWNobWVudE1ldGFzW2RyYWZ0XSkgewogICAgICAgIHJldHVybiBzdGF0ZTsKICAgIH0KICAgIHJldHVybiB1cGRhdGUoc3RhdGUsIHsKICAgICAgICBhdHRhY2htZW50TWV0YXM6IChfYSA9IHt9LAogICAgICAgICAgICBfYVtkcmFmdF0gPSB7CiAgICAgICAgICAgICAgICAkc2V0OiB7fSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2EpLAogICAgfSk7Cn0KZXhwb3J0IHZhciBEUkFGVF9TRUxFQ1QgPSAoX2EgPSBjcmVhdGUoJ0RSQUZUX1NFTEVDVCcsIHsKICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChzdGF0ZSwgbWV0YSwgcGF5bG9hZCkgewogICAgICAgIHJldHVybiB1cGRhdGUoc3RhdGUsIHsKICAgICAgICAgICAgc2VsZWN0ZWREcmFmdDogeyAkc2V0OiBwYXlsb2FkID09PSBudWxsID8gdW5kZWZpbmVkIDogcGF5bG9hZCB9LAogICAgICAgIH0pOwogICAgfSwKfSksIF9hLnR5cGUpLCBkcmFmdFNlbGVjdCA9IF9hLmFjdGlvbiwgZHJhZnRTZWxlY3RSZWR1Y2VyID0gX2EucmVkdWNlcjsKZXhwb3J0IHZhciBEUkFGVF9GRVRDSCA9IChfYiA9IGNyZWF0ZSgnRFJBRlRfRkVUQ0gnLCB7CiAgICBzdGFydDogZnVuY3Rpb24gKHN0YXRlLCBtZXRhKSB7CiAgICAgICAgdmFyIF9hOwogICAgICAgIHJldHVybiAhKHN0YXRlLmRyYWZ0c1ttZXRhXSAmJiBzdGF0ZS5kcmFmdHNbbWV0YV0uZGF0YSkKICAgICAgICAgICAgPyB1cGRhdGUoY3JlYXRlTmVzdGluZyhzdGF0ZSwgbWV0YSksIHsKICAgICAgICAgICAgICAgIGRyYWZ0czogKF9hID0ge30sCiAgICAgICAgICAgICAgICAgICAgX2FbbWV0YV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNldDogUmVzb3VyY2VTdGF0dXMuTG9hZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIF9hKSwKICAgICAgICAgICAgfSkKICAgICAgICAgICAgOiBzdGF0ZTsKICAgIH0sCiAgICBzdWNjZXNzOiBmdW5jdGlvbiAoc3RhdGUsIG1ldGEsIHBheWxvYWQpIHsKICAgICAgICB2YXIgX2E7CiAgICAgICAgcmV0dXJuIHVwZGF0ZShjcmVhdGVOZXN0aW5nKHN0YXRlLCBtZXRhKSwgewogICAgICAgICAgICBkcmFmdHM6IChfYSA9IHt9LAogICAgICAgICAgICAgICAgX2FbbWV0YV0gPSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzZXQ6IFJlc291cmNlU3RhdHVzLk9rLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgICAgICAgICAkc2V0OiBwYXlsb2FkLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgX2EpLAogICAgICAgIH0pOwogICAgfSwKICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChzdGF0ZSwgbWV0YSwgZXJyb3IpIHsKICAgICAgICB2YXIgX2E7CiAgICAgICAgcmV0dXJuIHVwZGF0ZShjcmVhdGVOZXN0aW5nKHN0YXRlLCBtZXRhKSwgewogICAgICAgICAgICBkcmFmdHM6IChfYSA9IHt9LAogICAgICAgICAgICAgICAgX2FbbWV0YV0gPSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzZXQ6IFJlc291cmNlU3RhdHVzLkZhaWx1cmUsCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogewogICAgICAgICAgICAgICAgICAgICAgICAkc2V0OiBlcnJvciwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIF9hKSwKICAgICAgICB9KTsKICAgIH0sCn0pLCBfYi50eXBlKSwgZHJhZnRGZXRjaCA9IF9iLmFjdGlvbiwgZHJhZnRGZXRjaFJlZHVjZXIgPSBfYi5yZWR1Y2VyOwpleHBvcnQgdmFyIERSQUZUX0xJU1QgPSAoX2MgPSBjcmVhdGUoJ0RSQUZUX0xJU1QnLCB7CiAgICBzdWNjZXNzOiBmdW5jdGlvbiAoc3RhdGUsIG1ldGEsIHBheWxvYWQpIHsKICAgICAgICAvLyBoYW5kbGUgbm8gZHJhZnRzIGZvdW5kCiAgICAgICAgaWYgKHBheWxvYWQubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICB9CiAgICAgICAgLy8gbWFrZSB1cGRhdGVzIG9iamVjdAogICAgICAgIHZhciB1cGRhdGVzID0gcGF5bG9hZC5tYXAoZnVuY3Rpb24gKGRyYWZ0KSB7IHJldHVybiAoewogICAgICAgICAgICAkc2V0OiB7CiAgICAgICAgICAgICAgICBzdGF0dXM6IFJlc291cmNlU3RhdHVzLk9rLAogICAgICAgICAgICAgICAgZGF0YTogZHJhZnQsCiAgICAgICAgICAgIH0sCiAgICAgICAgfSk7IH0pOwogICAgICAgIC8vIHVwZGF0ZSBzdGF0ZQogICAgICAgIHJldHVybiB1cGRhdGUoc3RhdGUsIHsKICAgICAgICAgICAgZHJhZnRzOiBrZXlCeSh1cGRhdGVzLCBmdW5jdGlvbiAoZWFjaFVwZGF0ZSkgeyByZXR1cm4gZWFjaFVwZGF0ZS4kc2V0LmRhdGEuaWQ7IH0pLAogICAgICAgIH0pOwogICAgfSwKfSksIF9jLnR5cGUpLCBkcmFmdExpc3QgPSBfYy5hY3Rpb24sIGRyYWZ0TGlzdFJlZHVjZXIgPSBfYy5yZWR1Y2VyOwovLyBUT0RPKFNISU4pOiBGaWd1cmUgb3V0IGVycm9yIGNhc2VzIGZvciBvcHRpbWlzdGljIHBhdGNoZXMKLy8gVE9ETyhTSElOKTogQ3JlYXRlIHNlcGFyYXRlIGFjdGlvbi9lcGljIGZvciB1cGRhdGluZyBkcmFmdCB3aXRoCi8vIHRlbXBsYXRlIHRoYXQgdGFrZXMgY2FyZSBvZiBhdHRhY2htZW50cwpleHBvcnQgdmFyIERSQUZUX1VQREFURSA9IChfZCA9IGNyZWF0ZSgnRFJBRlRfVVBEQVRFJywgewogICAgc3RhcnQ6IGZ1bmN0aW9uIChzdGF0ZSwgbWV0YSkgewogICAgICAgIHZhciBfYTsKICAgICAgICByZXR1cm4gdXBkYXRlKGNyZWF0ZU5lc3Rpbmcoc3RhdGUsIG1ldGEuaWQpLCB7CiAgICAgICAgICAgIGRyYWZ0czogKF9hID0ge30sCiAgICAgICAgICAgICAgICBfYVttZXRhLmlkXSA9IHsKICAgICAgICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzZXQ6IG1ldGEsCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBfYSksCiAgICAgICAgfSk7CiAgICB9LAogICAgc3VjY2VzczogZnVuY3Rpb24gKHN0YXRlLCBtZXRhLCBwYXlsb2FkKSB7CiAgICAgICAgdmFyIF9hLCBfYjsKICAgICAgICAvLyBIYW5kbGUgc3BlY2lhbCBjYXNlIGZvciByZWdlbmVyYXRpb24KICAgICAgICB2YXIgc2VsZWN0ZWRUaHJlYWQgPSBzdGF0ZS5zZWxlY3RlZFRocmVhZDsKICAgICAgICB2YXIgb3B0aW1pc3RpY0tleSA9ICI8IiArIHBheWxvYWQuaWQgKyAiQHBvbHltYWlsLmlvPiI7CiAgICAgICAgdmFyIHRocmVhZE1hdGNoZXMgPSBzZWxlY3RlZFRocmVhZCAmJgogICAgICAgICAgICBbb3B0aW1pc3RpY0tleSwgcGF5bG9hZC50aHJlYWRWMl0uaW5kZXhPZihzZWxlY3RlZFRocmVhZC5pZCkgPiAtMTsKICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gdGhyZWFkTWF0Y2hlcyAmJiBpc0RyYWZ0U2VuZGluZyhwYXlsb2FkKSAmJiBwYXlsb2FkLmF0dGFjaG1lbnRzLmxlbmd0aDsKICAgICAgICBpZiAoc2hvdWxkVXBkYXRlICYmIHNlbGVjdGVkVGhyZWFkKSB7CiAgICAgICAgICAgIHZhciBvcHRpbWlzdGljID0gdG9NZXNzYWdlKHBheWxvYWQsIHN0YXRlLmFjY291bnRzKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZWRNZXNzYWdlcyA9IHVuaXFCeShbb3B0aW1pc3RpY10uY29uY2F0KHNlbGVjdGVkVGhyZWFkLm1lc3NhZ2VzKSwgJ3JmY0lkJyk7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGUoY3JlYXRlTmVzdGluZyhzdGF0ZSwgbWV0YS5pZCksIHsKICAgICAgICAgICAgICAgIGRyYWZ0czogKF9hID0ge30sCiAgICAgICAgICAgICAgICAgICAgX2FbbWV0YS5pZF0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHsgJHNldDogcGF5bG9hZCB9LAogICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHsgJHNldDogUmVzb3VyY2VTdGF0dXMuT2sgfSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIF9hKSwKICAgICAgICAgICAgICAgIHNlbGVjdGVkVGhyZWFkOiB7CiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZXM6IHsgJHNldDogdXBkYXRlZE1lc3NhZ2VzIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVwZGF0ZShjcmVhdGVOZXN0aW5nKHN0YXRlLCBtZXRhLmlkKSwgewogICAgICAgICAgICBkcmFmdHM6IChfYiA9IHt9LAogICAgICAgICAgICAgICAgX2JbbWV0YS5pZF0gPSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YTogeyAkc2V0OiBwYXlsb2FkIH0sCiAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiB7ICRzZXQ6IFJlc291cmNlU3RhdHVzLk9rIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgX2IpLAogICAgICAgIH0pOwogICAgfSwKfSksIF9kLnR5cGUpLCBkcmFmdFVwZGF0ZSA9IF9kLmFjdGlvbiwgZHJhZnRVcGRhdGVSZWR1Y2VyID0gX2QucmVkdWNlcjsKLy8gSEFDSyhTSElOKTogSW1tZWRpYXRlbHkgZGVzZWxlY3RzIHRocmVhZCAmIGlkcyBvbiBuZXctZHJhZnQgY3JlYXRpb24gdG8gcHJldmVudCBpbnRlcm1lZGlhdGUKLy8gc3RhdGUgd2hlcmUgYSByZXBseS9ubyBtZXNzYWdlIHNlbGVjdGlvbiBzaG93cyB1cC4KZXhwb3J0IHZhciBEUkFGVF9DUkVBVEUgPSAoX2UgPSBjcmVhdGUoJ0RSQUZUX0NSRUFURScsIHsKICAgIHN0YXJ0OiBmdW5jdGlvbiAoc3RhdGUsIG1ldGEpIHsKICAgICAgICB2YXIgX2E7CiAgICAgICAgcmV0dXJuIHVwZGF0ZShzdGF0ZSwgewogICAgICAgICAgICBkcmFmdHM6IHsKICAgICAgICAgICAgICAgICRtZXJnZTogKF9hID0ge30sIF9hW21ldGEuaWRdID0gcmVzb3VyY2VPayhtZXRhKSwgX2EpLAogICAgICAgICAgICB9LAogICAgICAgICAgICBzZWxlY3RlZERyYWZ0OiB7ICRzZXQ6IG1ldGEuaWQgfSwKICAgICAgICAgICAgc2VsZWN0ZWRUaHJlYWQ6IHsgJHNldDogISFtZXRhLnRocmVhZFYyID8gc3RhdGUuc2VsZWN0ZWRUaHJlYWQgOiB1bmRlZmluZWQgfSwKICAgICAgICAgICAgc2VsZWN0ZWRJZHM6IHsgJHNldDogISFtZXRhLnRocmVhZFYyID8gc3RhdGUuc2VsZWN0ZWRJZHMgOiBuZXcgTWFwKCkgfSwKICAgICAgICB9KTsKICAgIH0sCn0pLCBfZS50eXBlKSwgZHJhZnRDcmVhdGUgPSBfZS5hY3Rpb24sIGRyYWZ0Q3JlYXRlUmVkdWNlciA9IF9lLnJlZHVjZXI7CmV4cG9ydCB2YXIgRFJBRlRfQ1JFQVRFX0NPTkZJR1VSQVRJT04gPSAnRFJBRlRfQ1JFQVRFX0NPTkZJR1VSQVRJT04nOwpleHBvcnQgdmFyIGRyYWZ0Q3JlYXRlQ29uZmlndXJhdGlvbiA9IGNyZWF0ZUFjdGlvbihEUkFGVF9DUkVBVEVfQ09ORklHVVJBVElPTik7Ci8vIEJyb2FkY2FzdCBhY3Rpb25zIHVzZWQgdG8gcm91dGUgc3VjY2VzcyBjYXNlcyB0aHJvdWdoIHdvcmtlcnMKZXhwb3J0IHZhciBEUkFGVF9TRU5EX0JST0FEQ0FTVCA9ICdEUkFGVF9TRU5EX0JST0FEQ0FTVCc7CmV4cG9ydCB2YXIgZHJhZnRTZW5kQnJvYWRjYXN0ID0gY3JlYXRlQWN0aW9uKERSQUZUX1NFTkRfQlJPQURDQVNUKTsKZXhwb3J0IHZhciBEUkFGVF9VUERBVEVfQlJPQURDQVNUID0gJ0RSQUZUX1VQREFURV9CUk9BRENBU1QnOwpleHBvcnQgdmFyIGRyYWZ0VXBkYXRlQnJvYWRjYXN0ID0gY3JlYXRlQWN0aW9uKERSQUZUX1VQREFURV9CUk9BRENBU1QpOwovLyBUT0RPKFNISU4pOiBGaWd1cmUgb3V0IGVycm9yIGNhc2VzIGZvciBvcHRpbWlzdGljIHBhdGNoZXMKLy8gVE9ETyhTSElOKTogVXBkYXRlIHNlbGVjdGVkRHJhZnQgdG8gYmUgY2xlYXJlZCBvbiBsb2NhdGlvbiBjaGFuZ2UgZm9yIHRocmVhZApleHBvcnQgdmFyIERSQUZUX1NFTkQgPSAoX2YgPSBjcmVhdGUoJ0RSQUZUX1NFTkQnLCB7CiAgICBzdGFydDogZnVuY3Rpb24gKHN0YXRlLCBtZXRhKSB7CiAgICAgICAgdmFyIF9hOwogICAgICAgIHJldHVybiB1cGRhdGUoc3RhdGUsIHsKICAgICAgICAgICAgZHJhZnRzOiAoX2EgPSB7fSwKICAgICAgICAgICAgICAgIF9hW21ldGEuZHJhZnQuaWRdID0gewogICAgICAgICAgICAgICAgICAgIGluY3JlbWVudENvdW50OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzZXQ6IDAsCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBfYSksCiAgICAgICAgfSk7CiAgICB9LAogICAgc3VjY2VzczogZnVuY3Rpb24gKHN0YXRlLCBtZXRhLCBwYXlsb2FkKSB7CiAgICAgICAgdmFyIF9hOwogICAgICAgIHZhciBpc1NjaGVkdWxlZCA9IHBheWxvYWQuc3RhdHVzID09PSBEcmFmdFN0YXR1cy5TY2hlZHVsZWQ7CiAgICAgICAgLy8gSEFDSyhTSElOKTogV2UgYWx3YXlzIGluc2VydCBvcHRpbWlzdGljIHRocmVhZCBpbnRvIG1haWxib3hUaHJlYWRzIHNpbmNlIHRoZSBvcHRpbWlzdGljCiAgICAgICAgLy8gdGhyZWFkIG5lZWRzIHRvIGJlIHF1ZXJ5YWJsZSB2aWEgc3RhdGUgc2VsZWN0b3IgJiBzaW5jZSBpdCBnZXRzIGZpbHRlcmVkIG91dCBvZiBEYXRhU291cmNlCiAgICAgICAgdmFyIGluc2VydE9wdGltaXN0aWMgPSBzdGF0ZS5tYWlsYm94VGhyZWFkcy5kYXRhICYmICFtZXRhLmRyYWZ0LnRocmVhZFYyICYmICFpc1NjaGVkdWxlZDsKICAgICAgICB2YXIgdXBkYXRlTWFpbGJveFRocmVhZCA9IGluc2VydE9wdGltaXN0aWMgJiYgewogICAgICAgICAgICBtYWlsYm94VGhyZWFkczogewogICAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgICAgICRwdXNoOiBbdG9UaHJlYWQobWV0YS5kcmFmdCwgc3RhdGUuYWNjb3VudHMpXSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0sCiAgICAgICAgfSB8fCB7fTsKICAgICAgICB2YXIgdG9nZ2xlQXJjaGl2ZUNvdW50ID0gMDsKICAgICAgICBpZiAobWV0YS50b2dnbGVBcmNoaXZlKSB7CiAgICAgICAgICAgIHRvZ2dsZUFyY2hpdmVDb3VudCA9IHRvZ2dsZUFyY2hpdmVDb3VudCArIDE7CiAgICAgICAgfQogICAgICAgIGlmIChzdGF0ZS5wcmVmZXJlbmNlcy5zZW5kQW5kQXJjaGl2ZSkgewogICAgICAgICAgICB0b2dnbGVBcmNoaXZlQ291bnQgPSB0b2dnbGVBcmNoaXZlQ291bnQgKyAxOwogICAgICAgIH0KICAgICAgICB2YXIgc2hvdWxkQXJjaGl2ZSA9IHRvZ2dsZUFyY2hpdmVDb3VudCAlIDIgIT09IDA7CiAgICAgICAgLy8gY29uc3Qgb3B0aW1pc3RpY0tleSA9IGA8JHtwYXlsb2FkLmlkfUBwb2x5bWFpbC5pbz5gOwogICAgICAgIHZhciBuZXdEcmFmdE1hdGNoZXMgPSAhcGF5bG9hZC50aHJlYWRWMiAmJgogICAgICAgICAgICBwYXlsb2FkLmlkID09PSBzdGF0ZS5zZWxlY3RlZERyYWZ0OwogICAgICAgIHZhciBkcmFmdFJlc291cmNlID0gc3RhdGUuZHJhZnRzW21ldGEuZHJhZnQuaWRdOwogICAgICAgIHZhciBpbmNyZW1lbnRDb3VudCA9IGRyYWZ0UmVzb3VyY2UgJiYgZHJhZnRSZXNvdXJjZS5pbmNyZW1lbnRDb3VudCB8fCAwOwogICAgICAgIHJldHVybiB1cGRhdGUoc3RhdGUsIF9fYXNzaWduKHsgZHJhZnRzOiAoX2EgPSB7fSwKICAgICAgICAgICAgICAgIF9hW21ldGEuZHJhZnQuaWRdID0gewogICAgICAgICAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICAgICAgICAgICAgJHNldDogcGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGluY3JlbWVudENvdW50OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzZXQ6IGluY3JlbWVudENvdW50ICsgMSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIF9hKSwgc2VsZWN0ZWRUaHJlYWQ6IHsKICAgICAgICAgICAgICAgICRzZXQ6IG5ld0RyYWZ0TWF0Y2hlcyAmJiAhaXNTY2hlZHVsZWQgJiYgIXN0YXRlLnNlbGVjdGVkVGhyZWFkICYmICFzaG91bGRBcmNoaXZlCiAgICAgICAgICAgICAgICAgICAgPyB0b1RocmVhZChwYXlsb2FkLCBzdGF0ZS5hY2NvdW50cykKICAgICAgICAgICAgICAgICAgICA6IHN0YXRlLnNlbGVjdGVkVGhyZWFkLAogICAgICAgICAgICB9IH0sIHVwZGF0ZU1haWxib3hUaHJlYWQpKTsKICAgIH0sCiAgICBmYWlsdXJlOiBmdW5jdGlvbiAoc3RhdGUsIG1ldGEsIGVycm9yKSB7CiAgICAgICAgdmFyIF9hOwogICAgICAgIC8vIEhhbmRsZSBlcnJvciBzZXR0aW5nCiAgICAgICAgdmFyIGVycm9yTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgICAgdmFyIGVycm9yc09iamVjdCA9IGVycm9yLmVycm9yczsKICAgICAgICB2YXIgZXJyb3JzID0gZXJyb3JzT2JqZWN0ICYmIHZhbHVlcyhlcnJvcnNPYmplY3QpOwogICAgICAgIGlmIChlcnJvcnMgJiYgISFlcnJvcnMubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gZXJyb3JzWzBdOwogICAgICAgICAgICBpZiAobWVzc2FnZSAmJiB0eXBlb2YgbWVzc2FnZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9IG1lc3NhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gRG8gbm90IHByb2Nlc3MgZXJyb3IgaWYgd2UgZG8gbm90IGhhdmUgYSBtYXRjaGluZyBkcmFmdCBvbiBzdGF0ZQogICAgICAgIHZhciBzdGF0ZURyYWZ0ID0gc3RhdGUuZHJhZnRzW21ldGEuZHJhZnQuaWRdOwogICAgICAgIGlmICghc3RhdGVEcmFmdCB8fCAhc3RhdGVEcmFmdC5kYXRhKSB7CiAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICB9CiAgICAgICAgLy8gRGVzZWxlY3Qgc2VsZWN0ZWQgdGhyZWFkIGlmIG1hdGNoCiAgICAgICAgdmFyIHNlbGVjdGVkVGhyZWFkSWQgPSBzdGF0ZS5zZWxlY3RlZFRocmVhZCAmJiBzdGF0ZS5zZWxlY3RlZFRocmVhZC5pZDsKICAgICAgICB2YXIgb3B0aW1pc3RpY0tleSA9ICI8IiArIG1ldGEuZHJhZnQuaWQgKyAiQHBvbHltYWlsLmlvPiI7CiAgICAgICAgdmFyIHRocmVhZElkTWF0Y2hlcyA9ICFtZXRhLmRyYWZ0LnRocmVhZFYyICYmIG9wdGltaXN0aWNLZXkgPT09IHNlbGVjdGVkVGhyZWFkSWQ7CiAgICAgICAgcmV0dXJuIHVwZGF0ZShzdGF0ZSwgewogICAgICAgICAgICBkcmFmdHM6IChfYSA9IHt9LAogICAgICAgICAgICAgICAgX2FbbWV0YS5kcmFmdC5pZF0gPSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNldDogZXJyb3JNZXNzYWdlLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgX2EpLAogICAgICAgICAgICBzZWxlY3RlZFRocmVhZDogewogICAgICAgICAgICAgICAgJHNldDogdGhyZWFkSWRNYXRjaGVzID8gdW5kZWZpbmVkIDogc3RhdGUuc2VsZWN0ZWRUaHJlYWQsCiAgICAgICAgICAgIH0sCiAgICAgICAgfSk7CiAgICB9LAp9KSwgX2YudHlwZSksIGRyYWZ0U2VuZCA9IF9mLmFjdGlvbiwgZHJhZnRTZW5kUmVkdWNlciA9IF9mLnJlZHVjZXI7CmV4cG9ydCB2YXIgRFJBRlRfU0VORF9OT1cgPSAoX2cgPSBjcmVhdGUoJ0RSQUZUX1NFTkRfTk9XJywgewogICAgc3VjY2VzczogZnVuY3Rpb24gKHN0YXRlLCBtZXRhLCBwYXlsb2FkKSB7CiAgICAgICAgdmFyIF9hOwogICAgICAgIHJldHVybiB1cGRhdGUoc3RhdGUsIHsKICAgICAgICAgICAgZHJhZnRzOiAoX2EgPSB7fSwKICAgICAgICAgICAgICAgIF9hW3BheWxvYWQuaWRdID0gewogICAgICAgICAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICAgICAgICAgICAgJHNldDogcGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIF9hKSwKICAgICAgICB9KTsKICAgIH0sCn0pLCBfZy50eXBlKSwgZHJhZnRTZW5kTm93ID0gX2cuYWN0aW9uLCBkcmFmdFNlbmROb3dSZWR1Y2VyID0gX2cucmVkdWNlcjsKLy8gU2V0cyBkcmFmdCBiYWNrIHRvIHBheWxvYWQgb24gc3VjY2Vzcy4gUmVzZXQgc2VsZWN0aW9ucyB3aGVuIG5lY2Vzc2FyeQpleHBvcnQgdmFyIERSQUZUX1NFTkRfVU5ETyA9IChfaCA9IGNyZWF0ZSgnRFJBRlRfU0VORF9VTkRPJywgewogICAgc3RhcnQ6IGZ1bmN0aW9uIChzdGF0ZSwgbWV0YSkgewogICAgICAgIHJldHVybiB1cGRhdGUoc3RhdGUsIHsKICAgICAgICAgICAgc2VsZWN0ZWRJZHM6IHsgJHNldDogbmV3IE1hcCgpIH0sCiAgICAgICAgfSk7CiAgICB9LAogICAgc3VjY2VzczogZnVuY3Rpb24gKHN0YXRlLCBtZXRhLCBwYXlsb2FkKSB7CiAgICAgICAgdmFyIF9hLCBfYjsKICAgICAgICB2YXIgb3B0aW1pc3RpY0tleSA9ICI8IiArIG1ldGEuaWQgKyAiQHBvbHltYWlsLmlvPiI7CiAgICAgICAgdmFyIG9wdGltaXN0aWNUaHJlYWRJbmRleCA9ICFtZXRhLnRocmVhZFYyICYmIHN0YXRlLm1haWxib3hUaHJlYWRzLmRhdGEgJiYKICAgICAgICAgICAgZmluZEluZGV4KHN0YXRlLm1haWxib3hUaHJlYWRzLmRhdGEsIHsgaWQ6IG9wdGltaXN0aWNLZXkgfSk7CiAgICAgICAgdmFyIG9wdGltaXN0aWNVcGRhdGUgPSB0eXBlb2Ygb3B0aW1pc3RpY1RocmVhZEluZGV4ID09PSAnbnVtYmVyJyAmJgogICAgICAgICAgICBvcHRpbWlzdGljVGhyZWFkSW5kZXggPiAtMSAmJiB7CiAgICAgICAgICAgIG1haWxib3hUaHJlYWRzOiB7CiAgICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICAgICAgJHNwbGljZTogW1tvcHRpbWlzdGljVGhyZWFkSW5kZXgsIDFdXSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0sCiAgICAgICAgfSB8fCB7fTsKICAgICAgICB2YXIgb2xkTWVzc2FnZUJvZGllcyA9IG1ldGEudGhyZWFkVjIgJiYgc3RhdGUubWVzc2FnZUJvZGllc1ttZXRhLnRocmVhZFYyXSAmJgogICAgICAgICAgICBzdGF0ZS5tZXNzYWdlQm9kaWVzW21ldGEudGhyZWFkVjJdLmRhdGE7CiAgICAgICAgdmFyIG1lc3NhZ2VCb2R5VXBkYXRlID0gbWV0YS50aHJlYWRWMiAmJiBvbGRNZXNzYWdlQm9kaWVzICYmIHsKICAgICAgICAgICAgbWVzc2FnZUJvZGllczogKF9hID0ge30sCiAgICAgICAgICAgICAgICBfYVttZXRhLnRocmVhZFYyXSA9IHsKICAgICAgICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzZXQ6IG9sZE1lc3NhZ2VCb2RpZXMuZmlsdGVyKGZ1bmN0aW9uIChib2R5KSB7IHJldHVybiBib2R5LmlkICE9PSBvcHRpbWlzdGljS2V5OyB9KSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIF9hKSwKICAgICAgICB9IHx8IHt9OwogICAgICAgIHJldHVybiB1cGRhdGUoc3RhdGUsIF9fYXNzaWduKF9fYXNzaWduKHsgc2VsZWN0ZWREcmFmdDogeyAkc2V0OiAhcGF5bG9hZC50aHJlYWRWMiA/IHBheWxvYWQuaWQgOiBzdGF0ZS5zZWxlY3RlZERyYWZ0IH0sIHNlbGVjdGVkVGhyZWFkOiB7ICRzZXQ6ICFwYXlsb2FkLnRocmVhZFYyID8gdW5kZWZpbmVkIDogc3RhdGUuc2VsZWN0ZWRUaHJlYWQgfSwgZHJhZnRzOiAoX2IgPSB7fSwKICAgICAgICAgICAgICAgIF9iW21ldGEuaWRdID0gewogICAgICAgICAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICAgICAgICAgICAgJHNldDogcGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGluY3JlbWVudENvdW50OiB7ICRzZXQ6IDAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBfYiksIG1lc3NhZ2VCb2RpZXM6IHsKICAgICAgICAgICAgICAgICR1bnNldDogW29wdGltaXN0aWNLZXldLAogICAgICAgICAgICB9IH0sIG9wdGltaXN0aWNVcGRhdGUpLCBtZXNzYWdlQm9keVVwZGF0ZSkpOwogICAgfSwKfSksIF9oLnR5cGUpLCBkcmFmdFNlbmRVbmRvID0gX2guYWN0aW9uLCBkcmFmdFNlbmRVbmRvUmVkdWNlciA9IF9oLnJlZHVjZXI7Ci8vIFRPRE8oU0hJTik6IEZpZ3VyZSBvdXQgZXJyb3IgY2FzZXMgZm9yIG9wdGltaXN0aWMgcGF0Y2hlcwovLyBUT0RPKFNISU4pOiBGaXggdW5zZXQKZXhwb3J0IHZhciBEUkFGVF9ERUxFVEUgPSAoX2ogPSBjcmVhdGUoJ0RSQUZUX0RFTEVURScsIHsKICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChzdGF0ZSwgbWV0YSwgcGF5bG9hZCkgewogICAgICAgIHJldHVybiB1cGRhdGUoc3RhdGUsIHsKICAgICAgICAgICAgc2VsZWN0ZWREcmFmdDogewogICAgICAgICAgICAgICAgJHNldDogc3RhdGUuc2VsZWN0ZWREcmFmdCAmJiBzdGF0ZS5zZWxlY3RlZERyYWZ0ID09PSBwYXlsb2FkCiAgICAgICAgICAgICAgICAgICAgPyB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICA6IHN0YXRlLnNlbGVjdGVkRHJhZnQsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRyYWZ0czogewogICAgICAgICAgICAgICAgJHVuc2V0OiBbKHBheWxvYWQgJiYgcGF5bG9hZCkgfHwgbWV0YV0sCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGF0dGFjaG1lbnRNZXRhczogewogICAgICAgICAgICAgICAgJHVuc2V0OiBbbWV0YV0sCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8vIGZpeCBidWcgd2l0aCBjb250YWN0IHN1cHBvcnQgcmVvcGVuaW5nIHdoZW4gcmVwbHlpbmcgd2l0aCBob3RrZXkKICAgICAgICAgICAgLy8gaHR0cHM6Ly9wb2x5bWFpbC5hdGxhc3NpYW4ubmV0L2Jyb3dzZS9QTS0yNjQKICAgICAgICAgICAgY29udGFjdFN1cHBvcnRQb3B1cDogewogICAgICAgICAgICAgICAgY29sbGFwc2VkOiB7CiAgICAgICAgICAgICAgICAgICAgJHNldDogdHJ1ZSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0sCiAgICAgICAgfSk7CiAgICB9LAp9KSwgX2oudHlwZSksIGRyYWZ0RGVsZXRlID0gX2ouYWN0aW9uLCBkcmFmdERlbGV0ZVJlZHVjZXIgPSBfai5yZWR1Y2VyOwovLyBBcHBseSB0ZW1wbGF0ZQpleHBvcnQgdmFyIERSQUZUX1RFTVBMQVRFX0FQUExZID0gKF9rID0gY3JlYXRlKCdEUkFGVF9URU1QTEFURV9BUFBMWScsIHsKICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChzdGF0ZSwgbWV0YSwgcGF5bG9hZCkgewogICAgICAgIHJldHVybiBzdGF0ZTsKICAgIH0sCn0pLCBfay50eXBlKSwgZHJhZnRUZW1wbGF0ZUFwcGx5ID0gX2suYWN0aW9uLCBkcmFmdFRlbXBsYXRlQXBwbHlSZWR1Y2VyID0gX2sucmVkdWNlcjsKZXhwb3J0IHZhciBEUkFGVF9BVFRUQUNITUVOVFNfQVBQRU5EID0gKF9sID0gY3JlYXRlKCdEUkFGVF9BVFRBQ0hNRU5UU19BUFBFTkQnLCB7CiAgICBzdGFydDogZnVuY3Rpb24gKHN0YXRlLCBtZXRhKSB7CiAgICAgICAgdmFyIF9hLCBfYjsKICAgICAgICByZXR1cm4gdXBkYXRlKGNyZWF0ZU1ldGFOZXN0aW5nKHN0YXRlLCBtZXRhLnJlc291cmNlSWQpLCB7CiAgICAgICAgICAgIGF0dGFjaG1lbnRNZXRhczogKF9hID0ge30sCiAgICAgICAgICAgICAgICBfYVttZXRhLnJlc291cmNlSWRdID0gewogICAgICAgICAgICAgICAgICAgICRtZXJnZTogKF9iID0ge30sCiAgICAgICAgICAgICAgICAgICAgICAgIF9iW21ldGEuYXR0YWNobWVudF0gPSByZXNvdXJjZU9rKG1ldGEpLAogICAgICAgICAgICAgICAgICAgICAgICBfYiksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgX2EpLAogICAgICAgIH0pOwogICAgfSwKfSksIF9sLnR5cGUpLCBkcmFmdEF0dGFjaG1lbnRzQXBwZW5kID0gX2wuYWN0aW9uLCBkcmFmdEF0dGFjaG1lbnRzQXBwZW5kUmVkdWNlciA9IF9sLnJlZHVjZXI7CmV4cG9ydCB2YXIgRFJBRlRfQ0FMRU5EQVJfSU5WSVRFX0FERCA9IChfbSA9IGNyZWF0ZSgnRFJBRlRfQ0FMRU5EQVJfSU5WSVRFX0FERCcsIHsKICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChzdGF0ZSwgbWV0YSwgcGF5bG9hZCkgewogICAgICAgIHZhciBfYTsKICAgICAgICB2YXIgZHJhZnQgPSBzdGF0ZS5zZWxlY3RlZERyYWZ0IHx8CiAgICAgICAgICAgIChzdGF0ZS5zZWxlY3RlZFRocmVhZCAmJiBzZWxlY3REcmFmdEZvclRocmVhZChzdGF0ZSwgc3RhdGUuc2VsZWN0ZWRUaHJlYWQuaWQpLmRhdGEuaWQpOwogICAgICAgIGlmICghZHJhZnQpIHsKICAgICAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdXBkYXRlKHN0YXRlLCB7CiAgICAgICAgICAgIGRyYWZ0czogKF9hID0ge30sCiAgICAgICAgICAgICAgICBfYVtkcmFmdF0gPSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgICAgICAgICAkc2V0OiBfX2Fzc2lnbihfX2Fzc2lnbih7fSwgc3RhdGUuZHJhZnRzW2RyYWZ0XS5kYXRhKSwgeyBjYWxlbmRhckludml0ZTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IG1ldGEuZXZlbnQubmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogbWV0YS5zdGFydFRpbWUudG9EYXRlKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kOiBtZXRhLmVuZFRpbWUudG9EYXRlKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjaXBpZW50czogbWV0YS5ldmVudC5yZWNpcGllbnRzLm1hcChmdW5jdGlvbiAocikgeyByZXR1cm4gci5pZGVudGlmaWVyOyB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RlczogbWV0YS5ldmVudC5ub3RlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbjogbWV0YS5ldmVudC5sb2NhdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gfSksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBfYSksCiAgICAgICAgfSk7CiAgICB9LAp9KSwgX20udHlwZSksIGRyYWZ0Q2FsZW5kYXJJbnZpdGVBZGQgPSBfbS5hY3Rpb24sIGRyYWZ0Q2FsZW5kYXJJbnZpdGVBZGRSZWR1Y2VyID0gX20ucmVkdWNlcjsKZXhwb3J0IHZhciBEUkFGVF9BVFRBQ0hNRU5UX0FERCA9IChfbyA9IGNyZWF0ZSgnRFJBRlRfQVRUQUNITUVOVF9BREQnLCB7CiAgICBzdGFydDogZnVuY3Rpb24gKHN0YXRlLCBtZXRhKSB7CiAgICAgICAgdmFyIF9hLCBfYjsKICAgICAgICByZXR1cm4gdXBkYXRlKGNyZWF0ZU1ldGFOZXN0aW5nKHN0YXRlLCBtZXRhLnJlc291cmNlSWQpLCB7CiAgICAgICAgICAgIGF0dGFjaG1lbnRNZXRhczogKF9hID0ge30sIF9hW21ldGEucmVzb3VyY2VJZF0gPSB7ICRtZXJnZTogKF9iID0ge30sIF9iW21ldGEuYXR0YWNobWVudF0gPSByZXNvdXJjZU9rKG1ldGEpLCBfYikgfSwgX2EpLAogICAgICAgIH0pOwogICAgfSwKICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChzdGF0ZSwgbWV0YSwgcGF5bG9hZCkgewogICAgICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2U7CiAgICAgICAgLy8gSWRlbnRpZnkgd2hpY2ggYXR0YWNobWVudE1ldGFzIHRvIGNsZWFyLiBJZiBmb3J3YXJlZGVkIG1ldGFzLCByZW1vdmUgYWxsIG9uIHN1Y2Nlc3MKICAgICAgICB2YXIgdW5zZXRNZXRhcyA9IFttZXRhLmF0dGFjaG1lbnRdOwogICAgICAgIHZhciBhbGxNZXRhcyA9IHN0YXRlLmF0dGFjaG1lbnRNZXRhc1ttZXRhLnJlc291cmNlSWRdOwogICAgICAgIGlmIChtZXRhLnRocmVhZCkgewogICAgICAgICAgICB2YXIgYXBwZW5kTWV0YXMgPSBjb21wYWN0KHZhbHVlcyhhbGxNZXRhcykubWFwKGZ1bmN0aW9uIChtKSB7IHJldHVybiBtLmRhdGE7IH0pKQogICAgICAgICAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAobSkgeyByZXR1cm4gISFtLnRocmVhZDsgfSk7CiAgICAgICAgICAgIHVuc2V0TWV0YXMgPSBhcHBlbmRNZXRhcy5tYXAoZnVuY3Rpb24gKG0pIHsgcmV0dXJuIG0uYXR0YWNobWVudDsgfSk7CiAgICAgICAgfQogICAgICAgIC8vIEhhbmRsZSByZXBsYWNpbmcgYXR0YWNoZW1udCBpZiBhbHJlYWR5IGV4aXN0cwogICAgICAgIHZhciBkcmFmdCA9IHN0YXRlLmRyYWZ0c1ttZXRhLnJlc291cmNlSWRdICYmIHN0YXRlLmRyYWZ0c1ttZXRhLnJlc291cmNlSWRdLmRhdGE7CiAgICAgICAgdmFyIGF0dGFjaG1lbnRJbmRleCA9IGRyYWZ0ICYmIGRyYWZ0LmF0dGFjaG1lbnRzICYmCiAgICAgICAgICAgIGRyYWZ0LmF0dGFjaG1lbnRzLmZpbmRJbmRleChmdW5jdGlvbiAoYXR0YWNobWVudCkgeyByZXR1cm4gYXR0YWNobWVudC5pZCA9PT0gcGF5bG9hZC5pZDsgfSk7CiAgICAgICAgaWYgKGF0dGFjaG1lbnRJbmRleCAhPT0gdW5kZWZpbmVkICYmIGF0dGFjaG1lbnRJbmRleCA+IC0xKSB7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGUoY3JlYXRlTWV0YU5lc3Rpbmcoc3RhdGUsIG1ldGEucmVzb3VyY2VJZCksIHsKICAgICAgICAgICAgICAgIGRyYWZ0czogKF9hID0ge30sCiAgICAgICAgICAgICAgICAgICAgX2FbbWV0YS5yZXNvdXJjZUlkXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogeyBhdHRhY2htZW50czogKF9iID0ge30sIF9iW2F0dGFjaG1lbnRJbmRleF0gPSB7ICRzZXQ6IHBheWxvYWQgfSwgX2IpIH0sCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBfYSksCiAgICAgICAgICAgICAgICBhdHRhY2htZW50TWV0YXM6IChfYyA9IHt9LCBfY1ttZXRhLnJlc291cmNlSWRdID0geyAkdW5zZXQ6IHVuc2V0TWV0YXMgfSwgX2MpLAogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVwZGF0ZShjcmVhdGVNZXRhTmVzdGluZyhzdGF0ZSwgbWV0YS5yZXNvdXJjZUlkKSwgewogICAgICAgICAgICBkcmFmdHM6IChfZCA9IHt9LAogICAgICAgICAgICAgICAgX2RbbWV0YS5yZXNvdXJjZUlkXSA9IHsKICAgICAgICAgICAgICAgICAgICBkYXRhOiB7IGF0dGFjaG1lbnRzOiB7ICRwdXNoOiBbcGF5bG9hZF0gfSB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIF9kKSwKICAgICAgICAgICAgYXR0YWNobWVudE1ldGFzOiAoX2UgPSB7fSwgX2VbbWV0YS5yZXNvdXJjZUlkXSA9IHsgJHVuc2V0OiB1bnNldE1ldGFzIH0sIF9lKSwKICAgICAgICB9KTsKICAgIH0sCiAgICBmYWlsdXJlOiBmdW5jdGlvbiAoc3RhdGUsIG1ldGEsIGVycm9yKSB7CiAgICAgICAgdmFyIF9hLCBfYjsKICAgICAgICByZXR1cm4gdXBkYXRlKGNyZWF0ZU1ldGFOZXN0aW5nKHN0YXRlLCBtZXRhLnJlc291cmNlSWQpLCB7CiAgICAgICAgICAgIGF0dGFjaG1lbnRNZXRhczogKF9hID0ge30sCiAgICAgICAgICAgICAgICBfYVttZXRhLnJlc291cmNlSWRdID0gKF9iID0ge30sCiAgICAgICAgICAgICAgICAgICAgX2JbbWV0YS5hdHRhY2htZW50XSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgJHNldDogcmVzb3VyY2VGYWlsZWQoZXJyb3IsIG1ldGEpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgX2IpLAogICAgICAgICAgICAgICAgX2EpLAogICAgICAgIH0pOwogICAgfSwKfSksIF9vLnR5cGUpLCBkcmFmdEF0dGFjaG1lbnRBZGQgPSBfby5hY3Rpb24sIGRyYWZ0QXR0YWNobWVudEFkZFJlZHVjZXIgPSBfby5yZWR1Y2VyOwpleHBvcnQgdmFyIEFUVEFDSE1FTlRfTUVUQV9DUkVBVEUgPSAoX3AgPSBjcmVhdGUoJ0FUVEFDSE1FTlRfTUVUQV9DUkVBVEUnLCB7CiAgICBzdGFydDogZnVuY3Rpb24gKHN0YXRlLCBtZXRhKSB7CiAgICAgICAgdmFyIF9hLCBfYjsKICAgICAgICByZXR1cm4gdXBkYXRlKGNyZWF0ZU1ldGFOZXN0aW5nKHN0YXRlLCBtZXRhLnJlc291cmNlSWQpLCB7CiAgICAgICAgICAgIGF0dGFjaG1lbnRNZXRhczogKF9hID0ge30sIF9hW21ldGEucmVzb3VyY2VJZF0gPSB7ICRtZXJnZTogKF9iID0ge30sIF9iW21ldGEuYXR0YWNobWVudF0gPSByZXNvdXJjZU9rKG1ldGEpLCBfYikgfSwgX2EpLAogICAgICAgIH0pOwogICAgfSwKICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChzdGF0ZSwgbWV0YSwgZXJyKSB7CiAgICAgICAgdmFyIF9hLCBfYjsKICAgICAgICByZXR1cm4gdXBkYXRlKGNyZWF0ZU1ldGFOZXN0aW5nKHN0YXRlLCBtZXRhLnJlc291cmNlSWQpLCB7CiAgICAgICAgICAgIGF0dGFjaG1lbnRNZXRhczogKF9hID0ge30sCiAgICAgICAgICAgICAgICBfYVttZXRhLnJlc291cmNlSWRdID0geyAkbWVyZ2U6IChfYiA9IHt9LCBfYlttZXRhLmF0dGFjaG1lbnRdID0gcmVzb3VyY2VGYWlsZWQoZXJyLCBtZXRhKSwgX2IpIH0sCiAgICAgICAgICAgICAgICBfYSksCiAgICAgICAgfSk7CiAgICB9LAp9KSwgX3AudHlwZSksIGF0dGFjaG1lbnRNZXRhQ3JlYXRlID0gX3AuYWN0aW9uLCBhdHRhY2htZW50TWV0YUNyZWF0ZVJlZHVjZXIgPSBfcC5yZWR1Y2VyOwpleHBvcnQgdmFyIEFUVEFDSE1FTlRfTUVUQV9IWURSQVRFID0gKF9xID0gY3JlYXRlKCdBVFRBQ0hNRU5UX01FVEFfSFlEUkFURScsIHsKICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChzdGF0ZSwgbWV0YSwgcGF5bG9hZCkgewogICAgICAgIHZhciBfYSwgX2I7CiAgICAgICAgLy8gRG8gbm90IHVwZGF0ZSBpZiB3ZSBkbyBub3QgaGF2ZSBhIGNvcnJlc3BvbmRpbmcgbWV0YQogICAgICAgIGlmICghc3RhdGUuYXR0YWNobWVudE1ldGFzW3BheWxvYWQucmVzb3VyY2VJZF0gfHwKICAgICAgICAgICAgIXN0YXRlLmF0dGFjaG1lbnRNZXRhc1twYXlsb2FkLnJlc291cmNlSWRdW3BheWxvYWQuYXR0YWNobWVudF0pIHsKICAgICAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdXBkYXRlKGNyZWF0ZU1ldGFOZXN0aW5nKHN0YXRlLCBwYXlsb2FkLnJlc291cmNlSWQpLCB7CiAgICAgICAgICAgIGF0dGFjaG1lbnRNZXRhczogKF9hID0ge30sCiAgICAgICAgICAgICAgICBfYVtwYXlsb2FkLnJlc291cmNlSWRdID0geyAkbWVyZ2U6IChfYiA9IHt9LCBfYltwYXlsb2FkLmF0dGFjaG1lbnRdID0gcmVzb3VyY2VPayhtZXRhKSwgX2IpIH0sCiAgICAgICAgICAgICAgICBfYSksCiAgICAgICAgfSk7CiAgICB9LAp9KSwgX3EudHlwZSksIGF0dGFjaG1lbnRNZXRhSHlkcmF0ZSA9IF9xLmFjdGlvbiwgYXR0YWNobWVudE1ldGFIeWRyYXRlUmVkdWNlciA9IF9xLnJlZHVjZXI7CmV4cG9ydCB2YXIgQVRUQUNITUVOVF9NRVRBX1VQREFURSA9IChfciA9IGNyZWF0ZSgnQVRUQUNITUVOVF9NRVRBX1VQREFURScsIHsKICAgIHN0YXJ0OiBmdW5jdGlvbiAoc3RhdGUsIG1ldGEpIHsKICAgICAgICB2YXIgX2EsIF9iOwogICAgICAgIC8vIERvIG5vdCB1cGRhdGUgaWYgd2UgZG8gbm90IGhhdmUgYSBjb3JyZXNwb25kaW5nIG1ldGEKICAgICAgICBpZiAoIXN0YXRlLmF0dGFjaG1lbnRNZXRhc1ttZXRhLnJlc291cmNlSWRdIHx8CiAgICAgICAgICAgICFzdGF0ZS5hdHRhY2htZW50TWV0YXNbbWV0YS5yZXNvdXJjZUlkXVttZXRhLmF0dGFjaG1lbnRdKSB7CiAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVwZGF0ZShjcmVhdGVNZXRhTmVzdGluZyhzdGF0ZSwgbWV0YS5yZXNvdXJjZUlkKSwgewogICAgICAgICAgICBhdHRhY2htZW50TWV0YXM6IChfYSA9IHt9LCBfYVttZXRhLnJlc291cmNlSWRdID0geyAkbWVyZ2U6IChfYiA9IHt9LCBfYlttZXRhLmF0dGFjaG1lbnRdID0gcmVzb3VyY2VPayhtZXRhKSwgX2IpIH0sIF9hKSwKICAgICAgICB9KTsKICAgIH0sCn0pLCBfci50eXBlKSwgYXR0YWNobWVudE1ldGFVcGRhdGUgPSBfci5hY3Rpb24sIGF0dGFjaG1lbnRNZXRhVXBkYXRlUmVkdWNlciA9IF9yLnJlZHVjZXI7Ci8vIFRPRE8oU0hJTik6IENvbm5lY3QgdG8gQ29tbWl0U3luYz8KZXhwb3J0IHZhciBEUkFGVF9BVFRBQ0hNRU5UX1JFTU9WRSA9IChfcyA9IGNyZWF0ZSgnRFJBRlRfQVRUQUNITUVOVF9SRU1PVkUnLCB7CiAgICBzdWNjZXNzOiBmdW5jdGlvbiAoc3RhdGUsIG1ldGEsIHBheWxvYWQpIHsKICAgICAgICB2YXIgX2EsIF9iOwogICAgICAgIHZhciBkcmFmdCA9IHNlbGVjdERyYWZ0KHN0YXRlLCBtZXRhLnJlc291cmNlSWQpLmRhdGE7CiAgICAgICAgaWYgKCFkcmFmdCkgewogICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgfQogICAgICAgIC8vIEZpbHRlciBhdHRhY2htZW50cwogICAgICAgIHZhciBuZXdBdHRhY2htZW50cyA9IGRyYWZ0LmF0dGFjaG1lbnRzLmZpbHRlcihmdW5jdGlvbiAoYXR0YWNobWVudCkgeyByZXR1cm4gYXR0YWNobWVudC5pZCAhPT0gbWV0YS5hdHRhY2htZW50OyB9KTsKICAgICAgICByZXR1cm4gdXBkYXRlKGNyZWF0ZU1ldGFOZXN0aW5nKHN0YXRlLCBtZXRhLnJlc291cmNlSWQpLCB7CiAgICAgICAgICAgIGRyYWZ0czogKF9hID0ge30sCiAgICAgICAgICAgICAgICBfYVttZXRhLnJlc291cmNlSWRdID0gewogICAgICAgICAgICAgICAgICAgIGRhdGE6IHsgYXR0YWNobWVudHM6IHsgJHNldDogbmV3QXR0YWNobWVudHMgfSB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIF9hKSwKICAgICAgICAgICAgYXR0YWNobWVudE1ldGFzOiAoX2IgPSB7fSwgX2JbbWV0YS5yZXNvdXJjZUlkXSA9IHsgJHVuc2V0OiBbbWV0YS5hdHRhY2htZW50XSB9LCBfYiksCiAgICAgICAgfSk7CiAgICB9LAp9KSwgX3MudHlwZSksIGRyYWZ0QXR0YWNobWVudFJlbW92ZSA9IF9zLmFjdGlvbiwgZHJhZnRBdHRhY2htZW50UmVtb3ZlUmVkdWNlciA9IF9zLnJlZHVjZXI7CmV4cG9ydCB2YXIgRFJBRlRfQ09OVEFDVF9HUk9VUF9BREQgPSAnRFJBRlRfQ09OVEFDVF9HUk9VUF9BREQnOwpleHBvcnQgdmFyIGRyYWZ0Q29udGFjdEdyb3VwQWRkID0gY3JlYXRlQWN0aW9uKERSQUZUX0NPTlRBQ1RfR1JPVVBfQUREKTsKLy8gU2VsZWN0b3JzCnZhciBwZW5kaW5nUmVzb3VyY2UgPSByZXNvdXJjZVBlbmRpbmcoKTsKLy8gc2VsZWN0RHJhZnQgcmV0dXJucyBhIGRyYWZ0IHJlc291cmNlIGJ5IGlkCmV4cG9ydCB2YXIgc2VsZWN0U2VsZWN0ZWREcmFmdCA9IGNyZWF0ZVNlbGVjdG9yKFtmdW5jdGlvbiAoc3RhdGUpIHsgcmV0dXJuIHN0YXRlLnNlbGVjdGVkRHJhZnQKICAgICAgICA/IHNlbGVjdERyYWZ0KHN0YXRlLCBzdGF0ZS5zZWxlY3RlZERyYWZ0KQogICAgICAgIDogc3RhdGUuc2VsZWN0ZWRUaHJlYWQgJiYgc2VsZWN0RHJhZnRGb3JUaHJlYWQoc3RhdGUsIHN0YXRlLnNlbGVjdGVkVGhyZWFkLmlkKTsgfSwKXSwgZnVuY3Rpb24gKGRyYWZ0KSB7CiAgICBpZiAoZHJhZnQpIHsKICAgICAgICByZXR1cm4gZHJhZnQ7CiAgICB9CiAgICByZXR1cm4gcGVuZGluZ1Jlc291cmNlOwp9LCB1bmRlZmluZWQsIFsnc2VsZWN0ZWREcmFmdCcsICdzZWxlY3RlZFRocmVhZCddKTsKLy8gc2VsZWN0RHJhZnQgcmV0dXJucyBhIGRyYWZ0IHJlc291cmNlIGJ5IGlkCmV4cG9ydCB2YXIgc2VsZWN0RHJhZnQgPSBjcmVhdGVTZWxlY3RvcihbZnVuY3Rpb24gKHN0YXRlLCBkcmFmdCkgeyByZXR1cm4gc3RhdGUuZHJhZnRzW2RyYWZ0XTsgfV0sIGZ1bmN0aW9uIChkcmFmdCkgewogICAgaWYgKGRyYWZ0KSB7CiAgICAgICAgcmV0dXJuIGRyYWZ0OwogICAgfQogICAgcmV0dXJuIHBlbmRpbmdSZXNvdXJjZTsKfSk7Ci8vIHNlbGVjdERyYWZ0IHJldHVybnMgYSBkcmFmdCByZXNvdXJjZSBieSBpZAovLyBUT0RPKFNISU4pOiBGaWd1cmUgb3V0IGhhbmRsaW5nIGZvciBzY2hlZHVsZWQgZHJhZnQgc2VsZWN0aW9uIGZvciBVSQpleHBvcnQgdmFyIHNlbGVjdERyYWZ0Rm9yVGhyZWFkID0gY3JlYXRlU2VsZWN0b3IoW2Z1bmN0aW9uIChzdGF0ZSwgdGhyZWFkLCBzdGF0dXNlcykgeyByZXR1cm4gc3RhdGUuZHJhZnRzOyB9XSwgZnVuY3Rpb24gKGRyYWZ0cywgdGhyZWFkLCBzdGF0dXNlcykgewogICAgdmFyIGRyYWZ0SWQgPSBsYXN0KE9iamVjdC5rZXlzKGRyYWZ0cykuZmlsdGVyKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgZHJhZnQgPSBkcmFmdHNba2V5XTsKICAgICAgICBpZiAoIShkcmFmdCAmJiBkcmFmdC5kYXRhKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmIChkcmFmdC5kYXRhLnRocmVhZFYyICE9PSB0aHJlYWQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoc3RhdHVzZXMpIHsKICAgICAgICAgICAgcmV0dXJuIHN0YXR1c2VzLmluZGV4T2YoZHJhZnQuZGF0YS5zdGF0dXMpID49IDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiAoZHJhZnQuZGF0YS5zdGF0dXMgPT09IERyYWZ0U3RhdHVzLkRyYWZ0IHx8IGRyYWZ0LmRhdGEuc3RhdHVzID09PSBEcmFmdFN0YXR1cy5TY2hlZHVsZWQKICAgICAgICAgICAgfHwgZHJhZnQuZGF0YS5zdGF0dXMgPT09IERyYWZ0U3RhdHVzLkZhaWxlZCk7CiAgICB9KSkgfHwgJyc7CiAgICB2YXIgZHJhZnRSZXNvdXJjZSA9IGRyYWZ0c1tkcmFmdElkXTsKICAgIHJldHVybiAoZHJhZnRSZXNvdXJjZSAmJiBkcmFmdFJlc291cmNlKSB8fCBwZW5kaW5nUmVzb3VyY2U7Cn0sIGZ1bmN0aW9uIChkcmFmdHMsIHRocmVhZCwgc3RhdHVzZXMpIHsKICAgIHJldHVybiBmbnYxYTMyKHRocmVhZCArIChzdGF0dXNlcyB8fCBbXSkuam9pbigpKTsKfSk7CnZhciBlbXB0eU1ldGFzID0gW107Ci8vIFJldHVybnMgeW91IGFsbCBhdHRhY2htZW50IG1ldGFzIGZvciBhIGRyYWZ0CmV4cG9ydCB2YXIgc2VsZWN0QXR0YWNobWVudE1ldGFzRm9yUmVzb3VyY2UgPSBjcmVhdGVTZWxlY3RvcihbZnVuY3Rpb24gKHN0YXRlLCByZXNvdXJjZUlkKSB7IHJldHVybiBzdGF0ZS5hdHRhY2htZW50TWV0YXNbcmVzb3VyY2VJZF07IH1dLCBmdW5jdGlvbiAobWV0YXMsIHJlc291cmNlSWQpIHsKICAgIHJldHVybiBtZXRhcyAmJiB2YWx1ZXMobWV0YXMpIHx8IGVtcHR5TWV0YXM7Cn0sIHVuZGVmaW5lZCwgWydhdHRhY2htZW50TWV0YXMnXSk7Ci8vIHNlbGVjdERyYWZ0cyBoYXMgYWxsIGRyYWZ0cyB0aGF0IGFyZSBzdGF0dXMgZHJhZnQgb3IgZmFpbGVkCmV4cG9ydCB2YXIgc2VsZWN0U2VuZGluZ0RyYWZ0cyA9IGNyZWF0ZVNlbGVjdG9yKFtmdW5jdGlvbiAoc3RhdGUpIHsgcmV0dXJuIHN0YXRlLmRyYWZ0czsgfV0sIGZ1bmN0aW9uIChkcmFmdHMpIHsKICAgIHJldHVybiBvcmRlckJ5KGZpbHRlcihkcmFmdHMsIGZ1bmN0aW9uIChyZXNvdXJjZSkgewogICAgICAgIHJldHVybiByZXNvdXJjZS5zdGF0dXMgPT09IFJlc291cmNlU3RhdHVzLk9rICYmCiAgICAgICAgICAgIHJlc291cmNlLmRhdGEgJiYgaXNEcmFmdFNlbmRpbmcocmVzb3VyY2UuZGF0YSkgfHwgZmFsc2U7CiAgICB9KS5tYXAoZnVuY3Rpb24gKHJlc291cmNlKSB7IHJldHVybiByZXNvdXJjZS5kYXRhOyB9KSwgWydjYW5jZWxCeSddLCBbJ2FzYyddKTsKfSwgdW5kZWZpbmVkLCBbJ2RyYWZ0cyddKTsKLy8gc2VsZWN0RHJhZnRzIGhhcyBhbGwgZHJhZnRzIHRoYXQgYXJlIHN0YXR1cyBkcmFmdCBvciBmYWlsZWQKZXhwb3J0IHZhciBzZWxlY3REcmFmdHMgPSBjcmVhdGVTZWxlY3RvcihbZnVuY3Rpb24gKHN0YXRlKSB7IHJldHVybiBzdGF0ZS5kcmFmdHM7IH1dLCBmdW5jdGlvbiAoZHJhZnRzKSB7CiAgICByZXR1cm4gb3JkZXJCeShmaWx0ZXIoZHJhZnRzLCBmdW5jdGlvbiAocmVzb3VyY2UpIHsKICAgICAgICByZXR1cm4gcmVzb3VyY2Uuc3RhdHVzID09PSBSZXNvdXJjZVN0YXR1cy5PayAmJgogICAgICAgICAgICAocmVzb3VyY2UuZGF0YS5zdGF0dXMgPT09IERyYWZ0U3RhdHVzLkRyYWZ0IHx8CiAgICAgICAgICAgICAgICByZXNvdXJjZS5kYXRhLnN0YXR1cyA9PT0gRHJhZnRTdGF0dXMuRmFpbGVkKTsKICAgIH0pLm1hcChmdW5jdGlvbiAocmVzb3VyY2UpIHsgcmV0dXJuIHJlc291cmNlLmRhdGE7IH0pLCBbJ3VwZGF0ZWQnXSwgWydkZXNjJ10pOwp9KTsKLy8gc2VsZWN0U2VuZExhdGVyIHNlbGVjdHMgYWxsIGRyYWZ0cyB0aGF0IGhhdmUgYmVlbiBzY2hlZHVsZWQKZXhwb3J0IHZhciBzZWxlY3RTZW5kTGF0ZXJEcmFmdHMgPSBjcmVhdGVTZWxlY3RvcihbZnVuY3Rpb24gKHN0YXRlKSB7IHJldHVybiBzdGF0ZS5kcmFmdHM7IH1dLCBmdW5jdGlvbiAoZHJhZnRzKSB7CiAgICByZXR1cm4gb3JkZXJCeShmaWx0ZXIoZHJhZnRzLCBmdW5jdGlvbiAocmVzb3VyY2UpIHsKICAgICAgICByZXR1cm4gcmVzb3VyY2Uuc3RhdHVzID09PSBSZXNvdXJjZVN0YXR1cy5PayAmJiByZXNvdXJjZS5kYXRhLnN0YXR1cyA9PT0gRHJhZnRTdGF0dXMuU2NoZWR1bGVkOwogICAgfSkubWFwKGZ1bmN0aW9uIChyZXNvdXJjZSkgeyByZXR1cm4gcmVzb3VyY2UuZGF0YTsgfSksIFsnc2NoZWR1bGVkJ10sIFsnYXNjJ10pOwp9KTsKLy8gc2VsZWN0T3V0Ym94RHJhZnRzIHNlbGVjdHMgYWxsIGRyYWZ0cyB0aGF0IGFyZSBzZW5kaW5nL3N0YWdlZC9mYWlsZWQKZXhwb3J0IHZhciBzZWxlY3RPdXRib3hEcmFmdHMgPSBjcmVhdGVTZWxlY3RvcihbZnVuY3Rpb24gKHN0YXRlKSB7IHJldHVybiBzdGF0ZS5kcmFmdHM7IH1dLCBmdW5jdGlvbiAoZHJhZnRzKSB7CiAgICByZXR1cm4gb3JkZXJCeShmaWx0ZXIoZHJhZnRzLCBmdW5jdGlvbiAocmVzb3VyY2UpIHsKICAgICAgICByZXR1cm4gcmVzb3VyY2Uuc3RhdHVzID09PSBSZXNvdXJjZVN0YXR1cy5PayAmJiByZXNvdXJjZS5kYXRhICYmCiAgICAgICAgICAgIGlzRHJhZnRPdXRib3gocmVzb3VyY2UuZGF0YSkgfHwgZmFsc2U7CiAgICB9KS5tYXAoZnVuY3Rpb24gKHJlc291cmNlKSB7IHJldHVybiByZXNvdXJjZS5kYXRhOyB9KSwgWyd1cGRhdGVkJ10sIFsnZGVzYyddKTsKfSk7Ci8vIHNlbGVjdE91dGJveERyYWZ0cyBzZWxlY3RzIGFsbCBkcmFmdHMgdGhhdCBhcmUgc2VuZGluZy9zdGFnZWQvZmFpbGVkCmV4cG9ydCB2YXIgc2VsZWN0RmFpbGVkRHJhZnRzID0gY3JlYXRlU2VsZWN0b3IoW2Z1bmN0aW9uIChzdGF0ZSkgeyByZXR1cm4gc3RhdGUuZHJhZnRzOyB9XSwgZnVuY3Rpb24gKGRyYWZ0cykgewogICAgcmV0dXJuIG9yZGVyQnkoZmlsdGVyKGRyYWZ0cywgZnVuY3Rpb24gKHJlc291cmNlKSB7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLnN0YXR1cyA9PT0gUmVzb3VyY2VTdGF0dXMuT2sgJiYgcmVzb3VyY2UuZGF0YSAmJgogICAgICAgICAgICAocmVzb3VyY2UuZGF0YS5zdGF0dXMgPT09IERyYWZ0U3RhdHVzLkZhaWxlZCB8fCAhIXJlc291cmNlLmRhdGEuZXJyb3IpCiAgICAgICAgICAgIHx8IGZhbHNlOwogICAgfSkubWFwKGZ1bmN0aW9uIChyZXNvdXJjZSkgeyByZXR1cm4gcmVzb3VyY2UuZGF0YTsgfSksIFsndXBkYXRlZCddLCBbJ2Rlc2MnXSk7Cn0pOwovLyBzZWxlY3REZWJ1Z0RyYWZ0cyBzZWxlY3RzIGFsbCBkcmFmdHMgdGhhdCBhcmUgbm90IHN0YXR1cyBEcmFmdFN0YXR1cy5EcmFmdApleHBvcnQgdmFyIHNlbGVjdERlYnVnRHJhZnRzID0gY3JlYXRlU2VsZWN0b3IoW2Z1bmN0aW9uIChzdGF0ZSkgeyByZXR1cm4gc3RhdGUuZHJhZnRzOyB9XSwgZnVuY3Rpb24gKGRyYWZ0cykgewogICAgcmV0dXJuIG9yZGVyQnkoZmlsdGVyKGRyYWZ0cywgZnVuY3Rpb24gKHJlc291cmNlKSB7CiAgICAgICAgdmFyIF9hOwogICAgICAgIHJldHVybiByZXNvdXJjZS5zdGF0dXMgPT09IFJlc291cmNlU3RhdHVzLk9rICYmIHJlc291cmNlLmRhdGEgJiYKICAgICAgICAgICAgKChfYSA9IHJlc291cmNlLmRhdGEpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zdGF0dXMpICE9PSBEcmFmdFN0YXR1cy5EcmFmdCB8fCBmYWxzZTsKICAgIH0pLm1hcChmdW5jdGlvbiAocmVzb3VyY2UpIHsgcmV0dXJuIHJlc291cmNlLmRhdGE7IH0pLCBbJ3VwZGF0ZWQnXSwgWydkZXNjJ10pOwp9KTsKLy8gUmV0dXJucyBkcmFmdCBmb3Igb3B0aW1pc3RpYyB0aHJlYWQgaWYgZXhpc3RzCmV4cG9ydCB2YXIgc2VsZWN0RHJhZnRGb3JPcHRpbWlzdGljVGhyZWFkID0gY3JlYXRlU2VsZWN0b3IoW2Z1bmN0aW9uIChzdGF0ZSwgdGhyZWFkKSB7IHJldHVybiBzdGF0ZS5kcmFmdHM7IH1dLCBmdW5jdGlvbiAoZHJhZnRSZXNvdXJjZXMsIHRocmVhZCkgewogICAgaWYgKCF0aHJlYWQuc3RhcnRzV2l0aCgnPCcpKSB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICAgIHJldHVybiBjb21wYWN0KHZhbHVlcyhkcmFmdFJlc291cmNlcykubWFwKGZ1bmN0aW9uIChkcmFmdCkgeyByZXR1cm4gZHJhZnQuZGF0YTsgfSkpCiAgICAgICAgLmZpbmQoZnVuY3Rpb24gKGRyYWZ0KSB7IHJldHVybiAiPCIgKyBkcmFmdC5pZCArICJAcG9seW1haWwuaW8+IiA9PT0gdGhyZWFkOyB9KTsKfSwgZnVuY3Rpb24gKGRyYWZ0cywgdGhyZWFkKSB7CiAgICByZXR1cm4gZm52MWEzMih0aHJlYWQpOwp9LCBbJ2RyYWZ0cyddKTsKLy8gc2VsZWN0RHJhZnQgcmV0dXJucyBhIGRyYWZ0IHJlc291cmNlIGJ5IGlkCmV4cG9ydCB2YXIgc2VsZWN0T3B0aW1pc3RpY01lc3NhZ2VzRm9yVGhyZWFkID0gY3JlYXRlU2VsZWN0b3IoW2Z1bmN0aW9uIChzdGF0ZSwgdGhyZWFkKSB7IHJldHVybiBzdGF0ZS5kcmFmdHM7IH0sIGZ1bmN0aW9uIChzdGF0ZSwgdGhyZWFkKSB7IHJldHVybiBzdGF0ZS5hY2NvdW50czsgfV0sIGZ1bmN0aW9uIChkcmFmdFJlc291cmNlcywgYWNjb3VudHMsIHRocmVhZCkgewogICAgdmFyIG1lc3NhZ2VzID0gW107CiAgICBmb3JJbihkcmFmdFJlc291cmNlcywgZnVuY3Rpb24gKGRyYWZ0LCBrZXkpIHsKICAgICAgICBpZiAoZHJhZnQgJiYKICAgICAgICAgICAgZHJhZnQuZGF0YSAmJgogICAgICAgICAgICAoZHJhZnQuZGF0YS50aHJlYWRWMiA9PT0gdGhyZWFkIHx8IHRocmVhZCA9PT0gIjwiICsgZHJhZnQuZGF0YS5pZCArICJAcG9seW1haWwuaW8+IikgJiYKICAgICAgICAgICAgaXNEcmFmdFNlbmRpbmcoZHJhZnQuZGF0YSkpIHsKICAgICAgICAgICAgbWVzc2FnZXMucHVzaCh0b01lc3NhZ2UoZHJhZnQuZGF0YSwgYWNjb3VudHMpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgfSk7CiAgICByZXR1cm4gbWVzc2FnZXM7Cn0sIGZ1bmN0aW9uIChkcmFmdHMsIGFjY291bnRzLCB0aHJlYWQpIHsKICAgIHJldHVybiBmbnYxYTMyKHRocmVhZCk7Cn0sIFsnZHJhZnRzJ10pOwovLyBzZWxlY3REcmFmdCByZXR1cm5zIGEgZHJhZnQgcmVzb3VyY2UgYnkgaWQKZXhwb3J0IHZhciBzZWxlY3RPcHRpbWlzdGljTWVzc2FnZUJvZGllc0ZvclRocmVhZCA9IGNyZWF0ZVNlbGVjdG9yKFtmdW5jdGlvbiAoc3RhdGUsIHRocmVhZCkgeyByZXR1cm4gc3RhdGUuZHJhZnRzOyB9XSwgZnVuY3Rpb24gKGRyYWZ0UmVzb3VyY2VzLCB0aHJlYWQpIHsKICAgIHZhciBib2RpZXMgPSBbXTsKICAgIGZvckluKGRyYWZ0UmVzb3VyY2VzLCBmdW5jdGlvbiAoZHJhZnQsIGtleSkgewogICAgICAgIGlmIChkcmFmdCAmJgogICAgICAgICAgICBkcmFmdC5kYXRhICYmCiAgICAgICAgICAgIChkcmFmdC5kYXRhLnRocmVhZFYyID09PSB0aHJlYWQgfHwgdGhyZWFkID09PSAiPCIgKyBkcmFmdC5kYXRhLmlkICsgIkBwb2x5bWFpbC5pbz4iKSAmJgogICAgICAgICAgICBpc0RyYWZ0U2VuZGluZyhkcmFmdC5kYXRhKSkgewogICAgICAgICAgICBib2RpZXMucHVzaCh0b01lc3NhZ2VCb2R5KGRyYWZ0LmRhdGEsIHRocmVhZCkpOwogICAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGJvZGllczsKfSwgZnVuY3Rpb24gKGRyYWZ0cywgdGhyZWFkKSB7IHJldHVybiBmbnYxYTMyKHRocmVhZCk7IH0sIFsnZHJhZnRzJ10pOwpleHBvcnQgZGVmYXVsdCBbCiAgICBkcmFmdFVwZGF0ZVJlZHVjZXIsCiAgICBkcmFmdENyZWF0ZVJlZHVjZXIsCiAgICBkcmFmdFNlbmRSZWR1Y2VyLAogICAgZHJhZnRTZW5kVW5kb1JlZHVjZXIsCiAgICBkcmFmdERlbGV0ZVJlZHVjZXIsCiAgICBkcmFmdEF0dGFjaG1lbnRBZGRSZWR1Y2VyLAogICAgZHJhZnRBdHRhY2htZW50UmVtb3ZlUmVkdWNlciwKICAgIGRyYWZ0U2VsZWN0UmVkdWNlciwKICAgIGRyYWZ0RmV0Y2hSZWR1Y2VyLAogICAgZHJhZnRMaXN0UmVkdWNlciwKICAgIGRyYWZ0VGVtcGxhdGVBcHBseVJlZHVjZXIsCiAgICBkcmFmdEF0dGFjaG1lbnRzQXBwZW5kUmVkdWNlciwKICAgIGRyYWZ0Q2FsZW5kYXJJbnZpdGVBZGRSZWR1Y2VyLAogICAgYXR0YWNobWVudE1ldGFVcGRhdGVSZWR1Y2VyLAogICAgYXR0YWNobWVudE1ldGFDcmVhdGVSZWR1Y2VyLAogICAgYXR0YWNobWVudE1ldGFIeWRyYXRlUmVkdWNlciwKICAgIGRyYWZ0U2VuZE5vd1JlZHVjZXIsCl07Cg=="},{"version":3,"file":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/src/ducks/drafts.ts","sourceRoot":"","sources":["/Users/andrewsamboy/Desktop/Git/polymail/webapp/src/ducks/drafts.ts"],"names":[],"mappings":"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","sourcesContent":["import { createSelector } from '@src/lib/selector';\nimport { orderBy, keyBy, filter, forIn, last, values, compact, findIndex, uniqBy } from 'lodash';\nimport update from 'immutability-helper';\n\nimport { create, createAction } from '@src/lib/redux';\nimport {\n  toMessage, toMessageBody,\n  Configuration, toThread,\n  isDraftSending, isDraftOutbox,\n} from '@src/lib/draft';\n\nimport { resourcePending, resourceOk, resourceFailed } from '@src/lib/resource';\nimport {\n  Resource,\n  ResourceStatus,\n  Draft,\n  DraftStatus,\n  StoreState,\n  AttachmentMeta,\n  Attachment,\n  Message,\n  MessageBody,\n  Account,\n  Template,\n  TimeBlock,\n} from '@src/types';\nimport { fnv1a32 } from '@src/lib/crypt';\n\nfunction createNesting(state: StoreState, draft: string): StoreState {\n  if (state.drafts[draft]) {\n    return state;\n  }\n\n  return update(state, {\n    drafts: {\n      [draft]: {\n        $set: resourcePending(),\n      },\n    },\n  });\n}\n\nfunction createMetaNesting(state: StoreState, draft: string): StoreState {\n  if (state.attachmentMetas[draft]) {\n    return state;\n  }\n\n  return update(state, {\n    attachmentMetas: {\n      [draft]: {\n        $set: {},\n      },\n    },\n  });\n}\n\nexport const {\n  type: DRAFT_SELECT,\n  action: draftSelect,\n  reducer: draftSelectReducer,\n} = create<\n  string,\n  string | null\n>('DRAFT_SELECT', {\n  success: (state, meta, payload) =>\n    update(state, {\n      selectedDraft: { $set: payload === null ? undefined : payload },\n    }),\n});\n\nexport const {\n  type: DRAFT_FETCH,\n  action: draftFetch,\n  reducer: draftFetchReducer,\n} = create<\n  string,\n  Draft\n>('DRAFT_FETCH', {\n  start: (state, meta) =>\n    !(state.drafts[meta] && state.drafts[meta].data)\n      ? update(createNesting(state, meta), {\n        drafts: {\n          [meta]: {\n            status: {\n              $set: ResourceStatus.Loading,\n            },\n          },\n        },\n      })\n      : state,\n\n  success: (state, meta, payload) =>\n    update(createNesting(state, meta), {\n      drafts: {\n        [meta]: {\n          status: {\n            $set: ResourceStatus.Ok,\n          },\n          data: {\n            $set: payload,\n          },\n        },\n      },\n    }),\n\n  failure: (state, meta, error) =>\n    update(createNesting(state, meta), {\n      drafts: {\n        [meta]: {\n          status: {\n            $set: ResourceStatus.Failure,\n          },\n          error: {\n            $set: error,\n          },\n        },\n      },\n    }),\n});\n\nexport const {\n  type: DRAFT_LIST,\n  action: draftList,\n  reducer: draftListReducer,\n} = create<\n  string,\n  Draft[]\n>('DRAFT_LIST', {\n  success: (state, meta, payload) => {\n    // handle no drafts found\n    if (payload.length === 0) {\n      return state;\n    }\n\n    // make updates object\n    const updates = payload.map(draft => ({\n      $set: {\n        status: ResourceStatus.Ok,\n        data: draft,\n      },\n    }));\n\n    // update state\n    return update(state, {\n      drafts: keyBy(updates, eachUpdate => eachUpdate.$set.data.id),\n    });\n  },\n});\n\n// TODO(SHIN): Figure out error cases for optimistic patches\n// TODO(SHIN): Create separate action/epic for updating draft with\n// template that takes care of attachments\nexport const {\n  type: DRAFT_UPDATE,\n  action: draftUpdate,\n  reducer: draftUpdateReducer,\n} = create<\n  Draft,\n  Draft\n>('DRAFT_UPDATE', {\n  start: (state, meta) =>\n    update(createNesting(state, meta.id), {\n      drafts: {\n        [meta.id]: {\n          data: {\n            $set: meta,\n          },\n        },\n      },\n    }),\n  success: (state, meta, payload) => {\n    // Handle special case for regeneration\n    const selectedThread = state.selectedThread;\n    const optimisticKey = `<${payload.id}@polymail.io>`;\n    const threadMatches = selectedThread &&\n      [optimisticKey, payload.threadV2].indexOf(selectedThread.id) > -1;\n    const shouldUpdate = threadMatches && isDraftSending(payload) && payload.attachments.length;\n    if (shouldUpdate && selectedThread) {\n      const optimistic = toMessage(payload, state.accounts);\n      const updatedMessages = uniqBy([optimistic].concat(selectedThread.messages), 'rfcId');\n      return update(createNesting(state, meta.id), {\n        drafts: {\n          [meta.id]: {\n            data: { $set: payload },\n            status: { $set: ResourceStatus.Ok },\n          },\n        },\n        selectedThread: {\n          messages: { $set: updatedMessages },\n        },\n      });\n    }\n\n    return update(createNesting(state, meta.id), {\n      drafts: {\n        [meta.id]: {\n          data: { $set: payload },\n          status: { $set: ResourceStatus.Ok },\n        },\n      },\n    });\n  },\n});\n\n// HACK(SHIN): Immediately deselects thread & ids on new-draft creation to prevent intermediate\n// state where a reply/no message selection shows up.\nexport const {\n  type: DRAFT_CREATE,\n  action: draftCreate,\n  reducer: draftCreateReducer,\n} = create<\n  Draft,\n  Draft\n>('DRAFT_CREATE', {\n  start: (state, meta) => {\n    return update(state, {\n      drafts: {\n        $merge: { [meta.id]: resourceOk(meta) },\n      },\n      selectedDraft: { $set: meta.id },\n      selectedThread: { $set: !!meta.threadV2 ? state.selectedThread : undefined },\n      selectedIds: { $set: !!meta.threadV2 ? state.selectedIds : new Map() },\n    });\n  },\n});\n\nexport interface DraftConfigurationMeta {\n  configuration: Configuration;\n  body?: MessageBody;\n  recipients?: string[];\n}\n\nexport const DRAFT_CREATE_CONFIGURATION = 'DRAFT_CREATE_CONFIGURATION';\nexport const draftCreateConfiguration = createAction<\n  DraftConfigurationMeta | Configuration,\n  undefined\n>(DRAFT_CREATE_CONFIGURATION);\n\n// Broadcast actions used to route success cases through workers\nexport const DRAFT_SEND_BROADCAST = 'DRAFT_SEND_BROADCAST';\nexport const draftSendBroadcast = createAction<DraftSendMeta, null>(DRAFT_SEND_BROADCAST);\n\nexport const DRAFT_UPDATE_BROADCAST = 'DRAFT_UPDATE_BROADCAST';\nexport const draftUpdateBroadcast = createAction<Draft, null>(DRAFT_UPDATE_BROADCAST);\n\nexport interface DraftSendMeta {\n  draft: Draft;\n  toggleArchive: boolean;\n  scheduled?: Date;\n  delay?: number;\n  version?: number;\n}\n\nexport interface DraftSendOptimisticMeta {\n  meta: DraftSendMeta;\n  deletedAttachments: AttachmentMeta[];\n}\n\n// TODO(SHIN): Figure out error cases for optimistic patches\n// TODO(SHIN): Update selectedDraft to be cleared on location change for thread\nexport const {\n  type: DRAFT_SEND,\n  action: draftSend,\n  reducer: draftSendReducer,\n} = create<\n  DraftSendMeta,\n  Draft\n>('DRAFT_SEND', {\n  start: (state, meta) => {\n    return update(state, {\n      drafts: {\n        [meta.draft.id]: {\n          incrementCount: {\n            $set: 0,\n          },\n        },\n      },\n    });\n  },\n  success: (state, meta, payload) => {\n    const isScheduled = payload.status === DraftStatus.Scheduled;\n    // HACK(SHIN): We always insert optimistic thread into mailboxThreads since the optimistic\n    // thread needs to be queryable via state selector & since it gets filtered out of DataSource\n    const insertOptimistic = state.mailboxThreads.data && !meta.draft.threadV2 && !isScheduled;\n    const updateMailboxThread = insertOptimistic && {\n      mailboxThreads: {\n        data: {\n          $push: [toThread(meta.draft, state.accounts)],\n        },\n      },\n    } || {};\n\n    let toggleArchiveCount = 0;\n    if (meta.toggleArchive) {\n      toggleArchiveCount = toggleArchiveCount + 1;\n    }\n    if (state.preferences.sendAndArchive) {\n      toggleArchiveCount = toggleArchiveCount + 1;\n    }\n    const shouldArchive = toggleArchiveCount % 2 !== 0;\n    // const optimisticKey = `<${payload.id}@polymail.io>`;\n    const newDraftMatches = !payload.threadV2 &&\n      payload.id === state.selectedDraft;\n\n    const draftResource = state.drafts[meta.draft.id];\n    const incrementCount = draftResource && draftResource.incrementCount || 0;\n\n    return update(state, {\n      drafts: {\n        [meta.draft.id]: {\n          data: {\n            $set: payload,\n          },\n          incrementCount: {\n            $set: incrementCount + 1,\n          },\n        },\n      },\n      selectedThread: {\n        $set:\n          newDraftMatches && !isScheduled && !state.selectedThread && !shouldArchive\n            ? toThread(payload, state.accounts)\n            : state.selectedThread,\n      },\n      ...updateMailboxThread,\n    });\n  },\n  failure: (state, meta, error) => {\n    // Handle error setting\n    let errorMessage = error.message;\n    const errorsObject = (error as any).errors;\n    const errors = errorsObject && values(errorsObject);\n    if (errors && !!errors.length) {\n      const message = errors[0];\n      if (message && typeof message === 'string')  {\n        errorMessage = message;\n      }\n    }\n\n    // Do not process error if we do not have a matching draft on state\n    const stateDraft = state.drafts[meta.draft.id];\n    if (!stateDraft || !stateDraft.data) {\n      return state;\n    }\n\n    // Deselect selected thread if match\n    const selectedThreadId = state.selectedThread && state.selectedThread.id;\n    const optimisticKey = `<${meta.draft.id}@polymail.io>`;\n    const threadIdMatches = !meta.draft.threadV2 && optimisticKey === selectedThreadId;\n\n    return update(state, {\n      drafts: {\n        [meta.draft.id]: {\n          data: {\n            error: {\n              $set: errorMessage,\n            },\n          },\n        },\n      },\n      selectedThread: {\n        $set: threadIdMatches ? undefined : state.selectedThread,\n      },\n    });\n  },\n});\n\nexport const {\n  type: DRAFT_SEND_NOW,\n  action: draftSendNow,\n  reducer: draftSendNowReducer,\n} = create<Draft, Draft>('DRAFT_SEND_NOW', {\n  success: (state, meta, payload) => update(state, {\n    drafts: {\n      [payload.id]: {\n        data: {\n          $set: payload,\n        },\n      },\n    },\n  }),\n});\n\n// Sets draft back to payload on success. Reset selections when necessary\nexport const {\n  type: DRAFT_SEND_UNDO,\n  action: draftSendUndo,\n  reducer: draftSendUndoReducer,\n} = create<Draft, Draft>('DRAFT_SEND_UNDO', {\n  start: (state, meta) => {\n    return update(state, {\n      selectedIds: { $set: new Map() },\n    });\n  },\n  success: (state, meta, payload) => {\n    const optimisticKey = `<${meta.id}@polymail.io>`;\n    const optimisticThreadIndex = !meta.threadV2 && state.mailboxThreads.data &&\n      findIndex(state.mailboxThreads.data, { id: optimisticKey });\n    const optimisticUpdate = typeof optimisticThreadIndex === 'number' &&\n      optimisticThreadIndex > -1 && {\n        mailboxThreads: {\n          data: {\n            $splice: [[optimisticThreadIndex, 1]],\n          },\n        },\n      } || {};\n    const oldMessageBodies = meta.threadV2 && state.messageBodies[meta.threadV2] &&\n      state.messageBodies[meta.threadV2].data;\n    const messageBodyUpdate = meta.threadV2 && oldMessageBodies && {\n      messageBodies: {\n        [meta.threadV2]: {\n          data: {\n            $set: oldMessageBodies.filter(body => body.id !== optimisticKey),\n          },\n        },\n      },\n    } || {};\n\n    return update(state, {\n      selectedDraft: { $set: !payload.threadV2 ? payload.id : state.selectedDraft },\n      selectedThread: { $set: !payload.threadV2 ? undefined : state.selectedThread },\n      drafts: {\n        [meta.id]: {\n          data: {\n            $set: payload,\n          },\n          incrementCount: { $set: 0 },\n        },\n      },\n      messageBodies: {\n        $unset: [optimisticKey],\n      },\n      ...optimisticUpdate,\n      ...messageBodyUpdate,\n    });\n  },\n});\n\n// TODO(SHIN): Figure out error cases for optimistic patches\n// TODO(SHIN): Fix unset\nexport const {\n  type: DRAFT_DELETE,\n  action: draftDelete,\n  reducer: draftDeleteReducer,\n} = create<string, string>('DRAFT_DELETE', {\n  success: (state, meta, payload) => {\n    return update(state, {\n      selectedDraft: {\n        $set: state.selectedDraft && state.selectedDraft === payload\n          ? undefined\n          : state.selectedDraft,\n      },\n      drafts: {\n        $unset: [(payload && payload) || meta],\n      },\n      attachmentMetas: {\n        $unset: [meta],\n      },\n      // fix bug with contact support reopening when replying with hotkey\n      // https://polymail.atlassian.net/browse/PM-264\n      contactSupportPopup: {\n        collapsed: {\n          $set: true,\n        },\n      },\n    });\n  },\n});\n\n// Apply template\nexport const {\n  type: DRAFT_TEMPLATE_APPLY,\n  action: draftTemplateApply,\n  reducer: draftTemplateApplyReducer,\n} = create<Template, Draft>('DRAFT_TEMPLATE_APPLY', {\n  success: (state, meta, payload) => {\n    return state;\n  },\n});\n\nexport const {\n  type: DRAFT_ATTTACHMENTS_APPEND,\n  action: draftAttachmentsAppend,\n  reducer: draftAttachmentsAppendReducer,\n} = create<AttachmentMeta, AttachmentMeta>('DRAFT_ATTACHMENTS_APPEND', {\n  start: (state, meta) => {\n    return update(createMetaNesting(state, meta.resourceId), {\n      attachmentMetas: {\n        [meta.resourceId]: {\n          $merge: {\n            [meta.attachment]: resourceOk(meta),\n          },\n        },\n      },\n    });\n  },\n});\n\nexport const {\n  type: DRAFT_CALENDAR_INVITE_ADD,\n  action: draftCalendarInviteAdd,\n  reducer: draftCalendarInviteAddReducer,\n} = create<TimeBlock, TimeBlock>('DRAFT_CALENDAR_INVITE_ADD', {\n  success: (state, meta, payload) => {\n    const draft =\n      state.selectedDraft ||\n      (state.selectedThread && selectDraftForThread(state, state.selectedThread.id).data.id);\n\n    if (!draft) {\n      return state;\n    }\n\n    return update(state, {\n      drafts: {\n        [draft]: {\n          data: {\n            $set: {\n              ...state.drafts[draft].data,\n              calendarInvite: {\n                name: meta.event.name,\n                start: meta.startTime.toDate(),\n                end: meta.endTime.toDate(),\n                recipients: meta.event.recipients.map(r => r.identifier),\n                notes: meta.event.notes,\n                location: meta.event.location,\n              },\n            },\n          },\n        },\n      },\n    });\n  },\n});\n\nexport const {\n  type: DRAFT_ATTACHMENT_ADD,\n  action: draftAttachmentAdd,\n  reducer: draftAttachmentAddReducer,\n} = create<AttachmentMeta, Attachment>('DRAFT_ATTACHMENT_ADD', {\n  start: (state, meta) => {\n    return update(createMetaNesting(state, meta.resourceId), {\n      attachmentMetas: { [meta.resourceId]: { $merge: { [meta.attachment]: resourceOk(meta) } } },\n    });\n  },\n  success: (state, meta, payload) => {\n\n    // Identify which attachmentMetas to clear. If forwareded metas, remove all on success\n    let unsetMetas = [meta.attachment];\n    const allMetas = state.attachmentMetas[meta.resourceId];\n    if (meta.thread) {\n      const appendMetas = compact(values(allMetas).map(m => m.data))\n        .filter(m => !!m.thread);\n      unsetMetas = appendMetas.map(m => m.attachment);\n    }\n\n    // Handle replacing attachemnt if already exists\n    const draft = state.drafts[meta.resourceId] && state.drafts[meta.resourceId].data;\n    const attachmentIndex = draft && draft.attachments &&\n      draft.attachments.findIndex(attachment => attachment.id === payload.id);\n    if (attachmentIndex !== undefined && attachmentIndex > -1) {\n      return update(createMetaNesting(state, meta.resourceId), {\n        drafts: {\n          [meta.resourceId]: {\n            data: { attachments: { [attachmentIndex]: { $set: payload } } },\n          },\n        },\n        attachmentMetas: { [meta.resourceId]: { $unset: unsetMetas } },\n      });\n    }\n\n    return update(createMetaNesting(state, meta.resourceId), {\n      drafts: {\n        [meta.resourceId]: {\n          data: { attachments: { $push: [payload] } },\n        },\n      },\n      attachmentMetas: { [meta.resourceId]: { $unset: unsetMetas } },\n    });\n  },\n  failure: (state, meta, error) => {\n    return update(createMetaNesting(state, meta.resourceId), {\n      attachmentMetas: {\n        [meta.resourceId]: {\n          [meta.attachment]: {\n            $set: resourceFailed(error, meta),\n          },\n        },\n      },\n    });\n  },\n});\n\nexport const {\n  type: ATTACHMENT_META_CREATE,\n  action: attachmentMetaCreate,\n  reducer: attachmentMetaCreateReducer,\n} = create<AttachmentMeta, AttachmentMeta>('ATTACHMENT_META_CREATE', {\n  start: (state, meta) => {\n    return update(createMetaNesting(state, meta.resourceId), {\n      attachmentMetas: { [meta.resourceId]: { $merge: { [meta.attachment]: resourceOk(meta) } } },\n    });\n  },\n  failure: (state, meta, err) => {\n    return update(createMetaNesting(state, meta.resourceId), {\n      attachmentMetas: {\n        [meta.resourceId]: { $merge: { [meta.attachment]: resourceFailed(err, meta) } },\n      },\n    });\n  },\n});\n\nexport const {\n  type: ATTACHMENT_META_HYDRATE,\n  action: attachmentMetaHydrate,\n  reducer: attachmentMetaHydrateReducer,\n} = create<AttachmentMeta, AttachmentMeta>('ATTACHMENT_META_HYDRATE', {\n  success: (state, meta, payload) => {\n    // Do not update if we do not have a corresponding meta\n    if (!state.attachmentMetas[payload.resourceId] ||\n      !state.attachmentMetas[payload.resourceId][payload.attachment]\n    ) {\n      return state;\n    }\n\n    return update(createMetaNesting(state, payload.resourceId), {\n      attachmentMetas: {\n        [payload.resourceId]: { $merge: { [payload.attachment]: resourceOk(meta) } },\n      },\n    });\n  },\n});\n\nexport const {\n  type: ATTACHMENT_META_UPDATE,\n  action: attachmentMetaUpdate,\n  reducer: attachmentMetaUpdateReducer,\n} = create<AttachmentMeta, AttachmentMeta>('ATTACHMENT_META_UPDATE', {\n  start: (state, meta) => {\n    // Do not update if we do not have a corresponding meta\n    if (!state.attachmentMetas[meta.resourceId] ||\n      !state.attachmentMetas[meta.resourceId][meta.attachment]\n    ) {\n      return state;\n    }\n\n    return update(createMetaNesting(state, meta.resourceId), {\n      attachmentMetas: { [meta.resourceId]: { $merge: { [meta.attachment]: resourceOk(meta) } } },\n    });\n  },\n});\n\n// TODO(SHIN): Connect to CommitSync?\nexport const {\n  type: DRAFT_ATTACHMENT_REMOVE,\n  action: draftAttachmentRemove,\n  reducer: draftAttachmentRemoveReducer,\n} = create<AttachmentMeta, null>('DRAFT_ATTACHMENT_REMOVE', {\n  success: (state, meta, payload) => {\n    const draft = selectDraft(state, meta.resourceId).data;\n    if (!draft) {\n      return state;\n    }\n\n    // Filter attachments\n    const newAttachments = draft.attachments.filter(\n      (attachment: Attachment) => attachment.id !== meta.attachment,\n    );\n\n    return update(createMetaNesting(state, meta.resourceId), {\n      drafts: {\n        [meta.resourceId]: {\n          data: { attachments: { $set: newAttachments } },\n        },\n      },\n      attachmentMetas: { [meta.resourceId]: { $unset: [meta.attachment] } },\n    });\n  },\n});\n\nexport interface DraftContactGroupMeta {\n  draft: Draft;\n  list: string;\n  contactGroup: string;\n}\n\nexport const DRAFT_CONTACT_GROUP_ADD = 'DRAFT_CONTACT_GROUP_ADD';\nexport const draftContactGroupAdd = createAction<DraftContactGroupMeta, undefined>(\n  DRAFT_CONTACT_GROUP_ADD,\n);\n\n// Selectors\nconst pendingResource = resourcePending<Draft>();\n\n// selectDraft returns a draft resource by id\nexport const selectSelectedDraft = createSelector<\n  undefined,\n  Resource<Draft> | undefined,\n  Resource<Draft>\n>(\n  [state => state.selectedDraft\n      ? selectDraft(state, state.selectedDraft)\n      : state.selectedThread && selectDraftForThread(state, state.selectedThread.id),\n  ],\n  (draft: Resource<Draft>) => {\n    if (draft) {\n      return draft;\n    }\n    return pendingResource;\n  },\n  undefined,\n  ['selectedDraft', 'selectedThread'],\n);\n\n// selectDraft returns a draft resource by id\nexport const selectDraft = createSelector<string, Resource<Draft> | undefined, Resource<Draft>>(\n  [(state, draft) => state.drafts[draft]],\n  (draft: Resource<Draft>) => {\n    if (draft) {\n      return draft;\n    }\n    return pendingResource;\n  },\n);\n\n// selectDraft returns a draft resource by id\n// TODO(SHIN): Figure out handling for scheduled draft selection for UI\nexport const selectDraftForThread = createSelector<\n  string | DraftStatus[] | undefined,\n  { [id: string]: Resource<Draft> },\n  Resource<Draft>\n>(\n  [(state, thread, statuses?) => state.drafts],\n  (drafts: { [id: string]: Resource<Draft> }, thread: string, statuses?: DraftStatus[]) => {\n    const draftId =\n      last(\n        Object.keys(drafts).filter((key) => {\n          const draft = drafts[key];\n\n          if (!(draft && draft.data)) {\n            return false;\n          }\n          if (draft.data.threadV2 !== thread) {\n            return false;\n          }\n          if (statuses) {\n            return statuses.indexOf(draft.data.status) >= 0;\n          }\n\n          return (\n            draft.data.status === DraftStatus.Draft || draft.data.status === DraftStatus.Scheduled\n            || draft.data.status === DraftStatus.Failed\n          );\n        }),\n      ) || '';\n    const draftResource = drafts[draftId];\n\n    return (draftResource && draftResource) || pendingResource;\n  },\n  (drafts: { [id: string]: Resource<Draft> }, thread: string, statuses?: DraftStatus[]) => {\n    return fnv1a32(thread + (statuses || []).join());\n  },\n);\n\nconst emptyMetas: Array<Resource<AttachmentMeta>> = [];\n\n// Returns you all attachment metas for a draft\nexport const selectAttachmentMetasForResource = createSelector<\n  string,\n  { [id: string]: Resource<AttachmentMeta> } | undefined,\n  Array<Resource<AttachmentMeta>>\n>(\n  [(state, resourceId) => state.attachmentMetas[resourceId]],\n  (metas: { [id: string]: Resource<AttachmentMeta> }, resourceId: string) => {\n    return metas && values(metas) || emptyMetas;\n  },\n  undefined,\n  ['attachmentMetas'],\n);\n\n// selectDrafts has all drafts that are status draft or failed\nexport const selectSendingDrafts = createSelector<\n  undefined,\n  { [id: string]: Resource<Draft> },\n  Draft[]\n>(\n  [state => state.drafts],\n  (drafts: { [id: string]: Resource<Draft> }) =>\n    orderBy(\n      filter(\n        drafts,\n        resource =>\n          resource.status === ResourceStatus.Ok &&\n          resource.data && isDraftSending(resource.data) || false,\n      ).map(resource => resource.data!),\n      ['cancelBy'],\n      ['asc'],\n  ),\n  undefined,\n  ['drafts'],\n);\n\n// selectDrafts has all drafts that are status draft or failed\nexport const selectDrafts = createSelector<undefined, { [id: string]: Resource<Draft> }, Draft[]>(\n  [state => state.drafts],\n  (drafts: { [id: string]: Resource<Draft> }) =>\n    orderBy(\n      filter(\n        drafts,\n        resource =>\n          resource.status === ResourceStatus.Ok &&\n          (resource.data!.status === DraftStatus.Draft ||\n            resource.data!.status === DraftStatus.Failed),\n      ).map(resource => resource.data!),\n      ['updated'],\n      ['desc'],\n    ),\n);\n\n// selectSendLater selects all drafts that have been scheduled\nexport const selectSendLaterDrafts = createSelector<\n  undefined,\n  { [id: string]: Resource<Draft> },\n  Draft[]\n>([state => state.drafts], (drafts: { [id: string]: Resource<Draft> }) =>\n  orderBy(\n    filter(\n      drafts,\n      resource =>\n        resource.status === ResourceStatus.Ok && resource.data!.status === DraftStatus.Scheduled,\n    ).map(resource => resource.data!),\n    ['scheduled'],\n    ['asc'],\n  ),\n);\n\n// selectOutboxDrafts selects all drafts that are sending/staged/failed\nexport const selectOutboxDrafts = createSelector<\n  undefined,\n  { [id: string]: Resource<Draft> },\n  Draft[]\n>([state => state.drafts], (drafts: { [id: string]: Resource<Draft> }) =>\n  orderBy(\n    filter(\n      drafts,\n      resource =>\n        resource.status === ResourceStatus.Ok && resource.data &&\n          isDraftOutbox(resource.data) || false,\n    ).map(resource => resource.data!),\n    ['updated'],\n    ['desc'],\n  ),\n);\n\n// selectOutboxDrafts selects all drafts that are sending/staged/failed\nexport const selectFailedDrafts = createSelector<\n  undefined,\n  { [id: string]: Resource<Draft> },\n  Draft[]\n>([state => state.drafts], (drafts: { [id: string]: Resource<Draft> }) =>\n  orderBy(\n    filter(\n      drafts,\n      resource =>\n        resource.status === ResourceStatus.Ok && resource.data &&\n          (resource.data.status === DraftStatus.Failed || !!resource.data.error)\n          || false,\n    ).map(resource => resource.data!),\n    ['updated'],\n    ['desc'],\n  ),\n);\n\n// selectDebugDrafts selects all drafts that are not status DraftStatus.Draft\nexport const selectDebugDrafts = createSelector<\n  undefined,\n  { [id: string]: Resource<Draft> },\n  Draft[]\n>([state => state.drafts], (drafts: { [id: string]: Resource<Draft> }) =>\n  orderBy(\n    filter(\n      drafts,\n      resource =>\n        resource.status === ResourceStatus.Ok && resource.data &&\n        resource.data?.status !== DraftStatus.Draft || false,\n    ).map(resource => resource.data!),\n    ['updated'],\n    ['desc'],\n  ),\n);\n// Returns draft for optimistic thread if exists\nexport const selectDraftForOptimisticThread = createSelector<\n  string,\n  { [id: string]: Resource<Draft> },\n  Draft|undefined>(\n    [(state, thread) => state.drafts],\n    (draftResources: { [id: string]: Resource<Draft> }, thread: string) => {\n      if (!thread.startsWith('<')) {\n        return undefined;\n      }\n\n      return compact(values(draftResources).map(draft => draft.data))\n        .find(draft => `<${draft.id}@polymail.io>` === thread);\n    },\n    (drafts: { [id: string]: Resource<Draft> }, thread: string) =>\n      fnv1a32(thread),\n    ['drafts'],\n);\n\n// selectDraft returns a draft resource by id\nexport const selectOptimisticMessagesForThread = createSelector<\n  string,\n  { [id: string]: Resource<Draft> } | Account[],\n  Message[]\n>(\n  [(state, thread) => state.drafts, (state, thread) => state.accounts],\n  (draftResources: { [id: string]: Resource<Draft> }, accounts: Account[], thread: string) => {\n    const messages: Message[] = [];\n    forIn(draftResources, (draft, key) => {\n      if (\n        draft &&\n        draft.data &&\n        (draft.data.threadV2 === thread || thread === `<${draft.data.id}@polymail.io>`) &&\n        isDraftSending(draft.data)\n      ) {\n        messages.push(toMessage(draft.data, accounts));\n      }\n      return;\n    });\n    return messages;\n  },\n  (drafts: { [id: string]: Resource<Draft> }, accounts: Account[], thread: string) =>\n    fnv1a32(thread),\n  ['drafts'],\n);\n\n// selectDraft returns a draft resource by id\nexport const selectOptimisticMessageBodiesForThread = createSelector<\n  string,\n  { [id: string]: Resource<Draft> },\n  MessageBody[]\n>(\n  [(state, thread) => state.drafts],\n  (draftResources: { [id: string]: Resource<Draft> }, thread: string) => {\n    const bodies: MessageBody[] = [];\n    forIn(draftResources, (draft, key) => {\n      if (\n        draft &&\n        draft.data &&\n        (draft.data.threadV2 === thread || thread === `<${draft.data.id}@polymail.io>`) &&\n        isDraftSending(draft.data)\n      ) {\n        bodies.push(toMessageBody(draft.data, thread));\n      }\n    });\n    return bodies;\n  },\n  (drafts: { [id: string]: Resource<Draft> }, thread: string) => fnv1a32(thread),\n  ['drafts'],\n);\n\nexport default [\n  draftUpdateReducer,\n  draftCreateReducer,\n  draftSendReducer,\n  draftSendUndoReducer,\n  draftDeleteReducer,\n  draftAttachmentAddReducer,\n  draftAttachmentRemoveReducer,\n  draftSelectReducer,\n  draftFetchReducer,\n  draftListReducer,\n  draftTemplateApplyReducer,\n  draftAttachmentsAppendReducer,\n  draftCalendarInviteAddReducer,\n  attachmentMetaUpdateReducer,\n  attachmentMetaCreateReducer,\n  attachmentMetaHydrateReducer,\n  draftSendNowReducer,\n];\n"]}]}