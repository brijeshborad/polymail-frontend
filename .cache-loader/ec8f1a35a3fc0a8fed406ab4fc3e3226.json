{"remainingRequest":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/node_modules/ts-loader/index.js??ref--6-1!/Users/andrewsamboy/Desktop/Git/polymail/webapp/src/worker/Backoff.ts","dependencies":[{"path":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/src/worker/Backoff.ts","mtime":1675280254122},{"path":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/node_modules/cache-loader/dist/cjs.js","mtime":1675365393858},{"path":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/node_modules/ts-loader/index.js","mtime":1675365391714}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnOwovLyBCYWNrb2ZmIGhhbmRsZXMgbWFpbnRhaW5pbmcgZXJyb3Igc3RhdGVzIGFuZCBiYWNrb2ZmIGNhbGN1bGF0aW9ucwp2YXIgQmFja29mZiA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIEJhY2tvZmYoY29udGV4dCwgbWF4KSB7CiAgICAgICAgaWYgKG1heCA9PT0gdm9pZCAwKSB7IG1heCA9IDMwMDsgfQogICAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgdGhpcy5lcnJvciA9ICcnOwogICAgICAgIHRoaXMubnVtRXJyb3JzID0gMDsKICAgICAgICB0aGlzLm1heFNlY3MgPSBtYXg7CiAgICAgICAgdGhpcy5taW5TZWNzID0gMDsKICAgICAgICByZXR1cm47CiAgICB9CiAgICAvLyBzZXRFcnJvciBzZXRzIHRoZSBlcnJvciwgaW5jcmVtZW50cyBjb3VudGVycyBhbmQgY2FsY3VsYXRlcyBiYWNrb2ZmCiAgICBCYWNrb2ZmLnByb3RvdHlwZS5zZXRFcnJvciA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgLy8gU2V0IGVycm9yIGFuZCBlcnJvciBjb3VudGVycwogICAgICAgIHRoaXMuZXJyb3IgPSBlICYmIGUubWVzc2FnZSA/IGUubWVzc2FnZSA6ICdVbmtub3duIEVycm9yJzsKICAgICAgICB0aGlzLm51bUVycm9ycyArPSAxOwogICAgICAgIC8vIExvZyBFcnJvcgogICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlCiAgICAgICAgY29uc29sZS5lcnJvcih0aGlzLmVycm9yKTsKICAgICAgICAvLyBDYWxjdWxhdGUgYmFja29mZiBkdXJhdGlvbgogICAgICAgIHZhciBkdXJhdGlvbiA9IE1hdGgubWF4KAogICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZQogICAgICAgIE1hdGgucmFuZG9tKCkgKiBNYXRoLm1pbih0aGlzLm1heFNlY3MsIE1hdGgucG93KDIsIHRoaXMubnVtRXJyb3JzICsgKHRoaXMubWluUG93ZXIgfHwgMCkpKSwgdGhpcy5taW5TZWNzKTsKICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7CiAgICAgICAgZGF0ZS5zZXRTZWNvbmRzKGRhdGUuZ2V0U2Vjb25kcygpICsgZHVyYXRpb24pOwogICAgICAgIC8vIFNldCBiYWNrb2ZmIGRhdGUKICAgICAgICB0aGlzLnVudGlsID0gZGF0ZTsKICAgICAgICByZXR1cm47CiAgICB9OwogICAgLy8gY2xlYXJFcnJvcnMgY2xlYXJzIGVycm9yIG1lc3NhZ2UsIGNvdW50ZXJzIGFuZCBiYWNrb2ZmLgogICAgQmFja29mZi5wcm90b3R5cGUuY2xlYXJFcnJvcnMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5lcnJvciA9ICcnOwogICAgICAgIHRoaXMubnVtRXJyb3JzID0gMDsKICAgICAgICB0aGlzLnVudGlsID0gdW5kZWZpbmVkOwogICAgfTsKICAgIC8vIGlzUmVhZHkgcmV0dXJucyB0cnVlIGlmIG5vdCBpbiBiYWNrb2ZmIG1vZGUuCiAgICBCYWNrb2ZmLnByb3RvdHlwZS5pc1JlYWR5ID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmICh0aGlzLnVudGlsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHZhciByZWFkeSA9IHRoaXMudW50aWwgJiYgbW9tZW50KHRoaXMudW50aWwpLmlzQmVmb3JlKG1vbWVudCgpKTsKICAgICAgICBpZiAoIXJlYWR5KSB7CiAgICAgICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZQogICAgICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmNvbnRleHQsICdpcyBiYWNraW5nIG9mZiB1bnRpbDonLCB0aGlzLnVudGlsLCAnbm93OicsIG5vdyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZWFkeTsKICAgIH07CiAgICByZXR1cm4gQmFja29mZjsKfSgpKTsKZXhwb3J0IHsgQmFja29mZiB9Owo="},{"version":3,"file":"/Users/andrewsamboy/Desktop/Git/polymail/webapp/src/worker/Backoff.ts","sourceRoot":"","sources":["/Users/andrewsamboy/Desktop/Git/polymail/webapp/src/worker/Backoff.ts"],"names":[],"mappings":"AAAA,OAAO,MAAM,MAAM,QAAQ,CAAC;AAE5B,oEAAoE;AACpE;IASE,iBAAa,OAAe,EAAE,GAAiB;QAAjB,oBAAA,EAAA,SAAiB;QAC7C,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,KAAK,GAAG,EAAE,CAAC;QAChB,IAAI,CAAC,SAAS,GAAG,CAAC,CAAC;QACnB,IAAI,CAAC,OAAO,GAAG,GAAG,CAAC;QACnB,IAAI,CAAC,OAAO,GAAG,CAAC,CAAC;QACjB,OAAO;IACT,CAAC;IAED,sEAAsE;IACtE,0BAAQ,GAAR,UAAS,CAAQ;QACf,+BAA+B;QAC/B,IAAI,CAAC,KAAK,GAAG,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,eAAe,CAAC;QAC1D,IAAI,CAAC,SAAS,IAAI,CAAC,CAAC;QAEpB,YAAY;QACZ,sCAAsC;QACtC,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAE1B,6BAA6B;QAC7B,IAAM,QAAQ,GAAG,IAAI,CAAC,GAAG;QACvB,2BAA2B;QAC3B,IAAI,CAAC,MAAM,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,SAAS,GAAG,CAAC,IAAI,CAAC,QAAQ,IAAI,CAAC,CAAC,CAAC,CAAC,EAC1F,IAAI,CAAC,OAAO,CACb,CAAC;QACF,IAAM,IAAI,GAAG,IAAI,IAAI,EAAE,CAAC;QACxB,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,UAAU,EAAE,GAAG,QAAQ,CAAC,CAAC;QAE9C,mBAAmB;QACnB,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;QAClB,OAAO;IACT,CAAC;IAED,0DAA0D;IAC1D,6BAAW,GAAX;QACE,IAAI,CAAC,KAAK,GAAG,EAAE,CAAC;QAChB,IAAI,CAAC,SAAS,GAAG,CAAC,CAAC;QACnB,IAAI,CAAC,KAAK,GAAG,SAAS,CAAC;IACzB,CAAC;IAED,+CAA+C;IAC/C,yBAAO,GAAP;QACE,IAAI,IAAI,CAAC,KAAK,KAAK,SAAS,EAAE;YAC5B,OAAO,IAAI,CAAC;SACb;QACD,IAAM,KAAK,GAAG,IAAI,CAAC,KAAK,IAAI,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC,CAAC;QAClE,IAAI,CAAC,KAAK,EAAE;YACV,IAAM,GAAG,GAAG,IAAI,IAAI,EAAE,CAAC;YACvB,sCAAsC;YACtC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,EAAE,uBAAuB,EAAE,IAAI,CAAC,KAAK,EAAE,MAAM,EAAE,GAAG,CAAC,CAAC;SAC7E;QACD,OAAO,KAAK,CAAC;IACf,CAAC;IACH,cAAC;AAAD,CAAC,AA9DD,IA8DC","sourcesContent":["import moment from 'moment';\n\n// Backoff handles maintaining error states and backoff calculations\nexport class Backoff {\n  context: string;\n  error: string;\n  numErrors: number;\n  until?: Date;\n  minSecs: number;\n  maxSecs: number;\n  minPower?: number;\n\n  constructor (context: string, max: number = 300) {\n    this.context = context;\n    this.error = '';\n    this.numErrors = 0;\n    this.maxSecs = max;\n    this.minSecs = 0;\n    return;\n  }\n\n  // setError sets the error, increments counters and calculates backoff\n  setError(e: Error) {\n    // Set error and error counters\n    this.error = e && e.message ? e.message : 'Unknown Error';\n    this.numErrors += 1;\n\n    // Log Error\n    // tslint:disable-next-line:no-console\n    console.error(this.error);\n\n    // Calculate backoff duration\n    const duration = Math.max(\n      // tslint:disable-next-line\n      Math.random() * Math.min(this.maxSecs, Math.pow(2, this.numErrors + (this.minPower || 0))),\n      this.minSecs,\n    );\n    const date = new Date();\n    date.setSeconds(date.getSeconds() + duration);\n\n    // Set backoff date\n    this.until = date;\n    return;\n  }\n\n  // clearErrors clears error message, counters and backoff.\n  clearErrors() {\n    this.error = '';\n    this.numErrors = 0;\n    this.until = undefined;\n  }\n\n  // isReady returns true if not in backoff mode.\n  isReady(): boolean {\n    if (this.until === undefined) {\n      return true;\n    }\n    const ready = this.until && moment(this.until).isBefore(moment());\n    if (!ready) {\n      const now = new Date();\n      // tslint:disable-next-line:no-console\n      console.log(this.context, 'is backing off until:', this.until, 'now:', now);\n    }\n    return ready;\n  }\n}\n"]}]}